<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sun Tower RWA - Residents Welfare Association</title>
<meta name="description" content="Sun Tower Residents Welfare Association, Shipra Sun City, Indirapuram, Ghaziabad">
<link rel="stylesheet" href="css/style.css">
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
<script src="js/firebase-config.js"></script>
</head>
<body>

<!-- SPLASH SCREEN -->
<div class="splash" id="splashScreen">
  <div class="splash-logo">
    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="50" cy="22" r="14" fill="#fff3e0"/>
      <line x1="50" y1="2" x2="50" y2="8" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="50" y1="36" x2="50" y2="42" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="30" y1="22" x2="36" y2="22" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="64" y1="22" x2="70" y2="22" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="36" y1="8" x2="40" y2="12" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="60" y1="32" x2="64" y2="36" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="64" y1="8" x2="60" y2="12" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="40" y1="32" x2="36" y2="36" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <rect x="30" y="42" width="40" height="50" rx="3" fill="#fff" opacity="0.95"/>
      <rect x="35" y="48" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="47" y="48" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="59" y="48" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="35" y="60" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="47" y="60" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="59" y="60" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="35" y="72" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="47" y="72" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="59" y="72" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="44" y="82" width="12" height="12" rx="2" fill="#ff6f00"/>
    </svg>
  </div>
  <div class="splash-title" data-edit="splash_title">SUN TOWER</div>
  <div class="splash-subtitle" data-edit="splash_subtitle">Residents Welfare Association (SRWA)</div>
  <div class="splash-address" data-edit="splash_address">Block 'A2', Shipra Sun City, Indirapuram, Ghaziabad - 201014</div>
  <div class="splash-contact" data-edit="splash_contact">suntowershipra@gmail.com | 0120-4311286 | Ext: 5000</div>
  <div class="splash-buttons">
    <button class="splash-btn splash-btn-bom" onclick="enterBOM()" data-edit="splash_btn_bom">BOM Internal</button>
    <button class="splash-btn splash-btn-resident" onclick="enterResident()" data-edit="splash_btn_resident">Resident Portal</button>
  </div>
  <div class="splash-footer" data-edit="splash_footer">Board of Management 2025-26 | Election held 01 Feb 2026 | 174 Voters</div>
</div>

<!-- AUTH LOGIN -->
<div class="auth-overlay hidden" id="authOverlay">
  <div class="auth-card">
    <div class="auth-logo"><div style="display:inline-flex;width:60px;height:60px;background:linear-gradient(135deg,#ff6f00,#ff8f00);border-radius:14px;align-items:center;justify-content:center;"><svg viewBox="0 0 100 100" width="36" height="36" fill="none"><circle cx="50" cy="22" r="12" fill="#fff3e0"/><rect x="32" y="42" width="36" height="46" rx="3" fill="#fff" opacity="0.95"/><rect x="45" y="78" width="10" height="10" rx="2" fill="#ff6f00"/></svg></div></div>
    <div id="loginForm">
      <h2>BOM Login</h2>
      <p class="auth-sub">Authorized Access Only</p>
      <div class="auth-error" id="loginError"></div>
      <div class="auth-success" id="loginSuccess"></div>
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="loginEmail" placeholder="your.email@example.com"></div>
      <div class="form-group"><label>Password</label><input type="password" class="form-control" id="loginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')doLogin()"></div>
      <button class="btn btn-primary btn-lg" style="width:100%" onclick="doLogin()">Login</button>
      <div class="auth-link" onclick="showForgotPw()">Forgot Password?</div>
      <div class="auth-link" onclick="hideAuth()">Back to Home</div>
    </div>
    <div id="forgotForm" style="display:none">
      <h2>Reset Password</h2>
      <p class="auth-sub">Enter registered email for reset link</p>
      <div class="auth-error" id="forgotError"></div>
      <div class="auth-success" id="forgotSuccess"></div>
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="forgotEmail" placeholder="your.email@example.com"></div>
      <button class="btn btn-primary btn-lg" style="width:100%" onclick="doForgotPw()">Send Reset Link</button>
      <div class="auth-link" onclick="showLoginFm()">Back to Login</div>
    </div>
  </div>
</div>

<!-- RESIDENT AUTH OVERLAY -->
<div class="auth-overlay hidden" id="residentAuthOverlay">
  <div class="auth-card" style="max-width:460px">
    <div class="auth-logo"><div style="display:inline-flex;width:60px;height:60px;background:linear-gradient(135deg,#00695c,#00897b);border-radius:14px;align-items:center;justify-content:center;"><svg viewBox="0 0 100 100" width="36" height="36" fill="none"><circle cx="50" cy="22" r="12" fill="#fff3e0"/><rect x="32" y="42" width="36" height="46" rx="3" fill="#fff" opacity="0.95"/><rect x="45" y="78" width="10" height="10" rx="2" fill="#00695c"/></svg></div></div>

    <!-- Resident Login -->
    <div id="resLoginForm">
      <h2 style="color:#00695c">Resident Login</h2>
      <p class="auth-sub">Registered flat owners only</p>
      <div class="auth-error" id="resLoginError"></div>
      <div class="auth-success" id="resLoginSuccess"></div>
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="resLoginEmail" placeholder="your.email@example.com"></div>
      <div class="form-group"><label>Password</label><input type="password" class="form-control" id="resLoginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')doResidentLogin()"></div>
      <button class="btn btn-lg" style="width:100%;background:#00695c;color:#fff" onclick="doResidentLogin()">Login</button>
      <div class="auth-link" onclick="showResForgotPw()">Forgot Password?</div>
      <div style="text-align:center;margin-top:15px;padding-top:15px;border-top:1px solid #e0e0e0">
        <p style="color:#666;font-size:0.85rem;margin-bottom:10px">Not registered yet?</p>
        <button class="btn btn-secondary" style="width:100%" onclick="showResRegForm()">Request Registration</button>
      </div>
      <div class="auth-link" onclick="hideResidentAuth()">Back to Home</div>
    </div>

    <!-- Resident Registration Request -->
    <div id="resRegForm" style="display:none">
      <h2 style="color:#00695c">Request Registration</h2>
      <p class="auth-sub">Submit your details for admin verification</p>
      <div class="auth-error" id="resRegError"></div>
      <div class="auth-success" id="resRegSuccess"></div>
      <div class="form-group"><label>Flat Owner Name *</label><input type="text" class="form-control" id="regOwnerName" placeholder="e.g. Sh. Sunil Kumar"></div>
      <div class="form-group"><label>Flat Number *</label><input type="text" class="form-control" id="regFlatNo" placeholder="e.g. STC-504, STD-701"></div>
      <div class="form-group"><label>Mobile Number *</label><input type="tel" class="form-control" id="regMobile" placeholder="e.g. 9876543210"></div>
      <div class="form-group"><label>Email ID *</label><input type="email" class="form-control" id="regEmail" placeholder="your.email@example.com"></div>
      <button class="btn btn-lg" style="width:100%;background:#00695c;color:#fff" onclick="submitResidentReg()">Submit Registration Request</button>
      <div class="auth-link" onclick="showResLoginForm()">Already registered? Login</div>
      <div class="auth-link" onclick="hideResidentAuth()">Back to Home</div>
    </div>

    <!-- Resident Forgot Password (OTP) -->
    <div id="resForgotForm" style="display:none">
      <h2 style="color:#00695c">Reset Password</h2>
      <p class="auth-sub">OTP will be sent to your registered email</p>
      <div class="auth-error" id="resForgotError"></div>
      <div class="auth-success" id="resForgotSuccess"></div>
      <div id="resForgotStep1">
        <div class="form-group"><label>Registered Email</label><input type="email" class="form-control" id="resForgotEmail" placeholder="your.email@example.com"></div>
        <button class="btn btn-lg" style="width:100%;background:#00695c;color:#fff" onclick="sendResidentOTP()">Send OTP</button>
      </div>
      <div id="resForgotStep2" style="display:none">
        <div class="form-group"><label>Enter OTP (sent to email)</label><input type="text" class="form-control" id="resOtpInput" placeholder="6-digit OTP" maxlength="6" style="text-align:center;font-size:1.3rem;letter-spacing:8px"></div>
        <div class="form-group"><label>New Password (min 6 chars)</label><input type="password" class="form-control" id="resNewPass" placeholder="Enter new password"></div>
        <div class="form-group"><label>Confirm Password</label><input type="password" class="form-control" id="resConfirmPass" placeholder="Re-enter new password"></div>
        <button class="btn btn-lg" style="width:100%;background:#00695c;color:#fff" onclick="verifyOTPResetPass()">Verify OTP & Reset Password</button>
      </div>
      <div class="auth-link" onclick="showResLoginForm()">Back to Login</div>
    </div>
  </div>
</div>

<!-- HEADER -->
<div class="site-header" id="siteHeader" style="display:none;">
  <div class="logo-sm" onclick="goHome()"><svg viewBox="0 0 100 100" width="24" height="24" fill="none"><circle cx="50" cy="22" r="12" fill="#fff3e0"/><rect x="32" y="42" width="36" height="46" rx="3" fill="#fff" opacity="0.95"/><rect x="45" y="78" width="10" height="10" rx="2" fill="#ff6f00"/></svg></div>
  <div class="header-text"><div class="header-title" data-edit="header_title">SUN TOWER RWA</div><div class="header-sub" data-edit="header_sub">Block A2, Shipra Sun City, Indirapuram | BOM 2025-26</div></div>
  <div class="header-right"><span class="header-user" id="headerUser"></span><button class="header-btn" id="headerAuthBtn" onclick="toggleAuthBtn()">Login</button></div>
</div>

<!-- MAIN TABS -->
<div class="main-tabs" id="mainTabs" style="display:none;">
  <button class="main-tab active" onclick="switchTab('bom')" id="tabBom"><span class="lock-icon">&#128274;</span> BOM Internal</button>
  <button class="main-tab" onclick="switchTab('resident')" id="tabResident"><span class="lock-icon">&#128274;</span> Resident Portal</button>
  <button class="main-tab" onclick="switchTab('policy')" id="tabPolicy">Policies &amp; SOP</button>
  <button class="main-tab" onclick="switchTab('notices')" id="tabNotices">Notice Board <span id="escalationBadge" style="display:none;background:#b71c1c;color:#fff;font-size:0.65rem;padding:1px 6px;border-radius:10px;margin-left:4px"></span></button>
</div>

<!-- BOM SUB-NAV -->
<div class="sub-nav" id="bomSubNav" style="display:none;">
  <a href="#" onclick="showBom('election');return false" class="active" id="bn_election">Election</a>
  <a href="#" onclick="showBom('members');return false" id="bn_members">Members</a>
  <a href="#" onclick="showBom('challenges');return false" id="bn_challenges">Challenges</a>
  <a href="#" onclick="showBom('committees');return false" id="bn_committees">Committees</a>
  <a href="#" onclick="showBom('allocate');return false" id="bn_allocate">Allocate</a>
  <a href="#" onclick="showBom('dashboard');return false" id="bn_dashboard">Dashboard</a>
  <a href="#" onclick="showBom('projects');return false" id="bn_projects">Projects</a>
  <a href="#" onclick="showBom('admin');return false" id="bn_admin" style="background:#b71c1c;color:#fff;">Admin</a>
</div>

<!-- ================ TAB: BOM INTERNAL ================ -->
<div class="page has-subnav active" id="page_bom">
  <div id="bomLocked" style="text-align:center;padding:100px 20px;">
    <div style="font-size:4rem;margin-bottom:15px;">&#128274;</div>
    <h2 style="color:var(--primary);margin-bottom:10px;" data-edit="bom_locked_title">BOM Internal - Restricted Access</h2>
    <p style="color:var(--text-light);margin-bottom:20px;" data-edit="bom_locked_text">Only authorized Board of Management members can access this section.</p>
    <button class="btn btn-primary btn-lg" onclick="showAuth()">Login to Continue</button>
  </div>
  <div id="bomContent" style="display:none;">

    <!-- Election Results -->
    <div class="bom-sec" id="bs_election">
      <h2 class="page-title" data-edit="bom_election_title">Election Results - 01 February 2026</h2>
      <div class="grid-2">
        <div class="card" style="border-left-color:var(--success)"><h3>Election Summary</h3>
          <table><tr><td><strong>Date</strong></td><td>01 Feb 2026</td></tr><tr><td><strong>Voter Turnout</strong></td><td><strong style="color:var(--success);font-size:1.2rem">174</strong></td></tr><tr><td><strong>Valid Ballots</strong></td><td>168 (6 rejected)</td></tr><tr><td><strong>Candidates</strong></td><td>12</td></tr><tr><td><strong>Seats</strong></td><td>10</td></tr></table>
        </div>
        <div class="card" style="border-left-color:var(--primary)"><h3>Highlights</h3>
          <ul><li>Top candidate: <strong>129 votes</strong> (76.8%)</li><li>Only 23-vote gap between rank 1 and 10</li><li>All 10 members have strong mandate</li><li>STC: 6 members, STD: 3, STB: 1</li></ul>
        </div>
      </div>
      <div class="card"><h3>Elected BOM Members</h3>
        <table><tr><th>#</th><th>Name</th><th>Flat</th><th>Votes</th><th>Position</th></tr></table>
        <table id="electionTable"><tr><th>#</th><th>Name</th><th>Flat</th><th>Votes</th><th>Position</th></tr></table>
      </div>
    </div>

    <!-- Members -->
    <div class="bom-sec" id="bs_members" style="display:none">
      <h2 class="page-title" data-edit="bom_members_title">BOM Members Registration</h2>
      <p class="page-subtitle" data-edit="bom_members_subtitle">Only Admin can edit. Data saved to database (persists across browsers).</p>
      <div id="memberAdminLock" style="display:none"><div class="card" style="border-left-color:var(--warning);text-align:center"><p><strong>View Only</strong> - Contact Admin to make changes.</p></div></div>
      <div class="member-form" id="memberForm"></div>
      <div class="action-bar" id="memberActions"><button class="btn btn-primary" onclick="saveMembers()">Save to Database</button><button class="btn btn-secondary" onclick="loadElected()">Load Elected Members</button></div>
    </div>

    <!-- Challenges -->
    <div class="bom-sec" id="bs_challenges" style="display:none">
      <h2 class="page-title" data-edit="bom_challenges_title">Challenges & Responsibilities</h2>
      <div id="challengesArea"></div>
    </div>

    <!-- Committees -->
    <div class="bom-sec" id="bs_committees" style="display:none">
      <h2 class="page-title" data-edit="bom_committees_title">6 Working Committees</h2>
      <p class="page-subtitle" data-edit="bom_committees_subtitle">Each: 2 BOM + 3 Resident volunteers</p>
      <div id="committeesArea"></div>
    </div>

    <!-- Allocate -->
    <div class="bom-sec" id="bs_allocate" style="display:none">
      <h2 class="page-title" data-edit="bom_allocate_title">Task Allocation</h2>
      <div class="action-bar"><button class="btn btn-primary" onclick="autoAssign()">Auto-Assign</button><button class="btn btn-secondary" onclick="clearAssign()">Clear</button></div>
      <div id="allocArea"></div>
    </div>

    <!-- Dashboard -->
    <div class="bom-sec" id="bs_dashboard" style="display:none">
      <h2 class="page-title" data-edit="bom_dashboard_title">Dashboard</h2>
      <div class="action-bar"><button class="btn btn-primary" onclick="genDash()">Refresh</button><button class="btn btn-success" onclick="exportCSV()">Export CSV</button></div>
      <div id="dashArea"></div><div id="chartArea"></div>
    </div>

    <!-- Projects -->
    <div class="bom-sec" id="bs_projects" style="display:none">
      <h2 class="page-title">Project Management Dashboard</h2>
      <p class="page-subtitle">AI-powered monitoring of all society projects across committees</p>
      <div id="projDashArea"></div>
      <div id="aiInsightsArea"></div>
    </div>

    <!-- Admin -->
    <div class="bom-sec" id="bs_admin" style="display:none">
      <h2 class="page-title" data-edit="bom_admin_title">Admin Panel</h2>
      <div id="adminLock"><p style="color:var(--danger);font-weight:600;text-align:center;padding:40px">Admin access required (suntowershipra@gmail.com)</p></div>
      <div id="adminPanel" style="display:none">
        <div class="admin-section"><h3>&#128100; Create BOM Account</h3>
          <div class="grid-2"><div class="form-group"><label>Member</label><select class="form-control" id="accName"></select></div><div class="form-group"><label>Email</label><input type="email" class="form-control" id="accEmail" placeholder="member@email.com"></div></div>
          <div class="form-group"><label>Temp Password (min 6)</label><input type="text" class="form-control" id="accPass" placeholder="temporary123"></div>
          <button class="btn btn-primary" onclick="createAccount()">Create Account</button>
          <div class="auth-error" id="accErr" style="margin-top:10px"></div><div class="auth-success" id="accSuc" style="margin-top:10px"></div>
        </div>
        <div class="admin-section"><h3>&#128196; Upload Notice</h3>
          <div class="form-group"><label>Title</label><input type="text" class="form-control" id="nTitle"></div>
          <div class="form-group"><label>Summary</label><textarea class="form-control" id="nSummary"></textarea></div>
          <div class="grid-2"><div class="form-group"><label>Category</label><select class="form-control" id="nCat"><option>General</option><option>Financial</option><option>Maintenance</option><option>Event</option><option>Emergency</option><option>Meeting</option></select></div><div class="form-group"><label>Date</label><input type="date" class="form-control" id="nDate"></div></div>
          <div class="form-group"><label>File (PDF/Image)</label><input type="file" class="form-control" id="nFile" accept=".pdf,.jpg,.jpeg,.png"></div>
          <button class="btn btn-success" onclick="uploadNotice()">Upload</button>
          <div class="auth-success" id="nSuc" style="margin-top:10px"></div>
        </div>
        <div class="admin-section" style="border-color:#00695c;background:#e0f2f1"><h3 style="color:#00695c;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">&#128101; Resident Registration Requests <button class="btn btn-sm" style="background:#00695c;color:#fff;font-size:0.75rem" onclick="loadRegRequests();loadApprovedResidents()">&#8635; Refresh</button></h3>
          <div id="regRequestsArea"><p style="color:var(--text-light)">Loading...</p></div>
        </div>
        <div class="admin-section" style="border-color:#004d40;background:#e0f2f1"><h3 style="color:#004d40">&#9989; Approved Residents</h3>
          <div id="approvedResidentsArea"><p style="color:var(--text-light)">Loading...</p></div>
        </div>
        <div class="admin-section"><h3>&#128172; Resident Messages</h3><div id="adminMsgs"><p style="color:var(--text-light)">Loading...</p></div></div>
        <div class="admin-section" style="border-color:#1a237e;background:#e8eaf6"><h3 style="color:var(--primary)">&#9881; Admin Settings</h3>
          <div class="grid-2">
            <div style="background:#fff;padding:15px;border-radius:10px">
              <h4 style="color:var(--primary);margin-bottom:12px">&#128274; Change Admin Password</h4>
              <div class="form-group"><label>Current Password</label><input type="password" class="form-control" id="curPass" placeholder="Enter current password"></div>
              <div class="form-group"><label>New Password (min 6 chars)</label><input type="password" class="form-control" id="newPass" placeholder="Enter new password"></div>
              <div class="form-group"><label>Confirm New Password</label><input type="password" class="form-control" id="cfmPass" placeholder="Re-enter new password"></div>
              <button class="btn btn-primary" onclick="changeAdminPass()">Update Password</button>
              <div class="auth-error" id="passErr" style="margin-top:10px"></div>
              <div class="auth-success" id="passSuc" style="margin-top:10px"></div>
            </div>
            <div style="background:#fff;padding:15px;border-radius:10px">
              <h4 style="color:var(--primary);margin-bottom:12px">&#128100; Admin Profile</h4>
              <div class="form-group"><label>Admin Email</label><input type="email" class="form-control" id="adminEmailField" placeholder="admin@email.com"></div>
              <div class="form-group"><label>Admin Mobile No.</label><input type="tel" class="form-control" id="adminMobile" placeholder="e.g. 9876543210"></div>
              <div class="form-group"><label>Admin Display Name</label><input type="text" class="form-control" id="adminDispName" placeholder="e.g. Sunil Kumar"></div>
              <button class="btn btn-success" onclick="saveAdminProfile()">Save Profile</button>
              <div class="auth-error" id="profErr" style="margin-top:10px"></div>
              <div class="auth-success" id="profSuc" style="margin-top:10px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================ TAB: RESIDENT PORTAL ================ -->
<div class="page" id="page_resident">
  <div id="residentLocked" style="text-align:center;padding:80px 20px;">
    <div style="font-size:4rem;margin-bottom:15px;">&#127968;</div>
    <h2 style="color:#00695c;margin-bottom:10px;">Resident Portal - Login Required</h2>
    <p style="color:var(--text-light);margin-bottom:8px;">Only registered and verified flat owners can access this section.</p>
    <p style="color:var(--text-light);margin-bottom:25px;font-size:0.85rem">New residents can request registration below.</p>
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-lg" style="background:#00695c;color:#fff" onclick="showResidentAuth('login')">Resident Login</button>
      <button class="btn btn-lg btn-secondary" onclick="showResidentAuth('register')">Request Registration</button>
    </div>
  </div>
  <div id="residentContent" style="display:none">
  <div id="residentWelcome" style="background:linear-gradient(135deg,#e0f2f1,#b2dfdb);border-radius:12px;padding:15px 20px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div><span style="font-size:1.1rem;font-weight:700;color:#00695c">Welcome, </span><span id="residentNameDisplay" style="font-weight:700;color:#004d40"></span><span id="residentFlatDisplay" style="color:#666;margin-left:8px;font-size:0.85rem"></span></div>
    <button class="btn btn-sm" style="background:#00695c;color:#fff" onclick="doResidentLogout()">Logout</button>
  </div>
  <h2 class="page-title" data-edit="resident_title">Welcome to Sun Tower</h2>
  <p class="page-subtitle" data-edit="resident_subtitle">Stay informed and connected with your community</p>
  <div class="card" style="border-left-color:var(--success);background:linear-gradient(135deg,#e8f5e9,#c8e6c9)"><h3 style="color:var(--success)" data-edit="resident_announcement_title">New BOM Elected - February 2026</h3><p data-edit="resident_announcement_text">10 newly elected BOM members are committed to transparency and community improvement.</p></div>
  <h3 style="color:var(--primary);margin:25px 0 15px">Information & Services</h3>
  <div class="feature-grid">
    <div class="feature-card" onclick="toggleRsec('bominfo')"><div class="feature-icon">&#127963;</div><h4>BOM Members</h4><p>Your elected representatives</p></div>
    <div class="feature-card" onclick="toggleRsec('projects')"><div class="feature-icon">&#128679;</div><h4>Project Tracker</h4><p>Infrastructure & development updates</p></div>
    <div class="feature-card" onclick="toggleRsec('vendors')"><div class="feature-icon">&#129309;</div><h4>Vendors</h4><p>Active service providers</p></div>
    <div class="feature-card" onclick="toggleRsec('complaints')"><div class="feature-icon">&#128220;</div><h4>Complaint / Suggestion</h4><p>Submit your feedback</p></div>
    <div class="feature-card" onclick="toggleRsec('emergency')"><div class="feature-icon">&#127973;</div><h4>Emergency Contacts</h4><p>Security, Fire, Medical</p></div>
    <div class="feature-card" onclick="toggleRsec('rules')"><div class="feature-icon">&#128214;</div><h4>Society Rules</h4><p>Guidelines for residents</p></div>
    <div class="feature-card" onclick="toggleRsec('faq')"><div class="feature-icon">&#128161;</div><h4>FAQ</h4><p>Common questions answered</p></div>
    <div class="feature-card" onclick="switchTab('policy')"><div class="feature-icon">&#128209;</div><h4>Expense Policy</h4><p>GBM-approved SOP</p></div>
  </div>
  <div id="residentSecs">
    <div id="rs_bominfo" style="display:none;margin-top:20px"><div class="card"><h3>Elected BOM Members</h3><table id="resElectionTable"></table></div></div>
    <div id="rs_projects" style="display:none;margin-top:20px"><div class="card"><h3>Project Tracker</h3><div id="resProjectList"></div></div></div>
    <div id="rs_vendors" style="display:none;margin-top:20px"><div class="card"><h3>Vendor Directory</h3><table><tr><th>Vendor</th><th>Service</th><th>Staff</th></tr><tr><td><strong>PANZEER</strong></td><td>Security</td><td>23 Guards + 2 Sup</td></tr><tr><td><strong>SHINEBURG</strong></td><td>Housekeeping</td><td>11 Help + 1 Sup</td></tr><tr><td><strong>SKENTERPRISE</strong></td><td>Fire Systems</td><td>AMC</td></tr><tr><td><strong>KONE</strong></td><td>Lift AMC</td><td>AMC</td></tr></table></div></div>
    <div id="rs_complaints" style="display:none;margin-top:20px"><div class="card"><h3>Submit Complaint / Suggestion</h3><div class="form-group"><label>Name</label><input type="text" class="form-control" id="cName"></div><div class="form-group"><label>Flat</label><input type="text" class="form-control" id="cFlat" placeholder="e.g. STC-504"></div><div class="form-group"><label>Category</label><select class="form-control" id="cCat"><option>Maintenance</option><option>Security</option><option>Housekeeping</option><option>Parking</option><option>Noise</option><option>Suggestion</option><option>Other</option></select></div><div class="form-group"><label>Description</label><textarea class="form-control" id="cDesc"></textarea></div><button class="btn btn-primary" onclick="submitComp()">Submit</button><div class="auth-success" id="cSuc" style="margin-top:10px"></div></div></div>
    <div id="rs_emergency" style="display:none;margin-top:20px"><div class="card"><h3>Emergency Contacts</h3><div class="grid-2" style="margin-top:10px"><div class="contact-card"><div class="contact-icon" style="background:#b71c1c">&#128694;</div><div><strong>Security</strong><br>0120-4311286 Ext:5000</div></div><div class="contact-card"><div class="contact-icon" style="background:#e65100">&#128293;</div><div><strong>Fire</strong><br>101</div></div><div class="contact-card"><div class="contact-icon" style="background:#1a237e">&#128658;</div><div><strong>Police</strong><br>100 / 112</div></div><div class="contact-card"><div class="contact-icon" style="background:#004d40">&#127973;</div><div><strong>Ambulance</strong><br>108</div></div></div></div></div>
    <div id="rs_rules" style="display:none;margin-top:20px"><div class="card"><h3>Society Rules</h3><ul><li><strong>Parking:</strong> Only Park Plus sticker vehicles in basement</li><li><strong>Renovation:</strong> Prior BOM permission. Hours: 9AM-6PM Mon-Sat</li><li><strong>Pets:</strong> Leashed in common areas. Clean up after pet</li><li><strong>Noise:</strong> No loud music after 9PM</li><li><strong>Dues:</strong> Pay by 10th. Late fee after 15th</li><li><strong>Visitors:</strong> Register at gate</li></ul></div></div>
    <div id="rs_faq" style="display:none;margin-top:20px"><div class="card"><h3>FAQ</h3><div style="margin-bottom:12px"><strong>Q: How to pay maintenance?</strong><br>A: MyGate app or bank transfer. Details at security office.</div><div style="margin-bottom:12px"><strong>Q: How to book Club House?</strong><br>A: Contact BOM office. Charges & deposit apply.</div><div style="margin-bottom:12px"><strong>Q: Park Plus sticker?</strong><br>A: Visit security with car registration docs.</div><div style="margin-bottom:12px"><strong>Q: Report maintenance issue?</strong><br>A: Use Complaint form here, MyGate, or call security.</div></div></div>
  </div>
  </div>
</div>

<!-- ================ TAB: POLICY & SOP ================ -->
<div class="page" id="page_policy">
  <h2 class="page-title" data-edit="policy_title">Policies & Standard Operating Procedures</h2>
  <div class="card" style="border-left-color:var(--success);background:linear-gradient(135deg,#e8f5e9,#c8e6c9);margin-bottom:25px"><h3 style="color:var(--success)" data-edit="policy_gbm_title">Approved by General Body Meeting</h3><p data-edit="policy_gbm_text">These policies are binding on the Board of Management.</p></div>
  <div class="policy-section"><h3><div class="policy-icon" style="background:var(--primary)">&#128209;</div> Works & Project Approvals Policy</h3><p class="page-subtitle">Ref: UP Apartment Act, 2010 & Model Bye-laws</p></div>
  <div class="card"><h3>1. Purpose & Scope</h3><ul style="margin-top:10px"><li>Legal compliance with UP Apartment Act</li><li>Timely execution of emergency works</li><li>Financial prudence & transparent decision-making</li><li>Cost thresholds for Board self-approvals</li></ul></div>
  <div class="card"><h3>2. Project Classification</h3><div class="grid-3" style="margin-top:12px"><div style="background:#ffebee;padding:15px;border-radius:10px;text-align:center"><div style="font-size:2rem">&#9888;</div><h4 style="color:#b71c1c">Emergency Repairs</h4><p style="font-size:0.82rem;color:var(--text-light)">Risk to life/property. Burst water line, electrical hazard, structural damage.</p></div><div style="background:#e3f2fd;padding:15px;border-radius:10px;text-align:center"><div style="font-size:2rem">&#128736;</div><h4 style="color:#0d47a1">Upgradation</h4><p style="font-size:0.82rem;color:var(--text-light)">CCTV, PBX, pipe repairs, landscaping, equipment.</p></div><div style="background:#e8f5e9;padding:15px;border-radius:10px;text-align:center"><div style="font-size:2rem">&#127959;</div><h4 style="color:#1b5e20">Capital Works</h4><p style="font-size:0.82rem;color:var(--text-light)">Major renovations, lift, swimming pool, structural changes.</p></div></div></div>
  <div class="card"><h3>3. Cost Thresholds & Approval</h3><div class="grid-2" style="margin-top:12px"><div class="threshold-card" style="border-left-color:#b71c1c"><span class="badge badge-danger" style="font-size:0.7rem">Emergency</span><h4>Up to Rs. 50,000</h4><div class="threshold-amount">BOM Approval</div><div class="threshold-auth">Recorded in RWA register</div></div><div class="threshold-card" style="border-left-color:#e65100"><span class="badge badge-danger" style="font-size:0.7rem">Emergency</span><h4>Rs. 50K - 1 Lakh</h4><div class="threshold-amount">BOM Majority</div><div class="threshold-auth">Recorded in MoM register</div></div><div class="threshold-card" style="border-left-color:#c62828"><span class="badge badge-danger" style="font-size:0.7rem">Emergency</span><h4>Above Rs. 1 Lakh</h4><div class="threshold-amount">BOM + GBM</div><div class="threshold-auth">BOM majority + GBM cost approval</div></div><div class="threshold-card" style="border-left-color:#0d47a1"><span class="badge badge-info" style="font-size:0.7rem">Upgradation</span><h4>Up to Rs. 1 Lakh</h4><div class="threshold-amount">Prior GBM</div><div class="threshold-auth">Cost estimates + GBM video recording</div></div></div><div class="threshold-card" style="border-left-color:#1b5e20;margin-top:12px"><span class="badge badge-success" style="font-size:0.7rem">Capital Works</span><h4>Any Cost</h4><div class="threshold-amount">Full GBM + Resident Committee</div><div class="threshold-auth">WhatsApp/MyGate notice + committee + video recording. Fund: Infra/SEL/FD</div></div></div>
  <div class="card"><h3>4. Process Flow</h3><div class="process-flow" style="margin-top:12px"><div class="process-step" style="border-top:4px solid #1a237e"><div style="font-size:1.5rem">&#128221;</div><h5>Proposal</h5><p>Scope & cost estimate</p></div><div class="process-arrow">&#10132;</div><div class="process-step" style="border-top:4px solid #ff6f00"><div style="font-size:1.5rem">&#9989;</div><h5>Approval</h5><p>Per thresholds. Signed by President, GS & Treasurer</p></div><div class="process-arrow">&#10132;</div><div class="process-step" style="border-top:4px solid #2e7d32"><div style="font-size:1.5rem">&#128736;</div><h5>Execution</h5><p>2 quotes (<1L), 3 quotes (>=1L). Penalty clauses</p></div><div class="process-arrow">&#10132;</div><div class="process-step" style="border-top:4px solid #004d40"><div style="font-size:1.5rem">&#127937;</div><h5>Completion</h5><p>Report to residents & notice board</p></div></div></div>
  <div class="grid-2"><div class="card"><h3>5. Communication</h3><ul><li>Advance notice for planned works</li><li>Updates via WhatsApp, Notice Board, MyGate</li><li>Emergency: immediate post-action communication</li></ul></div><div class="card"><h3>6. Accountability</h3><ul><li>Policy binding once GBM-adopted</li><li>Annual external CA audit</li><li>All work orders on notice board</li><li>Vendor contracts with penalty clauses</li><li>Any resident can request project info</li></ul></div></div>
</div>

<!-- ================ TAB: NOTICE BOARD ================ -->
<div class="page" id="page_notices">
  <h2 class="page-title" data-edit="notices_title">Notice Board</h2>
  <div class="notice-filter"><button class="notice-filter-btn active" onclick="filterN('All',this)">All</button><button class="notice-filter-btn" onclick="filterN('General',this)">General</button><button class="notice-filter-btn" onclick="filterN('Financial',this)">Financial</button><button class="notice-filter-btn" onclick="filterN('Maintenance',this)">Maintenance</button><button class="notice-filter-btn" onclick="filterN('Event',this)">Event</button><button class="notice-filter-btn" onclick="filterN('Emergency',this)">Emergency</button><button class="notice-filter-btn" onclick="filterN('Meeting',this)">Meeting</button><button class="notice-filter-btn" id="escFilterBtn" onclick="filterN('Escalation',this)" style="display:none">&#9888; Escalation</button></div>
  <div class="notice-grid" id="noticeGrid"><div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-light)"><div style="font-size:3rem;margin-bottom:10px">&#128196;</div><p>No notices yet. Check back soon!</p></div></div>
</div>

<!-- NOTICE MODAL -->
<div class="modal-overlay hidden" id="noticeModal" onclick="if(event.target===this)closeModal()">
  <div class="modal-content"><div class="modal-header"><h3 id="mTitle">Notice</h3><button class="modal-close" onclick="closeModal()">&times;</button></div><div class="modal-body" id="mBody"></div></div>
</div>

<!-- CHATBOT -->
<div class="chatbot-widget" id="chatWidget" style="display:none">
  <button class="chatbot-btn" onclick="toggleChat()">&#128172;</button>
  <div class="chatbot-panel" id="chatPanel">
    <div class="chatbot-header"><h4>&#128172; Message BOM</h4><button style="background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer" onclick="toggleChat()">&times;</button></div>
    <div class="chatbot-messages" id="chatMsgs"><div class="chat-msg"><div class="chat-msg-bot">Hello! Send a message to the Board of Management. Please include your name and flat number.</div></div></div>
    <div class="chatbot-input"><input type="text" id="chatIn" placeholder="Type message..." onkeypress="if(event.key==='Enter')sendChat()"><button onclick="sendChat()">&#10148;</button></div>
  </div>
</div>

<!-- ================ JAVASCRIPT ================ -->
<script>
// ===== FIREBASE =====
let db=null,auth=null,storage=null,currentUser=null,isAdmin=false,residentUser=null;
if(typeof FIREBASE_CONFIG!=='undefined'&&FIREBASE_ENABLED){try{firebase.initializeApp(FIREBASE_CONFIG);auth=firebase.auth();db=firebase.firestore();storage=firebase.storage();auth.onAuthStateChanged(u=>{currentUser=u;isAdmin=u&&u.email===ADMIN_EMAIL;updateUI();if(u&&document.getElementById('bomContent').style.display==='block')unlockBOM();})}catch(e){console.log('Firebase init:',e)}}

// ===== DATA =====
const EM=[{name:'Sh. Lakhmi Chand',flat:'STB-304',v:129},{name:'Sh. Sunil Kumar',flat:'STD-701',v:128},{name:'Sh. Santosh Kr. Srivastava',flat:'STC-104',v:123},{name:'Sh. Himanshu Chaudhary',flat:'STC-502',v:117},{name:'Sh. Mahesh Chand Gupta',flat:'STD-901',v:115},{name:'Sh. Biman Saha',flat:'STC-805',v:113},{name:'Sh. Raj Kumar Rana',flat:'STC-504',v:107},{name:'Sh. Laxman Singh Pangtey',flat:'STC-603',v:106},{name:'Sh. Rajeev Mehta',flat:'STC-902',v:106},{name:'Sh. Harendra Singh',flat:'STD-906',v:105}];
const TASKS=[{id:'A1',c:'A',cn:'Security',t:'100% Car Park Plus Sticker',f:'weekly',dp:'Gen Secretary'},{id:'A2',c:'A',cn:'Security',t:'CCTV monitoring',f:'weekly',dp:'Gen Secretary'},{id:'A3',c:'A',cn:'Security',t:'Security Supervisor monitoring',f:'daily',dp:'Gen Secretary'},{id:'A4',c:'A',cn:'Security',t:'Patrolling report verification',f:'weekly',dp:'Gen Secretary'},{id:'A5',c:'A',cn:'Security',t:'Security welfare (wage/PF)',f:'monthly',dp:'Gen Secretary'},{id:'A6',c:'A',cn:'Security',t:'PA system mock run',f:'daily',dp:'Member'},{id:'B1',c:'B',cn:'Housekeeping',t:'Tower team adoption',f:'weekly',dp:'Gen Secretary'},{id:'B2',c:'B',cn:'Housekeeping',t:'Plant & flower maintenance',f:'weekly',dp:'Member'},{id:'B3',c:'B',cn:'Housekeeping',t:'Lift car shining',f:'daily',dp:'Member'},{id:'B4',c:'B',cn:'Housekeeping',t:'Shaft cleaning',f:'weekly',dp:'Vice Gen Secretary'},{id:'B5',c:'B',cn:'Housekeeping',t:'Basement cleaning',f:'weekly',dp:'Member'},{id:'B6',c:'B',cn:'Housekeeping',t:'Common area cleaning',f:'weekly',dp:'Member'},{id:'B7',c:'B',cn:'Housekeeping',t:'Reception glass dusting',f:'weekly',dp:'Member'},{id:'B8',c:'B',cn:'Housekeeping',t:'Pigeon waste cleaning',f:'monthly',dp:'Member'},{id:'C1',c:'C',cn:'Fire',t:'FAD panel daily check',f:'daily',dp:'Vice Gen Secretary'},{id:'C2',c:'C',cn:'Fire',t:'Sprinkler mock run',f:'quarterly',dp:'Vice Gen Secretary'},{id:'C3',c:'C',cn:'Fire',t:'Smoke detector test',f:'weekly',dp:'Vice Gen Secretary'},{id:'C4',c:'C',cn:'Fire',t:'Sensor stock check',f:'monthly',dp:'Vice Gen Secretary'},{id:'C5',c:'C',cn:'Fire',t:'AMC vendor visit',f:'quarterly',dp:'Vice Gen Secretary'},{id:'D1',c:'D',cn:'Facilities',t:'Library & quiz',f:'weekly',dp:'Member'},{id:'D2',c:'D',cn:'Facilities',t:'Medical room',f:'weekly',dp:'Member'},{id:'D3',c:'D',cn:'Facilities',t:'Indoor play rooms',f:'weekly',dp:'Vice Gen Secretary'},{id:'D4',c:'D',cn:'Facilities',t:'Driver/guest room',f:'weekly',dp:'Member'},{id:'D5',c:'D',cn:'Facilities',t:'Club house events',f:'monthly',dp:'Vice Gen Secretary'},{id:'D6',c:'D',cn:'Facilities',t:'Tea counter',f:'daily',dp:'Member'},{id:'E1',c:'E',cn:'Revenue',t:'SEL dues collection',f:'monthly',dp:'Treasurer'},{id:'E2',c:'E',cn:'Revenue',t:'Gate 2 parking charges',f:'once',dp:'Treasurer'},{id:'E3',c:'E',cn:'Revenue',t:'MyGate ERP accounting',f:'once',dp:'Treasurer'},{id:'E4',c:'E',cn:'Revenue',t:'Lift display revenue',f:'monthly',dp:'Vice Treasurer'},{id:'E5',c:'E',cn:'Revenue',t:'Kiosk display revenue',f:'monthly',dp:'Vice Treasurer'},{id:'E6',c:'E',cn:'Revenue',t:'Club house renting',f:'weekly',dp:'Vice Treasurer'},{id:'E7',c:'E',cn:'Revenue',t:'Flat sell fee',f:'monthly',dp:'Treasurer'},{id:'E8',c:'E',cn:'Revenue',t:'Plant nursery',f:'monthly',dp:'Member'},{id:'F1',c:'F',cn:'Infra',t:'Security Room completion',f:'once',dp:'Vice President'},{id:'F2',c:'F',cn:'Infra',t:'Gate 2 Park Plus merge',f:'once',dp:'Vice President'},{id:'F3',c:'F',cn:'Infra',t:'Basement painting',f:'once',dp:'Vice President'},{id:'F4',c:'F',cn:'Infra',t:'Reception renovation',f:'once',dp:'Vice President'},{id:'F5',c:'F',cn:'Infra',t:'CCTV cameras',f:'once',dp:'Member'},{id:'F6',c:'F',cn:'Infra',t:'Lift renovation tender',f:'once',dp:'Vice President'},{id:'F7',c:'F',cn:'Infra',t:'Garden development',f:'once',dp:'Member'},{id:'F8',c:'F',cn:'Infra',t:'Fire NOC roof exit',f:'once',dp:'Vice Gen Secretary'},{id:'F9',c:'F',cn:'Infra',t:'Swimming pool',f:'once',dp:'Member'},{id:'F10',c:'F',cn:'Infra',t:'Club kitchen area',f:'once',dp:'Member'},{id:'F11',c:'F',cn:'Infra',t:'DG room tools rack',f:'once',dp:'Member'},{id:'F12',c:'F',cn:'Infra',t:'Indoor play renovation',f:'once',dp:'Member'},{id:'F13',c:'F',cn:'Infra',t:'Lift room painting',f:'once',dp:'Vice President'},{id:'F14',c:'F',cn:'Infra',t:'EV charging station',f:'once',dp:'Member'},{id:'F15',c:'F',cn:'Infra',t:'Overhead tank repair',f:'once',dp:'Vice President'},{id:'F16',c:'F',cn:'Infra',t:'Pipe shaft repair',f:'once',dp:'Vice President'},{id:'F17',c:'F',cn:'Infra',t:'Toilet renovation',f:'once',dp:'Member'},{id:'F18',c:'F',cn:'Infra',t:'Illumination',f:'once',dp:'Member'}];
const POS=['President','Vice President','Gen Secretary','Vice Gen Secretary','Treasurer','Vice Treasurer','Joint Secretary','Sport Secretary','Culture Secretary','Spokesperson','Chairman','Co-Chairman','PRO','Advisor','Member','Custom...'];
const PROF=['Engineer/Technical','CA/Finance/Banking','Legal/Advocate','Doctor/Medical','IT/Software','Business/Entrepreneur','Government Service','Education/Teacher','Retired Professional','Management/Corporate','Real Estate','Other'];
const DEF_PROJECTS=[{id:'P1',name:'Security Room Gate 1',committee:'F',status:'In Progress',timeline:'Feb-Mar 2026',budget:'TBD',progress:30,description:'Construction of new security room at Gate 1 entrance',updates:[],documents:[],meetings:[]},{id:'P2',name:'Gate 2 Park Plus',committee:'F',status:'Planned',timeline:'Mar 2026',budget:'TBD',progress:5,description:'Integration of Park Plus system at Gate 2',updates:[],documents:[],meetings:[]},{id:'P3',name:'Basement Painting',committee:'F',status:'Planned',timeline:'Apr 2026',budget:'TBD',progress:0,description:'Complete basement painting and waterproofing',updates:[],documents:[],meetings:[]},{id:'P4',name:'Reception Renovation',committee:'F',status:'Planned',timeline:'Apr-May 2026',budget:'TBD',progress:0,description:'Complete renovation of reception area',updates:[],documents:[],meetings:[]},{id:'P5',name:'CCTV Cameras',committee:'A',status:'Planned',timeline:'Mar 2026',budget:'TBD',progress:10,description:'Installation of new CCTV cameras across all areas',updates:[],documents:[],meetings:[]},{id:'P6',name:'EV Charging',committee:'F',status:'Planned',timeline:'Q2 2026',budget:'TBD',progress:0,description:'Electric vehicle charging stations in basement',updates:[],documents:[],meetings:[]},{id:'P7',name:'Lift Renovation',committee:'F',status:'Tender',timeline:'Q2-Q3 2026',budget:'TBD',progress:5,description:'Major lift renovation across all towers',updates:[],documents:[],meetings:[]},{id:'P8',name:'Fire NOC',committee:'C',status:'In Progress',timeline:'Ongoing',budget:'TBD',progress:40,description:'Fire NOC compliance and roof exit construction',updates:[],documents:[],meetings:[]}];
let projects=[];
function loadProjects(){try{const s=localStorage.getItem('st_projects');if(s)projects=JSON.parse(s);else{projects=JSON.parse(JSON.stringify(DEF_PROJECTS));saveProjects()}}catch(e){projects=JSON.parse(JSON.stringify(DEF_PROJECTS))}}
function saveProjects(){localStorage.setItem('st_projects',JSON.stringify(projects));if(db){projects.forEach(p=>db.collection('projects').doc(p.id).set(p).catch(()=>{}))}}
let members=[],notices=[];
let assignments=JSON.parse(localStorage.getItem('st_assignments')||'{}');

// ===== NAVIGATION =====
function enterBOM(){hideSplash();if(!currentUser)showAuth();else switchTab('bom')}
function enterResident(){hideSplash();if(!residentUser)showResidentAuth('login');else switchTab('resident')}
function hideSplash(){const s=document.getElementById('splashScreen');s.classList.add('hidden');document.getElementById('siteHeader').style.display='flex';document.getElementById('mainTabs').style.display='flex';setTimeout(()=>s.style.display='none',800)}
function goHome(){const s=document.getElementById('splashScreen');s.style.display='flex';s.classList.remove('hidden');document.getElementById('siteHeader').style.display='none';document.getElementById('mainTabs').style.display='none';document.getElementById('bomSubNav').style.display='none';document.getElementById('chatWidget').style.display='none'}
function switchTab(t){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.main-tab').forEach(b=>b.classList.remove('active'));document.getElementById('page_'+t).classList.add('active');const tabMap={bom:'tabBom',resident:'tabResident',policy:'tabPolicy',notices:'tabNotices'};document.getElementById(tabMap[t]).classList.add('active');document.getElementById('bomSubNav').style.display=t==='bom'?'flex':'none';document.getElementById('page_bom').className=t==='bom'?'page has-subnav active':'page';document.getElementById('chatWidget').style.display=(t==='resident'&&residentUser)?'block':'none';if(t==='bom'){if(currentUser)unlockBOM();else{document.getElementById('bomLocked').style.display='block';document.getElementById('bomContent').style.display='none'}}if(t==='resident'){if(residentUser){unlockResident()}else{document.getElementById('residentLocked').style.display='block';document.getElementById('residentContent').style.display='none'}}if(t==='notices')loadNotices();window.scrollTo(0,0)}
function unlockBOM(){document.getElementById('bomLocked').style.display='none';document.getElementById('bomContent').style.display='block';loadMemDB();buildElectionTable();if(isAdmin){document.getElementById('bn_admin').style.display='';document.getElementById('adminLock').style.display='none';document.getElementById('adminPanel').style.display='block';popAccDrop();loadAdminMsgs();loadAdminProfile();loadRegRequests();loadApprovedResidents()}else{document.getElementById('bn_admin').style.display='none'}}
function showBom(s){document.querySelectorAll('.bom-sec').forEach(el=>el.style.display='none');document.querySelectorAll('.sub-nav a').forEach(a=>a.classList.remove('active'));const el=document.getElementById('bs_'+s);if(el)el.style.display='block';const nav=document.getElementById('bn_'+s);if(nav)nav.classList.add('active');if(s==='members')initMemForm();if(s==='allocate')initAlloc();if(s==='dashboard')genDash();if(s==='challenges')buildChallenges();if(s==='committees')buildCommittees();if(s==='projects'){loadProjects();buildProjDash();runAIMonitor()}if(s==='admin'&&isAdmin){loadRegRequests();loadApprovedResidents();loadAdminMsgs()}window.scrollTo(0,0)}

// ===== AUTH =====
function showAuth(){document.getElementById('authOverlay').classList.remove('hidden');document.getElementById('loginForm').style.display='block';document.getElementById('forgotForm').style.display='none'}
function hideAuth(){document.getElementById('authOverlay').classList.add('hidden')}
function showForgotPw(){document.getElementById('loginForm').style.display='none';document.getElementById('forgotForm').style.display='block'}
function showLoginFm(){document.getElementById('loginForm').style.display='block';document.getElementById('forgotForm').style.display='none'}
function doLogin(){const e=document.getElementById('loginEmail').value.trim(),p=document.getElementById('loginPassword').value,err=document.getElementById('loginError'),suc=document.getElementById('loginSuccess');err.style.display='none';suc.style.display='none';if(!e||!p){err.textContent='Enter email and password';err.style.display='block';return}if(auth){auth.signInWithEmailAndPassword(e,p).then(()=>{localStorage.setItem('st_bom_session',JSON.stringify({email:e}));suc.textContent='Success!';suc.style.display='block';setTimeout(()=>{hideAuth();switchTab('bom')},500)}).catch(x=>{err.textContent=x.message;err.style.display='block'})}else{const u=JSON.parse(localStorage.getItem('st_users')||'{}');if((u[e]&&u[e]===p)||(e===ADMIN_EMAIL&&p==='admin123')){currentUser={email:e};isAdmin=e===ADMIN_EMAIL;if(!u[e]){u[e]=p;localStorage.setItem('st_users',JSON.stringify(u))}localStorage.setItem('st_bom_session',JSON.stringify({email:e}));updateUI();suc.textContent='Success!';suc.style.display='block';setTimeout(()=>{hideAuth();switchTab('bom')},500)}else{err.textContent='Invalid. Default admin: suntowershipra@gmail.com / admin123';err.style.display='block'}}}
function doForgotPw(){const e=document.getElementById('forgotEmail').value.trim(),err=document.getElementById('forgotError'),suc=document.getElementById('forgotSuccess');err.style.display='none';suc.style.display='none';if(!e){err.textContent='Enter email';err.style.display='block';return}if(auth){auth.sendPasswordResetEmail(e).then(()=>{suc.textContent='Reset link sent!';suc.style.display='block'}).catch(x=>{err.textContent=x.message;err.style.display='block'})}else{suc.textContent='Firebase not configured. Contact admin.';suc.style.display='block'}}
function toggleAuthBtn(){if(currentUser)doLogout();else showAuth()}
function doLogout(){if(auth)auth.signOut();currentUser=null;isAdmin=false;residentUser=null;localStorage.removeItem('st_resident_user');localStorage.removeItem('st_bom_session');updateUI();goHome()}
function updateUI(){const u=document.getElementById('headerUser'),b=document.getElementById('headerAuthBtn');if(currentUser){u.textContent=currentUser.email||'';b.textContent='Logout'}else{u.textContent='';b.textContent='Login'}}

// ===== MEMBERS =====
function loadMemDB(){if(db){db.collection('members').orderBy('rank').get().then(s=>{if(!s.empty){members=s.docs.map(d=>d.data());updatePosBadges()}else loadMemLS()}).catch(()=>loadMemLS())}else loadMemLS()}
function loadMemLS(){try{const s=localStorage.getItem('suntower_members');if(s){members=JSON.parse(s);updatePosBadges()}}catch(e){}}
function buildElectionTable(){const t=document.getElementById('electionTable');if(!t)return;let h='<tr><th>#</th><th>Name</th><th>Flat</th><th>Votes</th><th>Position</th></tr>';EM.forEach((m,i)=>{const mem=members[i];const pos=mem&&mem.position?mem.position:'To be elected';const pc={'President':'badge-president','Vice President':'badge-vp','Gen Secretary':'badge-gs','Vice Gen Secretary':'badge-vgs','Treasurer':'badge-treasurer','Vice Treasurer':'badge-vt','Joint Secretary':'badge-vgs','Sport Secretary':'badge-info','Culture Secretary':'badge-info','Spokesperson':'badge-warning','Chairman':'badge-president','Co-Chairman':'badge-vp','PRO':'badge-info','Advisor':'badge-vt','Member':'badge-member'};const cls=pc[pos]||'badge-success';h+=`<tr style="background:#e8f5e9"><td>${i+1}</td><td><strong>${m.name}</strong></td><td>${m.flat}</td><td><strong>${m.v}</strong></td><td><span class="badge ${cls}">${pos}</span></td></tr>`});t.innerHTML=h}
function updatePosBadges(){buildElectionTable()}
function initMemForm(){const f=document.getElementById('memberForm');if(!f)return;const ro=!isAdmin;f.innerHTML='';for(let i=0;i<10;i++){const m=members[i]||{};const em=EM[i]||{};const d=ro?'disabled':'';const isCustomPos=m.position&&!POS.includes(m.position)&&m.position!=='Custom...';const selVal=isCustomPos?'Custom...':m.position||'';f.innerHTML+=`<div class="member-card"><div style="text-align:center;font-weight:700;color:var(--primary);margin-bottom:10px">Member ${i+1} | Votes: ${em.v||''}</div><label>Name</label><input type="text" id="n_${i}" value="${m.name||em.name||''}" ${d}><label>Flat</label><input type="text" id="f_${i}" value="${m.flat||em.flat||''}" ${d}><label>Profession</label><select id="pr_${i}" ${d}><option value="">--</option>${PROF.map(p=>`<option value="${p}" ${m.profession===p?'selected':''}>${p}</option>`).join('')}</select><label>Position</label><select id="po_${i}" ${d} onchange="handlePosChange(${i})"><option value="">-- To be elected --</option>${POS.map(p=>`<option value="${p}" ${selVal===p?'selected':''}>${p}</option>`).join('')}</select><div id="customPos_${i}" style="display:${isCustomPos?'block':'none'};margin-top:4px"><input type="text" id="cp_${i}" value="${isCustomPos?m.position:''}" placeholder="Enter custom designation" ${d} style="border:2px solid var(--secondary)"></div><label>Phone</label><input type="text" id="ph_${i}" value="${m.phone||''}" ${d}><label>Email</label><input type="email" id="em_${i}" value="${m.email||''}" ${d}></div>`}document.getElementById('memberAdminLock').style.display=ro?'block':'none';document.getElementById('memberActions').style.display=ro?'none':'flex'}
function handlePosChange(i){const sel=document.getElementById('po_'+i).value;const box=document.getElementById('customPos_'+i);if(sel==='Custom...'){box.style.display='block';document.getElementById('cp_'+i).focus()}else{box.style.display='none';document.getElementById('cp_'+i).value=''}}
function saveMembers(){if(!isAdmin){alert('Only Admin can save.');return}members=[];for(let i=0;i<10;i++){let pos=document.getElementById('po_'+i).value;if(pos==='Custom...'){const cp=document.getElementById('cp_'+i).value.trim();if(cp)pos=cp;else pos='Member'}members.push({rank:i+1,name:document.getElementById('n_'+i).value.trim(),flat:document.getElementById('f_'+i).value.trim(),profession:document.getElementById('pr_'+i).value,position:pos,phone:document.getElementById('ph_'+i).value.trim(),email:document.getElementById('em_'+i).value.trim(),votes:EM[i]?.v||0})}if(db){const b=db.batch();members.forEach((m,i)=>b.set(db.collection('members').doc('m_'+i),m));b.commit().then(()=>{alert('Saved to database!');updatePosBadges()}).catch(e=>{localStorage.setItem('suntower_members',JSON.stringify(members));alert('Saved locally (DB unavailable)');updatePosBadges()})}else{localStorage.setItem('suntower_members',JSON.stringify(members));alert('Saved locally!');updatePosBadges()}}
function loadElected(){members=EM.map((m,i)=>({rank:i+1,name:m.name,flat:m.flat,profession:'',position:'',phone:'',email:'',votes:m.v}));initMemForm()}

// ===== CHALLENGES =====
function buildChallenges(){const a=document.getElementById('challengesArea');if(!a||a.innerHTML)return;const cc={A:'#b71c1c',B:'#4a148c',C:'#1a237e',D:'#01579b',E:'#004d40',F:'#e65100'};const cn={A:'Security/PANZEER',B:'Housekeeping/SHINEBURG',C:'Fire/SKENTERPRISE',D:'Facilities',E:'Revenue',F:'Infrastructure'};let h='';let lc='';TASKS.forEach(t=>{if(t.c!==lc){lc=t.c;h+=`<div class="card" style="border-left-color:${cc[t.c]}"><h3>${t.c} - ${cn[t.c]}</h3><table><tr><th>#</th><th>Task</th><th>Freq</th></tr>`}h+=`<tr><td>${t.id}</td><td>${t.t}</td><td><span class="freq-badge freq-${t.f}">${t.f}</span></td></tr>`;const nx=TASKS[TASKS.indexOf(t)+1];if(!nx||nx.c!==t.c)h+='</table></div>'});a.innerHTML=h}

// ===== COMMITTEES =====
function buildCommittees(){const a=document.getElementById('committeesArea');if(!a||a.innerHTML)return;const comms=[{c:'A',n:'Security',icon:'&#128737;',bg:'#b71c1c',sop:'CCTV, patrolling, Park Plus, welfare checks'},{c:'B',n:'Housekeeping',icon:'&#128700;',bg:'#4a148c',sop:'Cleaning, lifts, plants, shaft maintenance'},{c:'C',n:'Fire Safety',icon:'&#128293;',bg:'#1a237e',sop:'FAD panels, sprinklers, smoke detectors, AMC'},{c:'D',n:'Facilities',icon:'&#127968;',bg:'#01579b',sop:'Library, medical, play areas, club house'},{c:'E',n:'Revenue',icon:'&#128176;',bg:'#004d40',sop:'Dues, parking, advertising, ERP, rentals'},{c:'F',n:'Infrastructure',icon:'&#128679;',bg:'#e65100',sop:'All 18 projects, tenders, renovations'}];let h='<div class="grid-2">';comms.forEach(cm=>{h+=`<div class="committee-card" style="border-top-color:${cm.bg}"><h3><div class="committee-icon" style="background:${cm.bg}">${cm.icon}</div>Committee ${cm.c} - ${cm.n}</h3><div class="comm-member-slot"><span class="slot-type slot-bom">BOM Convenor</span><select class="form-control" style="flex:1;padding:5px"><option>-- Select --</option>${members.filter(m=>m&&m.name).map(m=>`<option>${m.name}</option>`).join('')}</select></div><div class="comm-member-slot"><span class="slot-type slot-bom">BOM Member</span><select class="form-control" style="flex:1;padding:5px"><option>-- Select --</option>${members.filter(m=>m&&m.name).map(m=>`<option>${m.name}</option>`).join('')}</select></div><div class="comm-member-slot"><span class="slot-type slot-resident">Resident 1</span><input class="form-control" style="flex:1;padding:5px" placeholder="Name & Flat"></div><div class="comm-member-slot"><span class="slot-type slot-resident">Resident 2</span><input class="form-control" style="flex:1;padding:5px" placeholder="Name & Flat"></div><div class="comm-member-slot"><span class="slot-type slot-resident">Resident 3</span><input class="form-control" style="flex:1;padding:5px" placeholder="Name & Flat"></div><div class="sop-box"><strong>SOP:</strong> ${cm.sop}</div></div>`});h+='</div>';a.innerHTML=h}

// ===== ALLOCATION =====
function initAlloc(){const a=document.getElementById('allocArea');const vm=members.filter(m=>m&&m.name);if(!vm.length){a.innerHTML='<div class="card"><p>Register members first.</p></div>';return}let h='',lc='';const cc={A:'#b71c1c',B:'#4a148c',C:'#1a237e',D:'#01579b',E:'#004d40',F:'#e65100'};TASKS.forEach(t=>{if(t.c!==lc){lc=t.c;h+=`<div class="task-category" style="border-left:4px solid ${cc[t.c]}">Cat ${t.c} - ${t.cn}</div>`}h+=`<div class="task-row"><strong style="min-width:35px;color:${cc[t.c]}">${t.id}</strong><span style="flex:1">${t.t}</span><select id="a_${t.id}" onchange="assignments['${t.id}']=this.value;saveAssignments()"><option value="">--</option>${vm.map(m=>`<option value="${m.name}" ${assignments[t.id]===m.name?'selected':''}>${m.name}</option>`).join('')}</select></div>`});a.innerHTML=h}
function saveAssignments(){localStorage.setItem('st_assignments',JSON.stringify(assignments));if(db){db.collection('settings').doc('assignments').set(assignments).catch(()=>{})}}
function autoAssign(){const vm=members.filter(m=>m&&m.name);if(!vm.length)return;const pm={};vm.forEach(m=>{const p=m.position||'Member';if(!pm[p])pm[p]=[];pm[p].push(m.name)});let mi=0;TASKS.forEach(t=>{if(t.dp==='Member'){const ml=pm['Member']||vm.map(m=>m.name);assignments[t.id]=ml[mi++%ml.length]}else{assignments[t.id]=(pm[t.dp]&&pm[t.dp][0])||vm[0].name}});saveAssignments();initAlloc()}
function clearAssign(){assignments={};saveAssignments();initAlloc()}
function genDash(){const a=document.getElementById('dashArea'),ch=document.getElementById('chartArea');const vm=members.filter(m=>m&&m.name);if(!vm.length){a.innerHTML='<div class="card"><p>No members.</p></div>';return}const mt={};vm.forEach(m=>{mt[m.name]=[]});TASKS.forEach(t=>{if(assignments[t.id]&&mt[assignments[t.id]])mt[assignments[t.id]].push(t)});const tot=Object.values(mt).reduce((s,a)=>s+a.length,0);const pc={'President':'#b71c1c','Vice President':'#4a148c','Gen Secretary':'#1a237e','Vice Gen Secretary':'#01579b','Treasurer':'#004d40','Vice Treasurer':'#1b5e20','Member':'#e65100'};let h=`<p><strong>Total:</strong> ${TASKS.length} | <strong>Assigned:</strong> ${tot} | <strong>Unassigned:</strong> ${TASKS.length-tot}</p><div class="summary-grid">`;vm.forEach(m=>{const ts=mt[m.name]||[];const c=pc[m.position]||'#666';h+=`<div class="summary-card" style="border-top:4px solid ${c}"><div class="name">${m.name}</div><div class="position"><span class="badge" style="background:${c}">${m.position||'Member'}</span></div><div class="task-count">${ts.length}</div><div style="font-size:0.8rem;color:#666">tasks</div></div>`});h+='</div>';a.innerHTML=h;const mx=Math.max(...vm.map(m=>(mt[m.name]||[]).length),1);let c2='<div class="card"><h3>Workload</h3>';vm.forEach(m=>{const cnt=(mt[m.name]||[]).length;const p=(cnt/mx)*100;const cl=pc[m.position]||'#666';c2+=`<div style="display:flex;align-items:center;gap:10px;margin:6px 0"><span style="min-width:120px;font-size:0.85rem;font-weight:600">${m.name}</span><div style="flex:1;background:#e0e0e0;border-radius:8px;height:24px;position:relative"><div style="width:${p}%;background:${cl};border-radius:8px;height:100%"></div><span style="position:absolute;right:8px;top:3px;font-size:0.8rem;font-weight:600">${cnt}</span></div></div>`});c2+='</div>';ch.innerHTML=c2}
function exportCSV(){const vm=members.filter(m=>m&&m.name);let csv='ID,Category,Task,Freq,Assigned,Position\n';TASKS.forEach(t=>{const a=assignments[t.id]||'';const m=vm.find(x=>x.name===a);csv+=`"${t.id}","${t.cn}","${t.t}","${t.f}","${a}","${m?m.position:''}"\n`});const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);const el=document.createElement('a');el.href=u;el.download='SunTower_Allocation.csv';el.click()}

// ===== ADMIN =====
function popAccDrop(){const s=document.getElementById('accName');if(!s)return;s.innerHTML='<option value="">--</option>';EM.forEach(m=>{s.innerHTML+=`<option>${m.name} (${m.flat})</option>`})}
function createAccount(){const e=document.getElementById('accEmail').value.trim(),p=document.getElementById('accPass').value,n=document.getElementById('accName').value,err=document.getElementById('accErr'),suc=document.getElementById('accSuc');err.style.display='none';suc.style.display='none';if(!e||!p||p.length<6){err.textContent='Valid email & password (6+ chars) required';err.style.display='block';return}if(auth){const ae=currentUser.email;auth.createUserWithEmailAndPassword(e,p).then(()=>{suc.textContent=`Account created for ${n||e}!`;suc.style.display='block';return auth.signInWithEmailAndPassword(ae,document.getElementById('loginPassword')?.value||'admin123')}).catch(x=>{err.textContent=x.message;err.style.display='block'})}else{const u=JSON.parse(localStorage.getItem('st_users')||'{}');u[e]=p;localStorage.setItem('st_users',JSON.stringify(u));suc.textContent=`Created: ${n||e} | ${e} / ${p}`;suc.style.display='block'}}
function loadAdminMsgs(){const c=document.getElementById('adminMsgs');if(db){db.collection('messages').orderBy('timestamp','desc').limit(20).get().then(s=>{if(s.empty){c.innerHTML='<p>No messages.</p>';return}let h='<table><tr><th>Date</th><th>From</th><th>Message</th></tr>';s.forEach(d=>{const x=d.data();h+=`<tr><td>${x.date||''}</td><td>${x.name||'Anon'}</td><td>${x.message}</td></tr>`});h+='</table>';c.innerHTML=h}).catch(()=>{loadLocalMsgs(c)})}else loadLocalMsgs(c)}
function loadLocalMsgs(c){const m=JSON.parse(localStorage.getItem('st_messages')||'[]');if(!m.length){c.innerHTML='<p>No messages.</p>';return}let h='<table><tr><th>Date</th><th>Message</th></tr>';m.forEach(x=>{h+=`<tr><td>${x.date||''}</td><td>${x.message}</td></tr>`});h+='</table>';c.innerHTML=h}
function uploadNotice(){const t=document.getElementById('nTitle').value.trim(),s=document.getElementById('nSummary').value.trim(),c=document.getElementById('nCat').value,d=document.getElementById('nDate').value,fl=document.getElementById('nFile').files[0],suc=document.getElementById('nSuc');if(!t){alert('Enter title');return}const n={title:t,summary:s,category:c,date:d||new Date().toISOString().split('T')[0],fileUrl:'',fileType:''};if(fl&&storage){const r=storage.ref('notices/'+Date.now()+'_'+fl.name);r.put(fl).then(x=>x.ref.getDownloadURL()).then(u=>{n.fileUrl=u;n.fileType=fl.type.includes('pdf')?'pdf':'image';return db.collection('notices').add(n)}).then(()=>{suc.textContent='Uploaded!';suc.style.display='block';document.getElementById('nTitle').value=''}).catch(e=>alert('Error: '+e.message))}else{if(fl){const r=new FileReader();r.onload=e=>{n.fileUrl=e.target.result;n.fileType=fl.type.includes('pdf')?'pdf':'image';const ex=JSON.parse(localStorage.getItem('st_notices')||'[]');ex.unshift(n);localStorage.setItem('st_notices',JSON.stringify(ex));suc.textContent='Saved!';suc.style.display='block';document.getElementById('nTitle').value=''};r.readAsDataURL(fl)}else{const ex=JSON.parse(localStorage.getItem('st_notices')||'[]');ex.unshift(n);localStorage.setItem('st_notices',JSON.stringify(ex));suc.textContent='Saved!';suc.style.display='block';document.getElementById('nTitle').value=''}}}

// ===== NOTICES =====
function loadNotices(){if(db){db.collection('notices').orderBy('date','desc').get().then(s=>{notices=s.docs.map(d=>({id:d.id,...d.data()}));renderN(notices)}).catch(()=>renderLocalN())}else renderLocalN()}
function renderLocalN(){notices=JSON.parse(localStorage.getItem('st_notices')||'[]');renderN(notices)}
function isBOMLoggedIn(){return !!currentUser}
function renderN(l){const g=document.getElementById('noticeGrid');const isBOM=isBOMLoggedIn();const filtered=isBOM?l:l.filter(n=>n.category!=='Escalation');const escBtn=document.getElementById('escFilterBtn');if(escBtn)escBtn.style.display=isBOM?'':'none';const badge=document.getElementById('escalationBadge');if(badge)badge.style.display=isBOM&&badge.textContent!=='0'?'inline':'none';if(!filtered.length){g.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-light)"><div style="font-size:3rem;margin-bottom:10px">&#128196;</div><p>No notices yet.</p></div>';return}const cc={General:'#1a237e',Financial:'#004d40',Maintenance:'#e65100',Event:'#4a148c',Emergency:'#b71c1c',Meeting:'#01579b',Escalation:'#b71c1c'};g.innerHTML=filtered.map((n,i)=>{const oi=l.indexOf(n);return `<div class="notice-card" onclick="openN(${oi})" style="border-top-color:${cc[n.category]||'#1a237e'}"><div class="notice-body"><div class="notice-date">${n.date||''}</div><div class="notice-title">${n.title||'Notice'}</div><div class="notice-summary">${n.summary||''}</div><div class="notice-cat"><span class="badge" style="background:${cc[n.category]||'#1a237e'};font-size:0.7rem">${n.category||'General'}</span></div></div></div>`}).join('')}
function filterN(c,el){document.querySelectorAll('.notice-filter-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');if(c==='All')renderN(notices);else renderN(notices.filter(n=>n.category===c))}
function openN(i){const n=notices[i];if(!n)return;document.getElementById('mTitle').textContent=n.title||'Notice';const b=document.getElementById('mBody');if(n.fileUrl){if(n.fileType==='pdf'||n.fileUrl.includes('.pdf'))b.innerHTML=`<iframe src="${n.fileUrl}" style="width:100%;min-height:600px;border:none"></iframe>`;else b.innerHTML=`<img src="${n.fileUrl}" style="max-width:100%">`}else b.innerHTML=`<div style="padding:20px"><p><strong>Date:</strong> ${n.date||''}</p><p><strong>Category:</strong> ${n.category||''}</p><p style="margin-top:15px">${n.summary||''}</p></div>`;document.getElementById('noticeModal').classList.remove('hidden')}
function closeModal(){document.getElementById('noticeModal').classList.add('hidden')}

// ===== CHATBOT =====
function toggleChat(){document.getElementById('chatPanel').classList.toggle('open')}
function sendChat(){const i=document.getElementById('chatIn'),m=i.value.trim();if(!m)return;const c=document.getElementById('chatMsgs');c.innerHTML+=`<div class="chat-msg"><div class="chat-msg-user">${m}</div></div>`;i.value='';const d={message:m,name:'Resident',date:new Date().toLocaleDateString(),timestamp:new Date()};if(db)db.collection('messages').add(d);else{const ms=JSON.parse(localStorage.getItem('st_messages')||'[]');ms.push(d);localStorage.setItem('st_messages',JSON.stringify(ms))}setTimeout(()=>{c.innerHTML+=`<div class="chat-msg"><div class="chat-msg-bot">Thank you! BOM has been notified. For urgent matters call 0120-4311286.</div></div>`;c.scrollTop=c.scrollHeight},1000);c.scrollTop=c.scrollHeight}
function toggleRsec(s){document.querySelectorAll('[id^="rs_"]').forEach(el=>el.style.display='none');const el=document.getElementById('rs_'+s);if(el)el.style.display='block';if(s==='bominfo')buildResElectionTable();if(s==='projects')buildResProjectList()}
function buildResElectionTable(){const t=document.getElementById('resElectionTable');if(!t)return;const pc={'President':'badge-president','Vice President':'badge-vp','Gen Secretary':'badge-gs','Vice Gen Secretary':'badge-vgs','Treasurer':'badge-treasurer','Vice Treasurer':'badge-vt','Joint Secretary':'badge-vgs','Sport Secretary':'badge-info','Culture Secretary':'badge-info','Spokesperson':'badge-warning','Chairman':'badge-president','Co-Chairman':'badge-vp','PRO':'badge-info','Advisor':'badge-vt','Member':'badge-member'};let h='<tr><th>#</th><th>Name</th><th>Flat</th><th>Votes</th><th>Position</th></tr>';EM.forEach((m,i)=>{const mem=members[i];const pos=mem&&mem.position?mem.position:'To be elected';const cls=pc[pos]||'badge-success';h+=`<tr style="background:#e8f5e9"><td>${i+1}</td><td><strong>${m.name}</strong></td><td>${m.flat}</td><td><strong>${m.v}</strong></td><td><span class="badge ${cls}">${pos}</span></td></tr>`});t.innerHTML=h}
function submitComp(){const d=document.getElementById('cDesc').value.trim();if(!d){alert('Enter description');return}const data={name:document.getElementById('cName').value,flat:document.getElementById('cFlat').value,category:document.getElementById('cCat').value,description:d,status:'Pending',date:new Date().toISOString()};if(db)db.collection('complaints').add(data).then(()=>{document.getElementById('cSuc').textContent='Submitted!';document.getElementById('cSuc').style.display='block'});else{document.getElementById('cSuc').textContent='Submitted! (saved locally)';document.getElementById('cSuc').style.display='block'}}

// ===== RESIDENT AUTH =====
let pendingOTP={};
function showResidentAuth(mode){document.getElementById('residentAuthOverlay').classList.remove('hidden');if(mode==='register'){document.getElementById('resLoginForm').style.display='none';document.getElementById('resRegForm').style.display='block';document.getElementById('resForgotForm').style.display='none'}else if(mode==='forgot'){document.getElementById('resLoginForm').style.display='none';document.getElementById('resRegForm').style.display='none';document.getElementById('resForgotForm').style.display='block'}else{document.getElementById('resLoginForm').style.display='block';document.getElementById('resRegForm').style.display='none';document.getElementById('resForgotForm').style.display='none'}}
function hideResidentAuth(){document.getElementById('residentAuthOverlay').classList.add('hidden')}
function showResLoginForm(){showResidentAuth('login')}
function showResRegForm(){showResidentAuth('register')}
function showResForgotPw(){showResidentAuth('forgot')}

function doResidentLogin(){const e=document.getElementById('resLoginEmail').value.trim(),p=document.getElementById('resLoginPassword').value,err=document.getElementById('resLoginError'),suc=document.getElementById('resLoginSuccess');err.style.display='none';suc.style.display='none';if(!e||!p){err.textContent='Enter email and password';err.style.display='block';return}const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const r=residents.find(x=>x.email.toLowerCase()===e.toLowerCase()&&x.status==='approved');if(!r){err.textContent='Account not found or not yet approved by Admin. Please check email or request registration.';err.style.display='block';return}const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');const storedPass=rUsers[e.toLowerCase()];if(!storedPass){const autoPass='Sun'+r.flatNo.replace('-','')+'!';rUsers[e.toLowerCase()]=autoPass;localStorage.setItem('st_res_users',JSON.stringify(rUsers));if(p===autoPass){residentUser=r;localStorage.setItem('st_resident_user',JSON.stringify(r));suc.textContent='Welcome, '+r.ownerName+'!';suc.style.display='block';setTimeout(()=>{hideResidentAuth();switchTab('resident')},600)}else{err.innerHTML='Password not found. A new password has been set: <strong style="color:#00695c;font-size:1.1rem">'+autoPass+'</strong><br>Please login again with this password.';err.style.display='block'}return}if(storedPass===p){residentUser=r;localStorage.setItem('st_resident_user',JSON.stringify(r));suc.textContent='Welcome, '+r.ownerName+'!';suc.style.display='block';setTimeout(()=>{hideResidentAuth();switchTab('resident')},600)}else{err.textContent='Incorrect password. Use Forgot Password to reset.';err.style.display='block'}}

function unlockResident(){document.getElementById('residentLocked').style.display='none';document.getElementById('residentContent').style.display='block';if(residentUser){document.getElementById('residentNameDisplay').textContent=residentUser.ownerName||'';document.getElementById('residentFlatDisplay').textContent=residentUser.flatNo?' | Flat: '+residentUser.flatNo:''}document.getElementById('chatWidget').style.display='block'}

function doResidentLogout(){residentUser=null;localStorage.removeItem('st_resident_user');document.getElementById('residentLocked').style.display='block';document.getElementById('residentContent').style.display='none';document.getElementById('chatWidget').style.display='none'}

function submitResidentReg(){const name=document.getElementById('regOwnerName').value.trim(),flat=document.getElementById('regFlatNo').value.trim(),mob=document.getElementById('regMobile').value.trim(),email=document.getElementById('regEmail').value.trim(),err=document.getElementById('resRegError'),suc=document.getElementById('resRegSuccess');err.style.display='none';suc.style.display='none';if(!name||!flat||!mob||!email){err.textContent='All fields are required';err.style.display='block';return}if(!/\S+@\S+\.\S+/.test(email)){err.textContent='Enter a valid email address';err.style.display='block';return}if(mob.length<10){err.textContent='Enter a valid 10-digit mobile number';err.style.display='block';return}const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const dup=residents.find(x=>x.email.toLowerCase()===email.toLowerCase()||x.flatNo.toUpperCase()===flat.toUpperCase());if(dup){if(dup.status==='approved'){err.textContent='This flat/email is already registered. Please login.';err.style.display='block'}else{err.textContent='A registration request for this flat/email is already pending.';err.style.display='block'}return}const req={id:'REG_'+Date.now(),ownerName:name,flatNo:flat.toUpperCase(),mobile:mob,email:email.toLowerCase(),status:'pending',permissions:{read:true,write:false},requestDate:new Date().toISOString()};residents.push(req);localStorage.setItem('st_residents',JSON.stringify(residents));if(db)db.collection('residents').doc(req.id).set(req).catch(()=>{});suc.textContent='Registration request submitted! Admin will verify and approve your account. You will receive login credentials after approval.';suc.style.display='block';document.getElementById('regOwnerName').value='';document.getElementById('regFlatNo').value='';document.getElementById('regMobile').value='';document.getElementById('regEmail').value=''}

function sendResidentOTP(){const email=document.getElementById('resForgotEmail').value.trim(),err=document.getElementById('resForgotError'),suc=document.getElementById('resForgotSuccess');err.style.display='none';suc.style.display='none';if(!email){err.textContent='Enter your registered email';err.style.display='block';return}const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const r=residents.find(x=>x.email.toLowerCase()===email.toLowerCase()&&x.status==='approved');if(!r){err.textContent='Email not found or account not approved.';err.style.display='block';return}const otp=String(Math.floor(100000+Math.random()*900000));pendingOTP={email:email.toLowerCase(),otp:otp,expires:Date.now()+600000};suc.innerHTML='OTP generated! <strong style="font-size:1.3rem;color:#00695c;letter-spacing:3px">'+otp+'</strong><br><span style="font-size:0.8rem;color:#999">(In production, this OTP will be sent to your email via Firebase/SMTP. Valid for 10 min)</span>';suc.style.display='block';document.getElementById('resForgotStep1').style.display='none';document.getElementById('resForgotStep2').style.display='block'}

function verifyOTPResetPass(){const otp=document.getElementById('resOtpInput').value.trim(),np=document.getElementById('resNewPass').value,cf=document.getElementById('resConfirmPass').value,err=document.getElementById('resForgotError'),suc=document.getElementById('resForgotSuccess');err.style.display='none';suc.style.display='none';if(!otp||!np||!cf){err.textContent='All fields required';err.style.display='block';return}if(np.length<6){err.textContent='Password must be at least 6 characters';err.style.display='block';return}if(np!==cf){err.textContent='Passwords do not match';err.style.display='block';return}if(!pendingOTP.otp||otp!==pendingOTP.otp){err.textContent='Invalid OTP. Please try again.';err.style.display='block';return}if(Date.now()>pendingOTP.expires){err.textContent='OTP expired. Please request a new one.';err.style.display='block';return}const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');rUsers[pendingOTP.email]=np;localStorage.setItem('st_res_users',JSON.stringify(rUsers));pendingOTP={};suc.textContent='Password reset successfully! You can now login with your new password.';suc.style.display='block';document.getElementById('resForgotStep2').style.display='none';document.getElementById('resForgotStep1').style.display='block';document.getElementById('resOtpInput').value='';document.getElementById('resNewPass').value='';document.getElementById('resConfirmPass').value='';setTimeout(()=>showResLoginForm(),2000)}

// ===== ADMIN: RESIDENT MANAGEMENT =====
function loadRegRequests(){const area=document.getElementById('regRequestsArea');const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const pending=residents.filter(r=>r.status==='pending');if(!pending.length){area.innerHTML='<p style="color:var(--text-light);text-align:center;padding:15px">No pending registration requests.</p>';return}let h='<table><tr><th>Date</th><th>Owner Name</th><th>Flat</th><th>Mobile</th><th>Email</th><th>Read</th><th>Write</th><th>Action</th></tr>';pending.forEach(r=>{const dt=r.requestDate?new Date(r.requestDate).toLocaleDateString():'';h+=`<tr><td>${dt}</td><td><strong>${r.ownerName}</strong></td><td>${r.flatNo}</td><td>${r.mobile}</td><td style="font-size:0.8rem">${r.email}</td><td><input type="checkbox" id="perm_r_${r.id}" checked></td><td><input type="checkbox" id="perm_w_${r.id}"></td><td><button class="btn btn-sm" style="background:#00695c;color:#fff;margin:2px" onclick="approveResident('${r.id}')">Approve</button><button class="btn btn-sm btn-danger" style="margin:2px" onclick="rejectResident('${r.id}')">Reject</button></td></tr>`});h+='</table>';area.innerHTML=h}

function approveResident(id){const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const idx=residents.findIndex(r=>r.id===id);if(idx===-1)return;const readPerm=document.getElementById('perm_r_'+id)?.checked??true;const writePerm=document.getElementById('perm_w_'+id)?.checked??false;residents[idx].status='approved';residents[idx].permissions={read:readPerm,write:writePerm};residents[idx].approvedDate=new Date().toISOString();const tempPass='Sun'+residents[idx].flatNo.replace('-','')+'!';residents[idx].tempPass=tempPass;const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');rUsers[residents[idx].email.toLowerCase()]=tempPass;localStorage.setItem('st_res_users',JSON.stringify(rUsers));localStorage.setItem('st_residents',JSON.stringify(residents));if(db)db.collection('residents').doc(id).set(residents[idx],{merge:true}).catch(()=>{});alert('APPROVED!\n\nResident: '+residents[idx].ownerName+'\nFlat: '+residents[idx].flatNo+'\nEmail: '+residents[idx].email+'\n\nLogin Password: '+tempPass+'\n\nShare this password with the resident.');loadRegRequests();loadApprovedResidents()}

function rejectResident(id){if(!confirm('Reject this registration request?'))return;const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const idx=residents.findIndex(r=>r.id===id);if(idx===-1)return;residents.splice(idx,1);localStorage.setItem('st_residents',JSON.stringify(residents));if(db)db.collection('residents').doc(id).delete().catch(()=>{});loadRegRequests()}

function loadApprovedResidents(){const area=document.getElementById('approvedResidentsArea');const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');const approved=residents.filter(r=>r.status==='approved');if(!approved.length){area.innerHTML='<p style="color:var(--text-light);text-align:center;padding:15px">No approved residents yet.</p>';return}let h=`<p style="margin-bottom:10px;font-size:0.85rem;color:#666">Total approved: <strong>${approved.length}</strong></p><table><tr><th>Owner Name</th><th>Flat</th><th>Mobile</th><th>Email</th><th>Password</th><th>Read</th><th>Write</th><th>Action</th></tr>`;approved.forEach(r=>{const pw=rUsers[r.email.toLowerCase()]||r.tempPass||'Sun'+r.flatNo.replace('-','')+'!';h+=`<tr><td><strong>${r.ownerName}</strong></td><td>${r.flatNo}</td><td>${r.mobile}</td><td style="font-size:0.8rem">${r.email}</td><td><code style="background:#e8f5e9;padding:3px 8px;border-radius:4px;font-weight:700;color:#00695c">${pw}</code></td><td><input type="checkbox" id="ar_${r.id}" ${r.permissions?.read?'checked':''} onchange="updateResPerms('${r.id}')"></td><td><input type="checkbox" id="aw_${r.id}" ${r.permissions?.write?'checked':''} onchange="updateResPerms('${r.id}')"></td><td><button class="btn btn-sm" style="background:#e65100;color:#fff" onclick="resetResPass('${r.id}')">Reset PW</button> <button class="btn btn-sm btn-danger" onclick="revokeResident('${r.id}')">Revoke</button></td></tr>`});h+='</table>';area.innerHTML=h}

function updateResPerms(id){const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const idx=residents.findIndex(r=>r.id===id);if(idx===-1)return;residents[idx].permissions={read:document.getElementById('ar_'+id)?.checked??true,write:document.getElementById('aw_'+id)?.checked??false};localStorage.setItem('st_residents',JSON.stringify(residents));if(db)db.collection('residents').doc(id).set(residents[idx],{merge:true}).catch(()=>{})}

function resetResPass(id){const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const r=residents.find(x=>x.id===id);if(!r)return;const newPass='Sun'+r.flatNo.replace('-','')+'!';const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');rUsers[r.email.toLowerCase()]=newPass;localStorage.setItem('st_res_users',JSON.stringify(rUsers));alert('Password reset for '+r.ownerName+':\n\nNew temp password: '+newPass+'\n\nShare with the resident.')}

function revokeResident(id){if(!confirm('Revoke access for this resident? They will no longer be able to login.'))return;const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const idx=residents.findIndex(r=>r.id===id);if(idx===-1)return;const email=residents[idx].email.toLowerCase();residents.splice(idx,1);localStorage.setItem('st_residents',JSON.stringify(residents));const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');delete rUsers[email];localStorage.setItem('st_res_users',JSON.stringify(rUsers));if(db)db.collection('residents').doc(id).delete().catch(()=>{});loadApprovedResidents()}

// ===== PROJECT TRACKER =====
const COMM_NAMES={A:'Security',B:'Housekeeping',C:'Fire Safety',D:'Facilities',E:'Revenue',F:'Infrastructure'};
const COMM_COLORS={A:'#b71c1c',B:'#4a148c',C:'#1a237e',D:'#01579b',E:'#004d40',F:'#e65100'};
const STATUS_COLORS={'Planned':'#1565c0','In Progress':'#e65100','Tender':'#b71c1c','On Hold':'#616161','Completed':'#2e7d32'};

function buildResProjectList(){loadProjects();const a=document.getElementById('resProjectList');if(!a)return;let h='<table style="width:100%"><tr><th>Project</th><th>Committee</th><th>Status</th><th>Progress</th><th>Timeline</th></tr>';projects.forEach(p=>{const sc=STATUS_COLORS[p.status]||'#666';h+=`<tr style="cursor:pointer" onclick="openProjectDetail('${p.id}')"><td><strong>${p.name}</strong></td><td><span style="color:${COMM_COLORS[p.committee]||'#666'};font-weight:600">${COMM_NAMES[p.committee]||p.committee}</span></td><td><span class="badge" style="background:${sc}">${p.status}</span></td><td><div style="background:#e0e0e0;border-radius:8px;height:20px;width:100px;position:relative"><div style="background:${sc};height:100%;border-radius:8px;width:${p.progress}%"></div><span style="position:absolute;top:1px;width:100%;text-align:center;font-size:0.7rem;font-weight:700;color:${p.progress>50?'#fff':'#333'}">${p.progress}%</span></div></td><td>${p.timeline}</td></tr>`});h+='</table><p style="margin-top:10px;font-size:0.8rem;color:#999">Click any project for details</p>';a.innerHTML=h}

function openProjectDetail(id){loadProjects();const p=projects.find(x=>x.id===id);if(!p)return;const sc=STATUS_COLORS[p.status]||'#666';const cc=COMM_COLORS[p.committee]||'#666';let updH='';if(p.updates&&p.updates.length){p.updates.slice().reverse().forEach(u=>{updH+=`<div style="border-left:3px solid ${cc};padding:8px 12px;margin:8px 0;background:#f5f5f5;border-radius:0 8px 8px 0"><div style="font-size:0.75rem;color:#999">${u.date} | ${u.by||'Committee'}</div><div style="margin-top:4px">${u.text}</div></div>`})}else updH='<p style="color:#999">No updates yet.</p>';let mtgH='';if(p.meetings&&p.meetings.length){p.meetings.slice().reverse().forEach(m=>{mtgH+=`<div style="border-left:3px solid #1a237e;padding:8px 12px;margin:8px 0;background:#e8eaf6;border-radius:0 8px 8px 0"><div style="font-size:0.75rem;color:#999">${m.date}</div><div style="font-weight:600">${m.attendees||''}</div><div style="margin-top:4px">${m.summary||''}</div></div>`})}else mtgH='<p style="color:#999">No meetings logged.</p>';let docH='';if(p.documents&&p.documents.length){p.documents.forEach(d=>{docH+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;margin:4px 0;background:#f5f5f5;border-radius:6px">&#128196; <a href="${d.url||'#'}" target="_blank" style="color:${cc};font-weight:600">${d.name}</a><span style="font-size:0.75rem;color:#999">${d.date||''}</span></div>`})}else docH='<p style="color:#999">No documents uploaded.</p>';document.getElementById('mTitle').textContent=p.name;document.getElementById('mBody').innerHTML=`<div style="padding:15px"><div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px"><span class="badge" style="background:${sc};font-size:0.85rem">${p.status}</span><span class="badge" style="background:${cc};font-size:0.85rem">Committee ${p.committee} - ${COMM_NAMES[p.committee]}</span><span style="color:#666;font-size:0.85rem">Timeline: ${p.timeline}</span></div><div style="margin-bottom:15px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>Progress</strong><span>${p.progress}%</span></div><div style="background:#e0e0e0;border-radius:10px;height:24px"><div style="background:linear-gradient(90deg,${cc},${sc});height:100%;border-radius:10px;width:${p.progress}%;transition:0.3s"></div></div></div><p style="color:#666;margin-bottom:20px">${p.description||''}</p><h4 style="color:${cc};border-bottom:2px solid ${cc};padding-bottom:5px;margin-bottom:10px">&#128221; Updates</h4>${updH}<h4 style="color:#1a237e;border-bottom:2px solid #1a237e;padding-bottom:5px;margin:20px 0 10px">&#128197; Meeting History</h4>${mtgH}<h4 style="color:#004d40;border-bottom:2px solid #004d40;padding-bottom:5px;margin:20px 0 10px">&#128196; Documents</h4>${docH}</div>`;document.getElementById('noticeModal').classList.remove('hidden')}

function buildProjDash(){loadProjects();const a=document.getElementById('projDashArea');if(!a)return;let h='';projects.forEach(p=>{const sc=STATUS_COLORS[p.status]||'#666';const cc=COMM_COLORS[p.committee]||'#666';const lastUpd=p.updates&&p.updates.length?p.updates[p.updates.length-1].date:'Never';const lastMtg=p.meetings&&p.meetings.length?p.meetings[p.meetings.length-1].date:'Never';h+=`<div class="card" style="border-left:4px solid ${cc};margin-bottom:15px"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:12px"><h3 style="margin:0;color:${cc}">${p.name}</h3><div style="display:flex;gap:6px;align-items:center"><span class="badge" style="background:${cc};font-size:0.7rem">Committee ${p.committee}</span><span class="badge" style="background:${sc};font-size:0.7rem">${p.status}</span></div></div><div class="grid-2" style="margin-bottom:12px"><div><label style="font-weight:700;font-size:0.8rem">Status</label><select class="form-control" id="ps_${p.id}" style="padding:6px"><option ${p.status==='Planned'?'selected':''}>Planned</option><option ${p.status==='In Progress'?'selected':''}>In Progress</option><option ${p.status==='Tender'?'selected':''}>Tender</option><option ${p.status==='On Hold'?'selected':''}>On Hold</option><option ${p.status==='Completed'?'selected':''}>Completed</option></select></div><div><label style="font-weight:700;font-size:0.8rem">Progress: <span id="pv_${p.id}">${p.progress}</span>%</label><input type="range" min="0" max="100" value="${p.progress}" id="pp_${p.id}" style="width:100%" oninput="document.getElementById('pv_${p.id}').textContent=this.value"></div></div><div style="display:flex;gap:6px;font-size:0.8rem;color:#666;margin-bottom:12px"><span>Last Update: <strong>${lastUpd}</strong></span> | <span>Last Meeting: <strong>${lastMtg}</strong></span></div><div style="margin-bottom:10px"><label style="font-weight:700;font-size:0.8rem">Add Update</label><textarea class="form-control" id="pu_${p.id}" rows="2" placeholder="Enter project update..."></textarea></div><div class="grid-2" style="margin-bottom:10px"><div><label style="font-weight:700;font-size:0.8rem">Log Meeting</label><input type="date" class="form-control" id="pmd_${p.id}" style="padding:6px"><input type="text" class="form-control" id="pma_${p.id}" placeholder="Attendees" style="padding:6px;margin-top:4px"><input type="text" class="form-control" id="pms_${p.id}" placeholder="Meeting summary" style="padding:6px;margin-top:4px"></div><div><label style="font-weight:700;font-size:0.8rem">Upload Document</label><input type="file" class="form-control" id="pf_${p.id}" accept=".pdf,.jpg,.png,.doc,.docx" style="padding:6px"><input type="text" class="form-control" id="pfn_${p.id}" placeholder="Document name" style="padding:6px;margin-top:4px"></div></div><div style="display:flex;gap:8px"><button class="btn btn-primary btn-sm" onclick="saveProjUpdate('${p.id}')">Save Update</button><button class="btn btn-sm" style="background:#1a237e;color:#fff" onclick="saveProjMeeting('${p.id}')">Log Meeting</button><button class="btn btn-sm" style="background:#004d40;color:#fff" onclick="saveProjDoc('${p.id}')">Upload Doc</button></div></div>`});a.innerHTML=h}

function saveProjUpdate(id){const p=projects.find(x=>x.id===id);if(!p)return;const status=document.getElementById('ps_'+id).value;const progress=parseInt(document.getElementById('pp_'+id).value);const text=document.getElementById('pu_'+id).value.trim();p.status=status;p.progress=progress;if(text){if(!p.updates)p.updates=[];p.updates.push({text:text,date:new Date().toLocaleDateString(),by:currentUser?currentUser.email:'BOM'});document.getElementById('pu_'+id).value=''}saveProjects();buildProjDash();alert('Project updated!')}

function saveProjMeeting(id){const p=projects.find(x=>x.id===id);if(!p)return;const dt=document.getElementById('pmd_'+id).value;const att=document.getElementById('pma_'+id).value.trim();const sum=document.getElementById('pms_'+id).value.trim();if(!dt){alert('Select meeting date');return}if(!p.meetings)p.meetings=[];p.meetings.push({date:dt,attendees:att,summary:sum});document.getElementById('pmd_'+id).value='';document.getElementById('pma_'+id).value='';document.getElementById('pms_'+id).value='';saveProjects();buildProjDash();alert('Meeting logged!')}

function saveProjDoc(id){const p=projects.find(x=>x.id===id);if(!p)return;const fl=document.getElementById('pf_'+id).files[0];const nm=document.getElementById('pfn_'+id).value.trim()||'Document';if(!fl){alert('Select a file');return}if(!p.documents)p.documents=[];const r=new FileReader();r.onload=e=>{p.documents.push({name:nm,url:e.target.result,date:new Date().toLocaleDateString(),type:fl.type});document.getElementById('pf_'+id).value='';document.getElementById('pfn_'+id).value='';saveProjects();buildProjDash();alert('Document uploaded!')};r.readAsDataURL(fl)}

// ===== AI MONITOR =====
function runAIMonitor(){loadProjects();const insights=[];const escalations=[];const now=Date.now();const DAY=86400000;projects.forEach(p=>{const lastUpd=p.updates&&p.updates.length?new Date(p.updates[p.updates.length-1].date).getTime():0;const lastMtg=p.meetings&&p.meetings.length?new Date(p.meetings[p.meetings.length-1].date).getTime():0;const daysSinceUpd=lastUpd?Math.floor((now-lastUpd)/DAY):999;const daysSinceMtg=lastMtg?Math.floor((now-lastMtg)/DAY):999;const cn=COMM_NAMES[p.committee]||p.committee;if(p.status==='Completed')return;if(daysSinceUpd>=14){escalations.push({project:p.name,committee:cn,commId:p.committee,type:'No Updates',msg:`No updates for ${daysSinceUpd} days`,severity:'red'});insights.push(` <strong>${p.name}</strong> (${cn}): No update for ${daysSinceUpd} days  ESCALATED`)}else if(daysSinceUpd>=7){insights.push(` <strong>${p.name}</strong> (${cn}): Last update ${daysSinceUpd} days ago  needs attention`)}else if(lastUpd){insights.push(` <strong>${p.name}</strong> (${cn}): Updated ${daysSinceUpd} day(s) ago  on track`)}else{escalations.push({project:p.name,committee:cn,commId:p.committee,type:'Never Updated',msg:'Project has never been updated',severity:'red'});insights.push(` <strong>${p.name}</strong> (${cn}): Never updated  ESCALATED`)}if(daysSinceMtg>=21){escalations.push({project:p.name,committee:cn,commId:p.committee,type:'No Meetings',msg:`No meeting for ${daysSinceMtg} days`,severity:'red'});insights.push(` <strong>${p.name}</strong>: No meeting for ${daysSinceMtg}+ days  ESCALATED`)}else if(daysSinceMtg>=14){insights.push(` <strong>${p.name}</strong>: Last meeting ${daysSinceMtg} days ago`)}});const area=document.getElementById('aiInsightsArea');if(!area)return;const totalP=projects.filter(x=>x.status!=='Completed').length;const greenC=insights.filter(x=>x.startsWith('')).length;const yellowC=insights.filter(x=>x.startsWith('')).length;const redC=insights.filter(x=>x.startsWith('')).length;const score=totalP?Math.round((greenC/totalP)*100):0;const scoreColor=score>=70?'#2e7d32':score>=40?'#e65100':'#b71c1c';let h=`<div class="card" style="border-left:4px solid #1a237e;margin-top:20px"><h3 style="color:#1a237e"> AI Project Monitor</h3><div class="grid-3" style="margin:15px 0"><div style="text-align:center;padding:15px;background:#e8f5e9;border-radius:10px"><div style="font-size:2rem;font-weight:700;color:${scoreColor}">${score}%</div><div style="font-size:0.8rem;color:#666">Health Score</div></div><div style="text-align:center;padding:15px;background:#fff3e0;border-radius:10px"><div style="font-size:2rem;font-weight:700;color:#e65100">${escalations.length}</div><div style="font-size:0.8rem;color:#666">Escalations</div></div><div style="text-align:center;padding:15px;background:#e3f2fd;border-radius:10px"><div style="font-size:2rem;font-weight:700;color:#1565c0">${totalP}</div><div style="font-size:0.8rem;color:#666">Active Projects</div></div></div>`;const commHealth={};['A','B','C','D','E','F'].forEach(c=>{commHealth[c]={green:0,yellow:0,red:0,total:0}});insights.forEach(ins=>{const m=ins.match(/\(([^)]+)\)/);if(!m)return;const cn=m[1];const ck=Object.keys(COMM_NAMES).find(k=>COMM_NAMES[k]===cn);if(!ck)return;if(ins.startsWith(''))commHealth[ck].green++;else if(ins.startsWith(''))commHealth[ck].yellow++;else commHealth[ck].red++;commHealth[ck].total++});h+='<h4 style="margin:15px 0 10px">Committee Health</h4><div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px">';['A','B','C','D','E','F'].forEach(c=>{const ch=commHealth[c];if(!ch.total)return;const col=ch.red>0?'#b71c1c':ch.yellow>0?'#e65100':'#2e7d32';const emoji=ch.red>0?'':ch.yellow>0?'':'';h+=`<div style="padding:10px 15px;background:#f5f5f5;border-radius:8px;border-left:4px solid ${COMM_COLORS[c]}"><strong>${emoji} ${COMM_NAMES[c]}</strong><div style="font-size:0.75rem;color:${col}">G:${ch.green} Y:${ch.yellow} R:${ch.red}</div></div>`});h+='</div><h4 style="margin:15px 0 10px">AI Insights</h4><div style="max-height:300px;overflow-y:auto">';insights.forEach(ins=>{h+=`<div style="padding:6px 10px;margin:4px 0;background:#fafafa;border-radius:6px;font-size:0.85rem">${ins}</div>`});h+='</div></div>';area.innerHTML=h;if(escalations.length>0)createEscalationNotices(escalations)}

function createEscalationNotices(escalations){const existing=JSON.parse(localStorage.getItem('st_notices')||'[]');const today=new Date().toISOString().split('T')[0];const todayEsc=existing.filter(n=>n.category==='Escalation'&&n.date===today);if(todayEsc.length>=escalations.length)return;escalations.forEach(e=>{const dup=existing.find(n=>n.category==='Escalation'&&n.date===today&&n.title.includes(e.project));if(dup)return;existing.unshift({title:' AI Alert: Committee '+e.commId+' ('+e.committee+') - '+e.type,summary:e.project+': '+e.msg+'. Immediate attention required by BOM.',category:'Escalation',date:today,fileUrl:'',fileType:'',auto:true})});localStorage.setItem('st_notices',JSON.stringify(existing));updateEscBadge()}

function updateEscBadge(){const notices=JSON.parse(localStorage.getItem('st_notices')||'[]');const esc=notices.filter(n=>n.category==='Escalation');const badge=document.getElementById('escalationBadge');if(badge){if(esc.length>0&&isBOMLoggedIn()){badge.textContent=esc.length;badge.style.display='inline'}else{badge.style.display='none'}}}

// ===== ADMIN SETTINGS =====
function changeAdminPass(){const cur=document.getElementById('curPass').value,np=document.getElementById('newPass').value,cf=document.getElementById('cfmPass').value,err=document.getElementById('passErr'),suc=document.getElementById('passSuc');err.style.display='none';suc.style.display='none';if(!cur||!np||!cf){err.textContent='All fields are required';err.style.display='block';return}if(np.length<6){err.textContent='New password must be at least 6 characters';err.style.display='block';return}if(np!==cf){err.textContent='New password and confirmation do not match';err.style.display='block';return}if(auth&&currentUser){const cred=firebase.auth.EmailAuthProvider.credential(currentUser.email,cur);currentUser.reauthenticateWithCredential(cred).then(()=>currentUser.updatePassword(np)).then(()=>{suc.textContent='Password changed successfully!';suc.style.display='block';document.getElementById('curPass').value='';document.getElementById('newPass').value='';document.getElementById('cfmPass').value=''}).catch(e=>{err.textContent=e.message;err.style.display='block'})}else{const u=JSON.parse(localStorage.getItem('st_users')||'{}');const ae=currentUser?currentUser.email:ADMIN_EMAIL;if(u[ae]===cur||cur==='admin123'){u[ae]=np;localStorage.setItem('st_users',JSON.stringify(u));suc.textContent='Password changed successfully! Use new password next login.';suc.style.display='block';document.getElementById('curPass').value='';document.getElementById('newPass').value='';document.getElementById('cfmPass').value=''}else{err.textContent='Current password is incorrect';err.style.display='block'}}}
function loadAdminProfile(){const p=JSON.parse(localStorage.getItem('st_admin_profile')||'{}');if(db){db.collection('settings').doc('admin_profile').get().then(d=>{if(d.exists){const data=d.data();document.getElementById('adminEmailField').value=data.email||'';document.getElementById('adminMobile').value=data.mobile||'';document.getElementById('adminDispName').value=data.displayName||''}else fillFromLS()}).catch(()=>fillFromLS())}else fillFromLS();function fillFromLS(){document.getElementById('adminEmailField').value=p.email||ADMIN_EMAIL;document.getElementById('adminMobile').value=p.mobile||'';document.getElementById('adminDispName').value=p.displayName||''}}
function saveAdminProfile(){const email=document.getElementById('adminEmailField').value.trim(),mobile=document.getElementById('adminMobile').value.trim(),name=document.getElementById('adminDispName').value.trim(),err=document.getElementById('profErr'),suc=document.getElementById('profSuc');err.style.display='none';suc.style.display='none';if(!email){err.textContent='Email is required';err.style.display='block';return}const data={email:email,mobile:mobile,displayName:name,updatedAt:new Date().toISOString()};if(db){db.collection('settings').doc('admin_profile').set(data,{merge:true}).then(()=>{localStorage.setItem('st_admin_profile',JSON.stringify(data));suc.textContent='Profile saved!';suc.style.display='block'}).catch(e=>{localStorage.setItem('st_admin_profile',JSON.stringify(data));suc.textContent='Saved locally (DB unavailable)';suc.style.display='block'})}else{localStorage.setItem('st_admin_profile',JSON.stringify(data));suc.textContent='Profile saved!';suc.style.display='block'}}

// ===== INIT =====
loadMemLS();
try{document.getElementById('nDate').value=new Date().toISOString().split('T')[0]}catch(e){}
// Restore resident session
try{const sr=localStorage.getItem('st_resident_user');if(sr){residentUser=JSON.parse(sr)}}catch(e){}
loadProjects();updateEscBadge();
// Restore BOM session (localStorage fallback when Firebase not enabled)
try{const bs=localStorage.getItem('st_bom_session');if(bs&&!auth){const sess=JSON.parse(bs);currentUser={email:sess.email};isAdmin=sess.email===ADMIN_EMAIL;updateUI();
// Auto-skip splash and go to BOM
hideSplash();switchTab('bom')}}catch(e){}
</script>
</body>
</html>
