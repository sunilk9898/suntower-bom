<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sun Tower RWA - Residents Welfare Association</title>
<meta name="description" content="Sun Tower Residents Welfare Association, Shipra Sun City, Indirapuram, Ghaziabad">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="stylesheet" href="css/style.css?v=20260222b">
<!-- Firebase disabled — auth via Supabase Auth (JWT + RLS) -->
<!-- <script src="js/firebase-config.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-config.js?v=20260222b"></script>
<script src="js/audit.js?v=20260222b"></script>
<script src="js/auth.js?v=20260222b"></script>
<script src="js/data.js?v=20260222b"></script>
</head>
<body>

<!-- SPLASH SCREEN -->
<div class="splash" id="splashScreen">
  <div class="splash-logo">
    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="50" cy="22" r="14" fill="#fff3e0"/>
      <line x1="50" y1="2" x2="50" y2="8" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="50" y1="36" x2="50" y2="42" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="30" y1="22" x2="36" y2="22" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="64" y1="22" x2="70" y2="22" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="36" y1="8" x2="40" y2="12" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="60" y1="32" x2="64" y2="36" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="64" y1="8" x2="60" y2="12" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <line x1="40" y1="32" x2="36" y2="36" stroke="#fff3e0" stroke-width="3" stroke-linecap="round"/>
      <rect x="30" y="42" width="40" height="50" rx="3" fill="#fff" opacity="0.95"/>
      <rect x="35" y="48" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="47" y="48" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="59" y="48" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="35" y="60" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="47" y="60" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="59" y="60" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="35" y="72" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="47" y="72" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="59" y="72" width="8" height="8" rx="1" fill="#1a237e" opacity="0.7"/>
      <rect x="44" y="82" width="12" height="12" rx="2" fill="#ff6f00"/>
    </svg>
  </div>
  <div class="splash-title" data-edit="splash_title">SUN TOWER</div>
  <div class="splash-subtitle" data-edit="splash_subtitle">Residents Welfare Association (SRWA)</div>
  <div class="splash-address" data-edit="splash_address">Block 'A2', Shipra Sun City, Indirapuram, Ghaziabad - 201014</div>
  <div class="splash-contact" data-edit="splash_contact">suntowershipra@gmail.com | 0120-4311286 | Ext: 5000</div>
  <div class="splash-buttons">
    <button class="splash-btn splash-btn-bom" onclick="enterBOM()" data-edit="splash_btn_bom">BOM Internal</button>
    <button class="splash-btn splash-btn-resident" onclick="enterResident()" data-edit="splash_btn_resident">Resident Portal</button>
  </div>
  <div class="splash-footer" data-edit="splash_footer">Board of Management 2025-26 | Election held 01 Feb 2026 | 174 Voters</div>
</div>

<!-- AUTH LOGIN -->
<div class="auth-overlay hidden" id="authOverlay">
  <div class="auth-card">
    <div class="auth-logo"><div style="display:inline-flex;width:60px;height:60px;background:linear-gradient(135deg,#ff6f00,#ff8f00);border-radius:14px;align-items:center;justify-content:center;"><svg viewBox="0 0 100 100" width="36" height="36" fill="none"><circle cx="50" cy="22" r="12" fill="#fff3e0"/><rect x="32" y="42" width="36" height="46" rx="3" fill="#fff" opacity="0.95"/><rect x="45" y="78" width="10" height="10" rx="2" fill="#ff6f00"/></svg></div></div>
    <div id="loginForm">
      <h2>BOM Login</h2>
      <p class="auth-sub">Authorized Access Only</p>
      <div class="auth-error" id="loginError"></div>
      <div class="auth-success" id="loginSuccess"></div>
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="loginEmail" placeholder="your.email@example.com"></div>
      <div class="form-group"><label>Password</label><input type="password" class="form-control" id="loginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')doLogin()"></div>
      <button class="btn btn-primary btn-lg" style="width:100%" onclick="doLogin()">Login</button>
      <div class="auth-link" onclick="showForgotPw()">Forgot Password?</div>
      <div class="auth-link" onclick="hideAuth()">Back to Home</div>
    </div>
    <div id="forgotForm" style="display:none">
      <h2>Reset Password</h2>
      <p class="auth-sub">Enter registered email for reset link</p>
      <div class="auth-error" id="forgotError"></div>
      <div class="auth-success" id="forgotSuccess"></div>
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="forgotEmail" placeholder="your.email@example.com"></div>
      <button class="btn btn-primary btn-lg" style="width:100%" onclick="doForgotPw()">Send Reset Link</button>
      <div class="auth-link" onclick="showLoginFm()">Back to Login</div>
    </div>
  </div>
</div>

<!-- RESIDENT AUTH OVERLAY -->
<div class="auth-overlay hidden" id="residentAuthOverlay">
  <div class="auth-card" style="max-width:460px">
    <div class="auth-logo"><div style="display:inline-flex;width:60px;height:60px;background:linear-gradient(135deg,#00695c,#00897b);border-radius:14px;align-items:center;justify-content:center;"><svg viewBox="0 0 100 100" width="36" height="36" fill="none"><circle cx="50" cy="22" r="12" fill="#fff3e0"/><rect x="32" y="42" width="36" height="46" rx="3" fill="#fff" opacity="0.95"/><rect x="45" y="78" width="10" height="10" rx="2" fill="#00695c"/></svg></div></div>

    <!-- Resident Login -->
    <div id="resLoginForm">
      <h2 style="color:#00695c">Resident Login</h2>
      <p class="auth-sub">Registered flat owners only</p>
      <div class="auth-error" id="resLoginError"></div>
      <div class="auth-success" id="resLoginSuccess"></div>
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="resLoginEmail" placeholder="your.email@example.com"></div>
      <div class="form-group"><label>Flat Number</label><input type="text" class="form-control" id="resLoginFlat" placeholder="e.g. STD-701, STC-504" style="text-transform:uppercase"><p style="font-size:0.72rem;color:#999;margin-top:3px">Required for first login on a new device</p></div>
      <div class="form-group"><label>Password</label><input type="password" class="form-control" id="resLoginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')doResidentLogin()"></div>
      <button class="btn btn-lg" style="width:100%;background:#00695c;color:#fff" onclick="doResidentLogin()">Login</button>
      <div class="auth-link" onclick="showResForgotPw()">Forgot Password?</div>
      <div style="text-align:center;margin-top:15px;padding-top:15px;border-top:1px solid #e0e0e0">
        <p style="color:#666;font-size:0.85rem;margin-bottom:10px">Not registered yet?</p>
        <button class="btn btn-secondary" style="width:100%" onclick="showResRegForm()">Request Registration</button>
      </div>
      <div class="auth-link" onclick="hideResidentAuth()">Back to Home</div>
    </div>

    <!-- Resident Registration Request -->
    <div id="resRegForm" style="display:none">
      <h2 style="color:#00695c">Request Registration</h2>
      <p class="auth-sub">Submit your details for admin verification</p>
      <div class="auth-error" id="resRegError"></div>
      <div class="auth-success" id="resRegSuccess"></div>
      <div class="form-group"><label>Flat Owner Name *</label><input type="text" class="form-control" id="regOwnerName" placeholder="e.g. Sh. Sunil Kumar"></div>
      <div class="form-group"><label>Flat Number *</label><input type="text" class="form-control" id="regFlatNo" placeholder="e.g. STC-504, STD-701"></div>
      <div class="form-group"><label>Mobile Number *</label><input type="tel" class="form-control" id="regMobile" placeholder="e.g. 9876543210"></div>
      <div class="form-group"><label>Email ID *</label><input type="email" class="form-control" id="regEmail" placeholder="your.email@example.com"></div>
      <button class="btn btn-lg" style="width:100%;background:#00695c;color:#fff" onclick="submitResidentReg()">Submit Registration Request</button>
      <div class="auth-link" onclick="showResLoginForm()">Already registered? Login</div>
      <div class="auth-link" onclick="hideResidentAuth()">Back to Home</div>
    </div>

    <!-- Resident Forgot Password (OTP) -->
    <div id="resForgotForm" style="display:none">
      <h2 style="color:#00695c">Reset Password</h2>
      <p class="auth-sub">OTP will be sent to your registered email</p>
      <div class="auth-error" id="resForgotError"></div>
      <div class="auth-success" id="resForgotSuccess"></div>
      <div id="resForgotStep1">
        <div class="form-group"><label>Registered Email</label><input type="email" class="form-control" id="resForgotEmail" placeholder="your.email@example.com"></div>
        <button class="btn btn-lg" style="width:100%;background:#00695c;color:#fff" onclick="sendResidentOTP()">Send OTP</button>
      </div>
      <div id="resForgotStep2" style="display:none">
        <div class="form-group"><label>Enter OTP (sent to email)</label><input type="text" class="form-control" id="resOtpInput" placeholder="6-digit OTP" maxlength="6" style="text-align:center;font-size:1.3rem;letter-spacing:8px"></div>
        <div class="form-group"><label>New Password (min 6 chars)</label><input type="password" class="form-control" id="resNewPass" placeholder="Enter new password"></div>
        <div class="form-group"><label>Confirm Password</label><input type="password" class="form-control" id="resConfirmPass" placeholder="Re-enter new password"></div>
        <button class="btn btn-lg" style="width:100%;background:#00695c;color:#fff" onclick="verifyOTPResetPass()">Verify OTP & Reset Password</button>
      </div>
      <div class="auth-link" onclick="showResLoginForm()">Back to Login</div>
    </div>
  </div>
</div>

<!-- HEADER -->
<div class="site-header" id="siteHeader" style="display:none;">
  <div class="logo-sm" onclick="goHome()"><svg viewBox="0 0 100 100" width="24" height="24" fill="none"><circle cx="50" cy="22" r="12" fill="#fff3e0"/><rect x="32" y="42" width="36" height="46" rx="3" fill="#fff" opacity="0.95"/><rect x="45" y="78" width="10" height="10" rx="2" fill="#ff6f00"/></svg></div>
  <div class="header-text"><div class="header-title" data-edit="header_title">SUN TOWER RWA</div><div class="header-sub" data-edit="header_sub">Block A2, Shipra Sun City, Indirapuram | BOM 2025-26</div></div>
  <div class="header-right"><span class="header-user" id="headerUser"></span><button class="header-btn" id="headerAuthBtn" onclick="toggleAuthBtn()">Login</button></div>
</div>

<!-- MAIN TABS -->
<div class="main-tabs" id="mainTabs" style="display:none;">
  <button class="main-tab" onclick="switchTab('bom')" id="tabBom" style="display:none"><span class="lock-icon">&#128274;</span> BOM Internal</button>
  <button class="main-tab active" onclick="switchTab('resident')" id="tabResident">&#127968; Resident Portal</button>
  <button class="main-tab" onclick="switchTab('policy')" id="tabPolicy" style="display:none">Policies &amp; SOP</button>
  <button class="main-tab" onclick="switchTab('notices')" id="tabNotices" style="display:none">Notice Board <span id="escalationBadge" style="display:none;background:#b71c1c;color:#fff;font-size:0.65rem;padding:1px 6px;border-radius:10px;margin-left:4px"></span></button>
</div>

<!-- BOM SUB-NAV -->
<div class="sub-nav" id="bomSubNav" style="display:none;">
  <a href="#" onclick="showBom('election');return false" class="active" id="bn_election">Election</a>
  <a href="#" onclick="showBom('members');return false" id="bn_members">Members</a>
  <a href="#" onclick="showBom('challenges');return false" id="bn_challenges">Challenges</a>
  <a href="#" onclick="showBom('committees');return false" id="bn_committees">Committees</a>
  <a href="#" onclick="showBom('allocate');return false" id="bn_allocate">Allocate</a>
  <a href="#" onclick="showBom('dashboard');return false" id="bn_dashboard">Dashboard</a>
  <a href="#" onclick="showBom('projects');return false" id="bn_projects">Projects</a>
  <a href="#" onclick="showBom('directory');return false" id="bn_directory" style="background:#00695c;color:#fff;">&#128269; Directory</a>
  <a href="#" onclick="showBom('admin');return false" id="bn_admin" style="background:#b71c1c;color:#fff;">Admin</a>
</div>

<!-- ================ TAB: BOM INTERNAL ================ -->
<div class="page" id="page_bom">
  <div id="bomLocked" style="text-align:center;padding:100px 20px;">
    <div style="font-size:4rem;margin-bottom:15px;">&#128274;</div>
    <h2 style="color:var(--primary);margin-bottom:10px;" data-edit="bom_locked_title">BOM Internal - Restricted Access</h2>
    <p style="color:var(--text-light);margin-bottom:20px;" data-edit="bom_locked_text">Only authorized Board of Management members can access this section.</p>
    <button class="btn btn-primary btn-lg" onclick="showAuth()">Login to Continue</button>
  </div>
  <div id="bomContent" style="display:none;">

    <!-- Election Results -->
    <div class="bom-sec" id="bs_election">
      <h2 class="page-title" data-edit="bom_election_title">Election Results - 01 February 2026</h2>
      <div class="grid-2">
        <div class="card" style="border-left-color:var(--success)"><h3>Election Summary</h3>
          <table><tr><td><strong>Date</strong></td><td>01 Feb 2026</td></tr><tr><td><strong>Voter Turnout</strong></td><td><strong style="color:var(--success);font-size:1.2rem">174</strong></td></tr><tr><td><strong>Valid Ballots</strong></td><td>168 (6 rejected)</td></tr><tr><td><strong>Candidates</strong></td><td>12</td></tr><tr><td><strong>Seats</strong></td><td>10</td></tr></table>
        </div>
        <div class="card" style="border-left-color:var(--primary)"><h3>Highlights</h3>
          <ul><li>Top candidate: <strong>129 votes</strong> (76.8%)</li><li>Only 23-vote gap between rank 1 and 10</li><li>All 10 members have strong mandate</li><li>STC: 6 members, STD: 3, STB: 1</li></ul>
        </div>
      </div>
      <div class="card"><h3>Elected BOM Members</h3>
        <table><tr><th>#</th><th>Name</th><th>Flat</th><th>Votes</th><th>Position</th></tr></table>
        <table id="electionTable"><tr><th>#</th><th>Name</th><th>Flat</th><th>Votes</th><th>Position</th></tr></table>
      </div>
    </div>

    <!-- Members -->
    <div class="bom-sec" id="bs_members" style="display:none">
      <h2 class="page-title" data-edit="bom_members_title">BOM Members Registration</h2>
      <p class="page-subtitle" data-edit="bom_members_subtitle">Only Admin can edit. Data saved to database (persists across browsers).</p>
      <div id="memberAdminLock" style="display:none"><div class="card" style="border-left-color:var(--warning);text-align:center"><p><strong>View Only</strong> - Contact Admin to make changes.</p></div></div>
      <div class="member-form" id="memberForm"></div>
      <div class="action-bar" id="memberActions"><button class="btn btn-primary" onclick="saveMembers()">Save to Database</button><button class="btn btn-secondary" onclick="loadElected()">Load Elected Members</button></div>
    </div>

    <!-- Challenges -->
    <div class="bom-sec" id="bs_challenges" style="display:none">
      <h2 class="page-title" data-edit="bom_challenges_title">Challenges & Responsibilities</h2>
      <div id="challengesArea"></div>
    </div>

    <!-- Committees -->
    <div class="bom-sec" id="bs_committees" style="display:none">
      <h2 class="page-title" data-edit="bom_committees_title">7 Working Committees</h2>
      <p class="page-subtitle" data-edit="bom_committees_subtitle">Each: 2 BOM + 3 Resident volunteers</p>
      <div class="action-bar" id="commActions" style="display:none"><button class="btn btn-primary" onclick="saveCommitteesUI()">Save Committee Assignments</button></div>
      <div id="committeesArea"></div>
    </div>

    <!-- Allocate -->
    <div class="bom-sec" id="bs_allocate" style="display:none">
      <h2 class="page-title" data-edit="bom_allocate_title">Task Allocation</h2>
      <div class="action-bar"><button class="btn btn-primary" onclick="autoAssign()">Auto-Assign</button><button class="btn btn-secondary" onclick="clearAssign()">Clear</button></div>
      <div id="allocArea"></div>
    </div>

    <!-- Dashboard -->
    <div class="bom-sec" id="bs_dashboard" style="display:none">
      <h2 class="page-title" data-edit="bom_dashboard_title">Dashboard</h2>
      <div class="action-bar"><button class="btn btn-primary" onclick="genDash()">Refresh</button><button class="btn btn-success" onclick="exportCSV()">Export CSV</button></div>
      <div id="dashArea"></div><div id="chartArea"></div>
    </div>

    <!-- Projects -->
    <div class="bom-sec" id="bs_projects" style="display:none">
      <h2 class="page-title">Project Management Dashboard</h2>
      <p class="page-subtitle">AI-powered monitoring of all society projects across committees</p>
      <div id="projStatsBar"></div>
      <div id="projFilterBar"></div>
      <div id="projCreateArea"></div>
      <div id="projDashArea"></div>
      <div id="aiInsightsArea"></div>
    </div>

    <!-- Resident Directory -->
    <div class="bom-sec" id="bs_directory" style="display:none">
      <h2 class="page-title">&#128269; Resident Directory</h2>
      <p class="page-subtitle">Search Sun Tower residents by name, flat number, or tower</p>
      <div class="directory-search-bar">
        <input type="text" class="form-control" id="dirSearchInput" placeholder="Search by name, flat number, or tower..." oninput="searchDirectory()" style="font-size:1rem;padding:12px 16px">
        <div class="directory-filters">
          <select class="form-control" id="dirTowerFilter" onchange="searchDirectory()">
            <option value="">All Towers</option>
            <option value="STA1">STA1</option><option value="STA2">STA2</option>
            <option value="STB1">STB1</option><option value="STB2">STB2</option>
            <option value="STC1">STC1</option><option value="STC2">STC2</option>
            <option value="STD1">STD1</option><option value="STD2">STD2</option>
          </select>
          <select class="form-control" id="dirTypeFilter" onchange="searchDirectory()">
            <option value="">All Types</option>
            <option value="Owner">Owner</option>
            <option value="Tenant">Tenant</option>
            <option value="Owner Family">Owner Family</option>
            <option value="Tenant Family">Tenant Family</option>
          </select>
          <select class="form-control" id="dirStatusFilter" onchange="searchDirectory()">
            <option value="">All Status</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>
      </div>
      <div class="directory-stats" id="dirStats"></div>
      <div id="dirResults" style="margin-top:15px"></div>
    </div>

    <!-- Admin -->
    <div class="bom-sec" id="bs_admin" style="display:none">
      <h2 class="page-title" data-edit="bom_admin_title">Admin Panel</h2>
      <div id="adminLock"><p style="color:var(--danger);font-weight:600;text-align:center;padding:40px">Admin access required (suntowershipra@gmail.com)</p></div>
      <div id="adminPanel" style="display:none">
        <div class="admin-section"><h3>&#128100; Create BOM Account</h3>
          <div class="grid-2"><div class="form-group"><label>Member</label><select class="form-control" id="accName"></select></div><div class="form-group"><label>Email</label><input type="email" class="form-control" id="accEmail" placeholder="member@email.com"></div></div>
          <div class="form-group"><label>Temp Password (min 6)</label><input type="text" class="form-control" id="accPass" placeholder="temporary123"></div>
          <button class="btn btn-primary" onclick="createAccount()">Create Account</button>
          <div class="auth-error" id="accErr" style="margin-top:10px"></div>
          <div id="accSuccessCard" style="margin-top:10px"></div>
        </div>
        <div class="admin-section" style="border-color:var(--primary);background:#e8eaf6"><h3 style="color:var(--primary);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">&#128100; BOM Accounts <span><button class="btn btn-sm" style="background:#00695c;color:#fff;font-size:0.75rem;margin-right:6px" onclick="syncAllAccountsToAuth()" title="Create Supabase Auth users for all BOM + Resident accounts that don't have one yet">&#128260; Sync to Auth</button><button class="btn btn-sm" style="background:var(--primary);color:#fff;font-size:0.75rem" onclick="buildAccountList()">&#8635; Refresh</button></span></h3><div id="syncStatus" style="display:none;padding:8px 12px;margin-bottom:10px;border-radius:8px;font-size:0.85rem"></div>
          <div id="acctDashArea"></div>
        </div>
        <div class="admin-section"><h3>&#128196; Upload Notice</h3>
          <div class="form-group"><label>Title</label><input type="text" class="form-control" id="nTitle"></div>
          <div class="form-group"><label>Summary</label><textarea class="form-control" id="nSummary"></textarea></div>
          <div class="grid-2"><div class="form-group"><label>Category</label><select class="form-control" id="nCat"><option>General</option><option>Financial</option><option>Maintenance</option><option>Event</option><option>Emergency</option><option>Meeting</option></select></div><div class="form-group"><label>Date</label><input type="date" class="form-control" id="nDate"></div></div>
          <div class="form-group"><label>File (PDF/Image)</label><input type="file" class="form-control" id="nFile" accept=".pdf,.jpg,.jpeg,.png"></div>
          <button class="btn btn-success" onclick="uploadNotice()">Upload</button>
          <div class="auth-success" id="nSuc" style="margin-top:10px"></div>
        </div>
        <div class="admin-section" style="border-color:#00695c;background:#e0f2f1"><h3 style="color:#00695c;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">&#128101; Resident Registration Requests <button class="btn btn-sm" style="background:#00695c;color:#fff;font-size:0.75rem" onclick="loadRegRequests();loadApprovedResidents()">&#8635; Refresh</button></h3>
          <div id="regRequestsArea"><p style="color:var(--text-light)">Loading...</p></div>
        </div>
        <div class="admin-section" style="border-color:#004d40;background:#e0f2f1"><h3 style="color:#004d40">&#9989; Approved Residents</h3>
          <div id="approvedResidentsArea"><p style="color:var(--text-light)">Loading...</p></div>
        </div>
        <div class="admin-section" style="border-color:#1565c0;background:#e3f2fd"><h3 style="color:#1565c0;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">&#128221; Manage Resident Data <button class="btn btn-sm" style="background:#1565c0;color:#fff;font-size:0.75rem" onclick="loadManageResidents()">&#8635; Refresh</button></h3>
          <p style="font-size:0.82rem;color:#555;margin-bottom:12px">Add, edit, or search resident records. Changes sync to Supabase profiles.</p>
          <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap">
            <button class="btn btn-sm" style="background:#1565c0;color:#fff" onclick="showAddResidentForm()">&#10133; Add Resident</button>
            <input type="text" class="form-control" id="mgrSearchInput" placeholder="Search by name, flat, email, tower..." oninput="filterManagedResidents()" style="flex:1;min-width:200px;padding:8px 12px;font-size:0.85rem">
            <select class="form-control" id="mgrTowerFilter" onchange="filterManagedResidents()" style="width:auto;padding:8px 12px;font-size:0.85rem">
              <option value="">All Towers</option>
              <option>STA1</option><option>STA2</option><option>STB1</option><option>STB2</option>
              <option>STC1</option><option>STC2</option><option>STD1</option><option>STD2</option>
            </select>
          </div>
          <div id="addResidentFormArea" style="display:none"></div>
          <div id="editResidentFormArea" style="display:none"></div>
          <div id="mgrResidentsStats" style="margin-bottom:12px"></div>
          <div id="mgrResidentsArea"><p style="color:var(--text-light)">Loading...</p></div>
        </div>
        <div class="admin-section"><h3>&#128172; Resident Messages</h3><div id="adminMsgs"><p style="color:var(--text-light)">Loading...</p></div></div>
        <div class="admin-section" style="border-color:#b71c1c;background:#fce4ec"><h3 style="color:#b71c1c;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">&#128270; Security Audit Log <button class="btn btn-sm" style="background:#b71c1c;color:#fff;font-size:0.75rem" onclick="SunAudit.buildAuditViewer('auditLogArea')">&#8635; Load Audit Log</button></h3>
          <div id="auditLogArea"><p style="color:#999;text-align:center;padding:15px">Click "Load Audit Log" to view security events.</p></div>
        </div>
        <div class="admin-section" style="border-color:#1a237e;background:#e8eaf6"><h3 style="color:var(--primary)">&#9881; Admin Settings</h3>
          <div class="grid-2">
            <div style="background:#fff;padding:15px;border-radius:10px">
              <h4 style="color:var(--primary);margin-bottom:12px">&#128274; Change Admin Password</h4>
              <div class="form-group"><label>Current Password</label><input type="password" class="form-control" id="curPass" placeholder="Enter current password"></div>
              <div class="form-group"><label>New Password (min 6 chars)</label><input type="password" class="form-control" id="newPass" placeholder="Enter new password"></div>
              <div class="form-group"><label>Confirm New Password</label><input type="password" class="form-control" id="cfmPass" placeholder="Re-enter new password"></div>
              <button class="btn btn-primary" onclick="changeAdminPass()">Update Password</button>
              <div class="auth-error" id="passErr" style="margin-top:10px"></div>
              <div class="auth-success" id="passSuc" style="margin-top:10px"></div>
            </div>
            <div style="background:#fff;padding:15px;border-radius:10px">
              <h4 style="color:var(--primary);margin-bottom:12px">&#128100; Admin Profile</h4>
              <div class="form-group"><label>Admin Email</label><input type="email" class="form-control" id="adminEmailField" placeholder="admin@email.com"></div>
              <div class="form-group"><label>Admin Mobile No.</label><input type="tel" class="form-control" id="adminMobile" placeholder="e.g. 9876543210"></div>
              <div class="form-group"><label>Admin Display Name</label><input type="text" class="form-control" id="adminDispName" placeholder="e.g. Sunil Kumar"></div>
              <button class="btn btn-success" onclick="saveAdminProfile()">Save Profile</button>
              <div class="auth-error" id="profErr" style="margin-top:10px"></div>
              <div class="auth-success" id="profSuc" style="margin-top:10px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================ TAB: RESIDENT PORTAL ================ -->
<div class="page" id="page_resident">
  <div id="residentLocked" style="text-align:center;padding:80px 20px;">
    <div style="font-size:4rem;margin-bottom:15px;">&#127968;</div>
    <h2 style="color:#00695c;margin-bottom:10px;">Resident Portal - Login Required</h2>
    <p style="color:var(--text-light);margin-bottom:8px;">Only registered and verified flat owners can access this section.</p>
    <p style="color:var(--text-light);margin-bottom:25px;font-size:0.85rem">New residents can request registration below.</p>
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-lg" style="background:#00695c;color:#fff" onclick="showResidentAuth('login')">Resident Login</button>
      <button class="btn btn-lg btn-secondary" onclick="showResidentAuth('register')">Request Registration</button>
    </div>
  </div>
  <div id="residentContent" style="display:none">
  <div id="residentWelcome" style="background:linear-gradient(135deg,#e0f2f1,#b2dfdb);border-radius:12px;padding:15px 20px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div><span style="font-size:1.1rem;font-weight:700;color:#00695c">Welcome, </span><span id="residentNameDisplay" style="font-weight:700;color:#004d40"></span><span id="residentFlatDisplay" style="color:#666;margin-left:8px;font-size:0.85rem"></span></div>
    <button class="btn btn-sm" style="background:#00695c;color:#fff" onclick="doResidentLogout()">Logout</button>
  </div>
  <h2 class="page-title" data-edit="resident_title">Welcome to Sun Tower</h2>
  <p class="page-subtitle" data-edit="resident_subtitle">Stay informed and connected with your community</p>
  <div class="card" style="border-left-color:var(--success);background:linear-gradient(135deg,#e8f5e9,#c8e6c9)"><h3 style="color:var(--success)" data-edit="resident_announcement_title">New BOM Elected - February 2026</h3><p data-edit="resident_announcement_text">10 newly elected BOM members are committed to transparency and community improvement.</p></div>
  <h3 style="color:var(--primary);margin:25px 0 15px">Information & Services</h3>
  <div class="feature-grid">
    <div class="feature-card" onclick="toggleRsec('bominfo')"><div class="feature-icon">&#127963;</div><h4>BOM Members</h4><p>Your elected representatives</p></div>
    <div class="feature-card" onclick="toggleRsec('projects')"><div class="feature-icon">&#128679;</div><h4>Project Tracker</h4><p>Infrastructure & development updates</p></div>
    <div class="feature-card" onclick="toggleRsec('vendors')"><div class="feature-icon">&#129309;</div><h4>Vendors</h4><p>Active service providers</p></div>
    <div class="feature-card" onclick="toggleRsec('complaints')"><div class="feature-icon">&#128220;</div><h4>Complaint / Suggestion</h4><p>Submit your feedback</p></div>
    <div class="feature-card" onclick="toggleRsec('emergency')"><div class="feature-icon">&#127973;</div><h4>Emergency Contacts</h4><p>Security, Fire, Medical</p></div>
    <div class="feature-card" onclick="toggleRsec('rules')"><div class="feature-icon">&#128214;</div><h4>Society Rules</h4><p>Guidelines for residents</p></div>
    <div class="feature-card" onclick="toggleRsec('faq')"><div class="feature-icon">&#128161;</div><h4>FAQ</h4><p>Common questions answered</p></div>
    <div class="feature-card" onclick="switchTab('policy')"><div class="feature-icon">&#128209;</div><h4>Expense Policy</h4><p>GBM-approved SOP</p></div>
  </div>
  <div id="residentSecs">
    <div id="rs_bominfo" style="display:none;margin-top:20px"><div class="card"><h3>Elected BOM Members</h3><table id="resElectionTable"></table></div></div>
    <div id="rs_projects" style="display:none;margin-top:20px"><div class="card"><h3>Project Tracker</h3><div id="resProjectList"></div></div></div>
    <div id="rs_vendors" style="display:none;margin-top:20px"><div class="card"><h3>Vendor Directory</h3><table><tr><th>Vendor</th><th>Service</th><th>Staff</th></tr><tr><td><strong>PANZEER</strong></td><td>Security</td><td>23 Guards + 2 Sup</td></tr><tr><td><strong>SHINEBURG</strong></td><td>Housekeeping</td><td>11 Help + 1 Sup</td></tr><tr><td><strong>SKENTERPRISE</strong></td><td>Fire Systems</td><td>AMC</td></tr><tr><td><strong>KONE</strong></td><td>Lift AMC</td><td>AMC</td></tr></table></div></div>
    <div id="rs_complaints" style="display:none;margin-top:20px"><div class="card"><h3>Submit Complaint / Suggestion</h3><div class="form-group"><label>Name</label><input type="text" class="form-control" id="cName"></div><div class="form-group"><label>Flat</label><input type="text" class="form-control" id="cFlat" placeholder="e.g. STC-504"></div><div class="form-group"><label>Category</label><select class="form-control" id="cCat"><option>Maintenance</option><option>Security</option><option>Housekeeping</option><option>Parking</option><option>Noise</option><option>Suggestion</option><option>Other</option></select></div><div class="form-group"><label>Description</label><textarea class="form-control" id="cDesc"></textarea></div><button class="btn btn-primary" onclick="submitComp()">Submit</button><div class="auth-success" id="cSuc" style="margin-top:10px"></div></div></div>
    <div id="rs_emergency" style="display:none;margin-top:20px"><div class="card"><h3>Emergency Contacts</h3><div class="grid-2" style="margin-top:10px"><div class="contact-card"><div class="contact-icon" style="background:#b71c1c">&#128694;</div><div><strong>Security</strong><br>0120-4311286 Ext:5000</div></div><div class="contact-card"><div class="contact-icon" style="background:#e65100">&#128293;</div><div><strong>Fire</strong><br>101</div></div><div class="contact-card"><div class="contact-icon" style="background:#1a237e">&#128658;</div><div><strong>Police</strong><br>100 / 112</div></div><div class="contact-card"><div class="contact-icon" style="background:#004d40">&#127973;</div><div><strong>Ambulance</strong><br>108</div></div></div></div></div>
    <div id="rs_rules" style="display:none;margin-top:20px"><div class="card"><h3>Society Rules</h3><ul><li><strong>Parking:</strong> Only Park Plus sticker vehicles in basement</li><li><strong>Renovation:</strong> Prior BOM permission. Hours: 9AM-6PM Mon-Sat</li><li><strong>Pets:</strong> Leashed in common areas. Clean up after pet</li><li><strong>Noise:</strong> No loud music after 9PM</li><li><strong>Dues:</strong> Pay by 10th. Late fee after 15th</li><li><strong>Visitors:</strong> Register at gate</li></ul></div></div>
    <div id="rs_faq" style="display:none;margin-top:20px"><div class="card"><h3>FAQ</h3><div style="margin-bottom:12px"><strong>Q: How to pay maintenance?</strong><br>A: MyGate app or bank transfer. Details at security office.</div><div style="margin-bottom:12px"><strong>Q: How to book Club House?</strong><br>A: Contact BOM office. Charges & deposit apply.</div><div style="margin-bottom:12px"><strong>Q: Park Plus sticker?</strong><br>A: Visit security with car registration docs.</div><div style="margin-bottom:12px"><strong>Q: Report maintenance issue?</strong><br>A: Use Complaint form here, MyGate, or call security.</div></div></div>
  </div>
  </div>
</div>

<!-- ================ TAB: POLICY & SOP ================ -->
<div class="page" id="page_policy">
  <h2 class="page-title" data-edit="policy_title">Policies & Standard Operating Procedures</h2>
  <div class="card" style="border-left-color:var(--success);background:linear-gradient(135deg,#e8f5e9,#c8e6c9);margin-bottom:25px"><h3 style="color:var(--success)" data-edit="policy_gbm_title">Approved by General Body Meeting</h3><p data-edit="policy_gbm_text">These policies are binding on the Board of Management.</p></div>
  <div class="policy-section"><h3><div class="policy-icon" style="background:var(--primary)">&#128209;</div> Works & Project Approvals Policy</h3><p class="page-subtitle">Ref: UP Apartment Act, 2010 & Model Bye-laws</p></div>
  <div class="card"><h3>1. Purpose & Scope</h3><ul style="margin-top:10px"><li>Legal compliance with UP Apartment Act</li><li>Timely execution of emergency works</li><li>Financial prudence & transparent decision-making</li><li>Cost thresholds for Board self-approvals</li></ul></div>
  <div class="card"><h3>2. Project Classification</h3><div class="grid-3" style="margin-top:12px"><div style="background:#ffebee;padding:15px;border-radius:10px;text-align:center"><div style="font-size:2rem">&#9888;</div><h4 style="color:#b71c1c">Emergency Repairs</h4><p style="font-size:0.82rem;color:var(--text-light)">Risk to life/property. Burst water line, electrical hazard, structural damage.</p></div><div style="background:#e3f2fd;padding:15px;border-radius:10px;text-align:center"><div style="font-size:2rem">&#128736;</div><h4 style="color:#0d47a1">Upgradation</h4><p style="font-size:0.82rem;color:var(--text-light)">CCTV, PBX, pipe repairs, landscaping, equipment.</p></div><div style="background:#e8f5e9;padding:15px;border-radius:10px;text-align:center"><div style="font-size:2rem">&#127959;</div><h4 style="color:#1b5e20">Capital Works</h4><p style="font-size:0.82rem;color:var(--text-light)">Major renovations, lift, swimming pool, structural changes.</p></div></div></div>
  <div class="card"><h3>3. Cost Thresholds & Approval</h3><div class="grid-2" style="margin-top:12px"><div class="threshold-card" style="border-left-color:#b71c1c"><span class="badge badge-danger" style="font-size:0.7rem">Emergency</span><h4>Up to Rs. 50,000</h4><div class="threshold-amount">BOM Approval</div><div class="threshold-auth">Recorded in RWA register</div></div><div class="threshold-card" style="border-left-color:#e65100"><span class="badge badge-danger" style="font-size:0.7rem">Emergency</span><h4>Rs. 50K - 1 Lakh</h4><div class="threshold-amount">BOM Majority</div><div class="threshold-auth">Recorded in MoM register</div></div><div class="threshold-card" style="border-left-color:#c62828"><span class="badge badge-danger" style="font-size:0.7rem">Emergency</span><h4>Above Rs. 1 Lakh</h4><div class="threshold-amount">BOM + GBM</div><div class="threshold-auth">BOM majority + GBM cost approval</div></div><div class="threshold-card" style="border-left-color:#0d47a1"><span class="badge badge-info" style="font-size:0.7rem">Upgradation</span><h4>Up to Rs. 1 Lakh</h4><div class="threshold-amount">Prior GBM</div><div class="threshold-auth">Cost estimates + GBM video recording</div></div></div><div class="threshold-card" style="border-left-color:#1b5e20;margin-top:12px"><span class="badge badge-success" style="font-size:0.7rem">Capital Works</span><h4>Any Cost</h4><div class="threshold-amount">Full GBM + Resident Committee</div><div class="threshold-auth">WhatsApp/MyGate notice + committee + video recording. Fund: Infra/SEL/FD</div></div></div>
  <div class="card"><h3>4. Process Flow</h3><div class="process-flow" style="margin-top:12px"><div class="process-step" style="border-top:4px solid #1a237e"><div style="font-size:1.5rem">&#128221;</div><h5>Proposal</h5><p>Scope & cost estimate</p></div><div class="process-arrow">&#10132;</div><div class="process-step" style="border-top:4px solid #ff6f00"><div style="font-size:1.5rem">&#9989;</div><h5>Approval</h5><p>Per thresholds. Signed by President, GS & Treasurer</p></div><div class="process-arrow">&#10132;</div><div class="process-step" style="border-top:4px solid #2e7d32"><div style="font-size:1.5rem">&#128736;</div><h5>Execution</h5><p>2 quotes (<1L), 3 quotes (>=1L). Penalty clauses</p></div><div class="process-arrow">&#10132;</div><div class="process-step" style="border-top:4px solid #004d40"><div style="font-size:1.5rem">&#127937;</div><h5>Completion</h5><p>Report to residents & notice board</p></div></div></div>
  <div class="grid-2"><div class="card"><h3>5. Communication</h3><ul><li>Advance notice for planned works</li><li>Updates via WhatsApp, Notice Board, MyGate</li><li>Emergency: immediate post-action communication</li></ul></div><div class="card"><h3>6. Accountability</h3><ul><li>Policy binding once GBM-adopted</li><li>Annual external CA audit</li><li>All work orders on notice board</li><li>Vendor contracts with penalty clauses</li><li>Any resident can request project info</li></ul></div></div>
</div>

<!-- ================ TAB: NOTICE BOARD ================ -->
<div class="page" id="page_notices">
  <h2 class="page-title" data-edit="notices_title">Notice Board</h2>
  <div class="notice-filter"><button class="notice-filter-btn active" onclick="filterN('All',this)">All</button><button class="notice-filter-btn" onclick="filterN('General',this)">General</button><button class="notice-filter-btn" onclick="filterN('Financial',this)">Financial</button><button class="notice-filter-btn" onclick="filterN('Maintenance',this)">Maintenance</button><button class="notice-filter-btn" onclick="filterN('Event',this)">Event</button><button class="notice-filter-btn" onclick="filterN('Emergency',this)">Emergency</button><button class="notice-filter-btn" onclick="filterN('Meeting',this)">Meeting</button><button class="notice-filter-btn" id="escFilterBtn" onclick="filterN('Escalation',this)" style="display:none">&#9888; Escalation</button></div>
  <div class="notice-grid" id="noticeGrid"><div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-light)"><div style="font-size:3rem;margin-bottom:10px">&#128196;</div><p>No notices yet. Check back soon!</p></div></div>
</div>

<!-- NOTICE MODAL -->
<div class="modal-overlay hidden" id="noticeModal" onclick="if(event.target===this)closeModal()">
  <div class="modal-content"><div class="modal-header"><h3 id="mTitle">Notice</h3><button class="modal-close" onclick="closeModal()">&times;</button></div><div class="modal-body" id="mBody"></div></div>
</div>

<!-- CHATBOT -->
<div class="chatbot-widget" id="chatWidget" style="display:none">
  <button class="chatbot-btn" onclick="toggleChat()">&#128172;</button>
  <div class="chatbot-panel" id="chatPanel">
    <div class="chatbot-header"><h4>&#128172; Message BOM</h4><button style="background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer" onclick="toggleChat()">&times;</button></div>
    <div class="chatbot-messages" id="chatMsgs"><div class="chat-msg"><div class="chat-msg-bot">Hello! Send a message to the Board of Management. Please include your name and flat number.</div></div></div>
    <div class="chatbot-input"><input type="text" id="chatIn" placeholder="Type message..." onkeypress="if(event.key==='Enter')sendChat()"><button onclick="sendChat()">&#10148;</button></div>
  </div>
</div>

<!-- SESSION EXPIRED OVERLAY -->
<div class="session-expired-overlay hidden" id="sessionExpiredOverlay">
  <div class="session-expired-card">
    <div class="session-expired-icon">&#128274;</div>
    <h2>Session Expired</h2>
    <p>Your session has timed out for security. Please login again to continue.</p>
    <button class="btn btn-primary btn-lg" onclick="window.location.reload()">Login Again</button>
  </div>
</div>

<!-- ================ JAVASCRIPT ================ -->
<script>
// ===== AUTH STATE (Supabase-backed) =====
let db=null,auth=null,storage=null,currentUser=null,isAdmin=false,residentUser=null;
// Firebase disabled — all auth via Supabase Auth (see js/auth.js)
// Initialize Supabase Auth listener
SunAuth.init(function(state) {
  console.log('Auth state:', state.event, state.role);
  if (state.event==='SIGNED_IN'||state.event==='RESTORED'||state.event==='TOKEN_REFRESHED'||state.event==='INITIAL_SESSION') {
    if (!state.user) { currentUser=null;isAdmin=false;residentUser=null;updateUI();lockBOMUI();return; }
    currentUser={email:state.user.email,id:state.user.id};
    isAdmin=state.role==='admin';
    if (state.role==='resident') {
      residentUser=state.profile?{ownerName:state.profile.display_name||state.user.email,flatNo:state.profile.flat_no||'',email:state.user.email,status:'approved'}:null;
    }
    updateUI();
    // Show tabs based on role — all content is behind login
    var bomTab=document.getElementById('tabBom');
    var policyTab=document.getElementById('tabPolicy');
    var noticesTab=document.getElementById('tabNotices');
    // Show Policy & Notices for any logged-in user
    if(policyTab)policyTab.style.display='';
    if(noticesTab)noticesTab.style.display='';
    if ((state.role==='admin'||state.role==='bom')) {
      if(bomTab)bomTab.style.display='';
      var bp=document.getElementById('page_bom');
      if (bp&&bp.classList.contains('active')) {
        unlockBOM();
      } else if (state.event==='INITIAL_SESSION'||state.event==='SIGNED_IN') {
        hideSplash();switchTab('bom');
      }
    } else {
      if(bomTab)bomTab.style.display='none';
      if (state.role==='resident'&&residentUser&&(state.event==='INITIAL_SESSION')) {
        var rp=document.getElementById('page_resident');
        if(rp&&rp.classList.contains('active')) unlockResident();
      }
    }
  } else if (state.event==='SIGNED_OUT'||state.event==='SESSION_EXPIRED') {
    currentUser=null;isAdmin=false;residentUser=null;
    var bomTab=document.getElementById('tabBom');
    var policyTab=document.getElementById('tabPolicy');
    var noticesTab=document.getElementById('tabNotices');
    if(bomTab)bomTab.style.display='none';
    if(policyTab)policyTab.style.display='none';
    if(noticesTab)noticesTab.style.display='none';
    updateUI();lockBOMUI();switchTab('resident');
  }
});

// ===== DATA =====
const EM=[{name:'Sh. Lakhmi Chand',flat:'STB-304',v:129},{name:'Sh. Sunil Kumar',flat:'STD-701',v:128},{name:'Sh. Santosh Kr. Srivastava',flat:'STC-104',v:123},{name:'Sh. Himanshu Chaudhary',flat:'STC-502',v:117},{name:'Sh. Mahesh Chand Gupta',flat:'STD-901',v:115},{name:'Sh. Biman Saha',flat:'STC-805',v:113},{name:'Sh. Raj Kumar Rana',flat:'STC-504',v:107},{name:'Sh. Laxman Singh Pangtey',flat:'STC-603',v:106},{name:'Sh. Rajeev Mehta',flat:'STC-902',v:106},{name:'Sh. Harendra Singh',flat:'STD-906',v:105}];
const TASKS=[{id:'A1',c:'A',cn:'Security',t:'100% Car Park Plus Sticker',f:'weekly',dp:'Gen Secretary'},{id:'A2',c:'A',cn:'Security',t:'CCTV monitoring',f:'weekly',dp:'Gen Secretary'},{id:'A3',c:'A',cn:'Security',t:'Security Supervisor monitoring',f:'daily',dp:'Gen Secretary'},{id:'A4',c:'A',cn:'Security',t:'Patrolling report verification',f:'weekly',dp:'Gen Secretary'},{id:'A5',c:'A',cn:'Security',t:'Security welfare (wage/PF)',f:'monthly',dp:'Gen Secretary'},{id:'A6',c:'A',cn:'Security',t:'PA system mock run',f:'daily',dp:'Member'},{id:'B1',c:'B',cn:'Housekeeping',t:'Tower team adoption',f:'weekly',dp:'Gen Secretary'},{id:'B2',c:'B',cn:'Housekeeping',t:'Plant & flower maintenance',f:'weekly',dp:'Member'},{id:'B3',c:'B',cn:'Housekeeping',t:'Lift car shining',f:'daily',dp:'Member'},{id:'B4',c:'B',cn:'Housekeeping',t:'Shaft cleaning',f:'weekly',dp:'Vice Gen Secretary'},{id:'B5',c:'B',cn:'Housekeeping',t:'Basement cleaning',f:'weekly',dp:'Member'},{id:'B6',c:'B',cn:'Housekeeping',t:'Common area cleaning',f:'weekly',dp:'Member'},{id:'B7',c:'B',cn:'Housekeeping',t:'Reception glass dusting',f:'weekly',dp:'Member'},{id:'B8',c:'B',cn:'Housekeeping',t:'Pigeon waste cleaning',f:'monthly',dp:'Member'},{id:'C1',c:'C',cn:'Fire',t:'FAD panel daily check',f:'daily',dp:'Vice Gen Secretary'},{id:'C2',c:'C',cn:'Fire',t:'Sprinkler mock run',f:'quarterly',dp:'Vice Gen Secretary'},{id:'C3',c:'C',cn:'Fire',t:'Smoke detector test',f:'weekly',dp:'Vice Gen Secretary'},{id:'C4',c:'C',cn:'Fire',t:'Sensor stock check',f:'monthly',dp:'Vice Gen Secretary'},{id:'C5',c:'C',cn:'Fire',t:'AMC vendor visit',f:'quarterly',dp:'Vice Gen Secretary'},{id:'D1',c:'D',cn:'Facilities',t:'Library & quiz',f:'weekly',dp:'Member'},{id:'D2',c:'D',cn:'Facilities',t:'Medical room',f:'weekly',dp:'Member'},{id:'D3',c:'D',cn:'Facilities',t:'Indoor play rooms',f:'weekly',dp:'Vice Gen Secretary'},{id:'D4',c:'D',cn:'Facilities',t:'Driver/guest room',f:'weekly',dp:'Member'},{id:'D5',c:'D',cn:'Facilities',t:'Club house events',f:'monthly',dp:'Vice Gen Secretary'},{id:'D6',c:'D',cn:'Facilities',t:'Tea counter',f:'daily',dp:'Member'},{id:'E1',c:'E',cn:'Revenue',t:'SEL dues collection',f:'monthly',dp:'Treasurer'},{id:'E2',c:'E',cn:'Revenue',t:'Gate 2 parking charges',f:'once',dp:'Treasurer'},{id:'E3',c:'E',cn:'Revenue',t:'MyGate ERP accounting',f:'once',dp:'Treasurer'},{id:'E4',c:'E',cn:'Revenue',t:'Lift display revenue',f:'monthly',dp:'Vice Treasurer'},{id:'E5',c:'E',cn:'Revenue',t:'Kiosk display revenue',f:'monthly',dp:'Vice Treasurer'},{id:'E6',c:'E',cn:'Revenue',t:'Club house renting',f:'weekly',dp:'Vice Treasurer'},{id:'E7',c:'E',cn:'Revenue',t:'Flat sell fee',f:'monthly',dp:'Treasurer'},{id:'E8',c:'E',cn:'Revenue',t:'Plant nursery',f:'monthly',dp:'Member'},{id:'F1',c:'F',cn:'Infra',t:'Security Room completion',f:'once',dp:'Vice President'},{id:'F2',c:'F',cn:'Infra',t:'Gate 2 Park Plus merge',f:'once',dp:'Vice President'},{id:'F3',c:'F',cn:'Infra',t:'Basement painting',f:'once',dp:'Vice President'},{id:'F4',c:'F',cn:'Infra',t:'Reception renovation',f:'once',dp:'Vice President'},{id:'F5',c:'F',cn:'Infra',t:'CCTV cameras',f:'once',dp:'Member'},{id:'F6',c:'F',cn:'Infra',t:'Lift renovation tender',f:'once',dp:'Vice President'},{id:'F7',c:'F',cn:'Infra',t:'Garden development',f:'once',dp:'Member'},{id:'F8',c:'F',cn:'Infra',t:'Fire NOC roof exit',f:'once',dp:'Vice Gen Secretary'},{id:'F9',c:'F',cn:'Infra',t:'Swimming pool',f:'once',dp:'Member'},{id:'F10',c:'F',cn:'Infra',t:'Club kitchen area',f:'once',dp:'Member'},{id:'F11',c:'F',cn:'Infra',t:'DG room tools rack',f:'once',dp:'Member'},{id:'F12',c:'F',cn:'Infra',t:'Indoor play renovation',f:'once',dp:'Member'},{id:'F13',c:'F',cn:'Infra',t:'Lift room painting',f:'once',dp:'Vice President'},{id:'F14',c:'F',cn:'Infra',t:'EV charging station',f:'once',dp:'Member'},{id:'F15',c:'F',cn:'Infra',t:'Overhead tank repair',f:'once',dp:'Vice President'},{id:'F16',c:'F',cn:'Infra',t:'Pipe shaft repair',f:'once',dp:'Vice President'},{id:'F17',c:'F',cn:'Infra',t:'Toilet renovation',f:'once',dp:'Member'},{id:'F18',c:'F',cn:'Infra',t:'Illumination',f:'once',dp:'Member'},{id:'G1',c:'G',cn:'Legal',t:'UP Apartment Act compliance',f:'quarterly',dp:'Member'},{id:'G2',c:'G',cn:'Legal',t:'Legal notice drafting & review',f:'monthly',dp:'Member'},{id:'G3',c:'G',cn:'Legal',t:'Dispute resolution & mediation',f:'monthly',dp:'Member'},{id:'G4',c:'G',cn:'Legal',t:'RWA documentation & bylaws',f:'quarterly',dp:'Member'},{id:'G5',c:'G',cn:'Legal',t:'Court/tribunal case follow-up',f:'monthly',dp:'Member'},{id:'G6',c:'G',cn:'Legal',t:'Agreement & contract review',f:'monthly',dp:'Member'}];
const POS=['President','Vice President','Gen Secretary','Vice Gen Secretary','Treasurer','Vice Treasurer','Joint Secretary','Sport Secretary','Culture Secretary','Spokesperson','Chairman','Co-Chairman','PRO','Advisor','Member','Custom...'];
const PROF=['Engineer/Technical','CA/Finance/Banking','Legal/Advocate','Doctor/Medical','IT/Software','Business/Entrepreneur','Government Service','Education/Teacher','Retired Professional','Management/Corporate','Real Estate','Other'];
const DEF_PROJECTS=[{id:'P1',name:'Security Room Gate 1',committee:'F',status:'In Progress',timeline:'Feb-Mar 2026',budget:'TBD',progress:30,description:'Construction of new security room at Gate 1 entrance',updates:[],documents:[],meetings:[]},{id:'P2',name:'Gate 2 Park Plus',committee:'F',status:'Planned',timeline:'Mar 2026',budget:'TBD',progress:5,description:'Integration of Park Plus system at Gate 2',updates:[],documents:[],meetings:[]},{id:'P3',name:'Basement Painting',committee:'F',status:'Planned',timeline:'Apr 2026',budget:'TBD',progress:0,description:'Complete basement painting and waterproofing',updates:[],documents:[],meetings:[]},{id:'P4',name:'Reception Renovation',committee:'F',status:'Planned',timeline:'Apr-May 2026',budget:'TBD',progress:0,description:'Complete renovation of reception area',updates:[],documents:[],meetings:[]},{id:'P5',name:'CCTV Cameras',committee:'A',status:'Planned',timeline:'Mar 2026',budget:'TBD',progress:10,description:'Installation of new CCTV cameras across all areas',updates:[],documents:[],meetings:[]},{id:'P6',name:'EV Charging',committee:'F',status:'Planned',timeline:'Q2 2026',budget:'TBD',progress:0,description:'Electric vehicle charging stations in basement',updates:[],documents:[],meetings:[]},{id:'P7',name:'Lift Renovation',committee:'F',status:'Tender',timeline:'Q2-Q3 2026',budget:'TBD',progress:5,description:'Major lift renovation across all towers',updates:[],documents:[],meetings:[]},{id:'P8',name:'Fire NOC',committee:'C',status:'In Progress',timeline:'Ongoing',budget:'TBD',progress:40,description:'Fire NOC compliance and roof exit construction',updates:[],documents:[],meetings:[]}];
let projects=[];
function ensureProjectFields(p){if(!p.expenses)p.expenses=[];if(!p.closureReport)p.closureReport=null;if(!p.updates)p.updates=[];if(!p.documents)p.documents=[];if(!p.meetings)p.meetings=[];return p}
function loadProjects(){try{const s=localStorage.getItem('st_projects');if(s)projects=JSON.parse(s).map(ensureProjectFields);else{projects=JSON.parse(JSON.stringify(DEF_PROJECTS)).map(ensureProjectFields);saveProjects()}}catch(e){projects=JSON.parse(JSON.stringify(DEF_PROJECTS)).map(ensureProjectFields)}}
function saveProjects(){localStorage.setItem('st_projects',JSON.stringify(projects));supaSync('st_projects');if(db){projects.forEach(p=>db.collection('projects').doc(p.id).set(p).catch(()=>{}))}}
// ===== SUPABASE KV SYNC =====
// supaSync: after any localStorage.setItem, push that key to Supabase kv_store
function supaSync(key){if(!supa)return;try{var v=localStorage.getItem(key);if(v){supa.from('kv_store').upsert({key:key,value:JSON.parse(v),updated_at:new Date().toISOString()}).then(function(){}).catch(function(){})}}catch(e){}}
// supaHydrate: on page load, pull all cloud data into localStorage
async function supaHydrate(){if(!supa)return;try{var res=await supa.from('kv_store').select('*');if(res.data){res.data.forEach(function(r){localStorage.setItem(r.key,JSON.stringify(r.value))});console.log('Supabase: hydrated '+res.data.length+' keys')}}catch(e){console.log('Supabase hydrate error:',e)}}

let members=[],notices=[];
let assignments=JSON.parse(localStorage.getItem('st_assignments')||'{}');

// ===== NAVIGATION =====
function enterBOM(){hideSplash();switchTab('bom');if(!SunAuth.isLoggedIn())showAuth()}
function enterResident(){hideSplash();switchTab('resident');if(!residentUser)showResidentAuth('login')}
function hideSplash(){const s=document.getElementById('splashScreen');s.classList.add('hidden');document.getElementById('siteHeader').style.display='flex';document.getElementById('mainTabs').style.display='flex';document.getElementById('bomSubNav').style.display='none';setTimeout(()=>s.style.display='none',800)}
function goHome(){const s=document.getElementById('splashScreen');s.style.display='flex';s.classList.remove('hidden');document.getElementById('siteHeader').style.display='none';document.getElementById('mainTabs').style.display='none';document.getElementById('bomSubNav').style.display='none';document.getElementById('chatWidget').style.display='none'}
function switchTab(t){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.main-tab').forEach(b=>b.classList.remove('active'));document.getElementById('page_'+t).classList.add('active');const tabMap={bom:'tabBom',resident:'tabResident',policy:'tabPolicy',notices:'tabNotices'};document.getElementById(tabMap[t]).classList.add('active');document.getElementById('chatWidget').style.display=(t==='resident'&&residentUser)?'block':'none';if(t==='bom'){if(SunAuth.isLoggedIn()&&(SunAuth.isBOM()||SunAuth.isAdmin())){currentUser={email:SunAuth.getUserEmail(),id:SunAuth.getUserId()};isAdmin=SunAuth.isAdmin();document.getElementById('bomSubNav').style.display='flex';document.getElementById('page_bom').className='page has-subnav active';unlockBOM()}else{currentUser=null;lockBOMUI()}}else{document.getElementById('bomSubNav').style.display='none';document.getElementById('page_bom').className='page'}if(t==='resident'){if(residentUser){unlockResident()}else{document.getElementById('residentLocked').style.display='block';document.getElementById('residentContent').style.display='none'}}if(t==='policy'||t==='notices'){if(!SunAuth.isLoggedIn()){switchTab('resident');showLoginChooser();return}}if(t==='notices')loadNotices();window.scrollTo(0,0)}
function unlockBOM(){document.getElementById('bomLocked').style.display='none';document.getElementById('bomContent').style.display='block';loadMemDB();buildElectionTable();loadResidentData();if(isAdmin){document.getElementById('bn_admin').style.display='';document.getElementById('adminLock').style.display='none';document.getElementById('adminPanel').style.display='block';popAccDrop();loadAdminMsgs();loadAdminProfile();loadRegRequests();loadApprovedResidents();buildAccountList();trackBOMLogin()}else{document.getElementById('bn_admin').style.display='none'}}
function lockBOMUI(){document.getElementById('bomSubNav').style.display='none';document.getElementById('bomContent').style.display='none';document.getElementById('bomLocked').style.display='block';document.getElementById('page_bom').className='page active'}
function showBom(s){document.querySelectorAll('.bom-sec').forEach(el=>el.style.display='none');document.querySelectorAll('.sub-nav a').forEach(a=>a.classList.remove('active'));const el=document.getElementById('bs_'+s);if(el)el.style.display='block';const nav=document.getElementById('bn_'+s);if(nav)nav.classList.add('active');if(s==='members')initMemForm();if(s==='allocate')initAlloc();if(s==='dashboard')genDash();if(s==='challenges')buildChallenges();if(s==='committees')buildCommittees();if(s==='projects'){buildProjDash()}if(s==='directory')initDirectory();if(s==='admin'&&isAdmin){loadRegRequests();loadApprovedResidents();loadManageResidents();loadAdminMsgs();buildAccountList()}window.scrollTo(0,0)}

// ===== AUTH =====
function showAuth(){document.getElementById('authOverlay').classList.remove('hidden');document.getElementById('loginForm').style.display='block';document.getElementById('forgotForm').style.display='none'}
function hideAuth(){document.getElementById('authOverlay').classList.add('hidden')}
function showForgotPw(){document.getElementById('loginForm').style.display='none';document.getElementById('forgotForm').style.display='block'}
function showLoginFm(){document.getElementById('loginForm').style.display='block';document.getElementById('forgotForm').style.display='none'}
async function doLogin(){const e=document.getElementById('loginEmail').value.trim(),p=document.getElementById('loginPassword').value,err=document.getElementById('loginError'),suc=document.getElementById('loginSuccess');err.style.display='none';suc.style.display='none';if(!e||!p){err.textContent='Enter email and password';err.style.display='block';return}
// Supabase Auth login
const result=await SunAuth.login(e,p);
if(result.error){err.textContent=result.error.message||'Invalid email or password';err.style.display='block';return}
currentUser={email:result.data.user.email,id:result.data.user.id};
isAdmin=result.data.role==='admin';
trackBOMLogin();updateUI();
var bomTab=document.getElementById('tabBom');if(bomTab)bomTab.style.display='';
var pt=document.getElementById('tabPolicy');if(pt)pt.style.display='';
var nt=document.getElementById('tabNotices');if(nt)nt.style.display='';
suc.textContent='Success!';suc.style.display='block';
setTimeout(()=>{hideAuth();switchTab('bom')},500)}
async function doForgotPw(){const e=document.getElementById('forgotEmail').value.trim(),err=document.getElementById('forgotError'),suc=document.getElementById('forgotSuccess');err.style.display='none';suc.style.display='none';if(!e){err.textContent='Enter email';err.style.display='block';return}
const result=await SunAuth.resetPassword(e);
if(result.error){err.textContent=result.error.message;err.style.display='block'}
else{suc.textContent='Reset link sent to your email!';suc.style.display='block'}}
function toggleAuthBtn(){
  if(currentUser){doLogout();return}
  // Show unified login chooser
  showLoginChooser();
}
function showLoginChooser(){
  document.getElementById('mTitle').textContent='Login';
  document.getElementById('mBody').innerHTML=`<div style="text-align:center;padding:20px">
    <p style="color:#666;margin-bottom:25px;font-size:0.95rem">Select your login type</p>
    <div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-lg" style="background:#00695c;color:#fff;padding:15px 30px;border-radius:12px;min-width:180px" onclick="closeModal();showResidentAuth('login')">
        <div style="font-size:1.5rem;margin-bottom:5px">&#127968;</div>Resident Login
      </button>
      <button class="btn btn-lg" style="background:var(--primary);color:#fff;padding:15px 30px;border-radius:12px;min-width:180px" onclick="closeModal();showAuth()">
        <div style="font-size:1.5rem;margin-bottom:5px">&#128274;</div>BOM / Admin Login
      </button>
    </div>
    <p style="color:#999;font-size:0.78rem;margin-top:20px">Not registered? <a href="#" onclick="closeModal();showResidentAuth('register');return false" style="color:#00695c;font-weight:600">Request Registration</a></p>
  </div>`;
  document.getElementById('noticeModal').classList.remove('hidden');
}
async function doLogout(){await SunAuth.logout();currentUser=null;isAdmin=false;residentUser=null;var bomTab=document.getElementById('tabBom');if(bomTab)bomTab.style.display='none';var pt=document.getElementById('tabPolicy');if(pt)pt.style.display='none';var nt=document.getElementById('tabNotices');if(nt)nt.style.display='none';updateUI();lockBOMUI();switchTab('resident')}
function updateUI(){const u=document.getElementById('headerUser'),b=document.getElementById('headerAuthBtn');if(currentUser){const role=SunAuth.getRole();const roleBadge=role==='admin'?'<span class="role-badge role-badge-admin">ADMIN</span>':role==='bom'?'<span class="role-badge role-badge-bom">BOM</span>':role==='resident'?'<span class="role-badge role-badge-resident">RESIDENT</span>':'';u.innerHTML=(currentUser.email||'')+' '+roleBadge;b.textContent='Logout'}else{u.innerHTML='';b.textContent='Login'}}

// ===== MEMBERS =====
function loadMemDB(){if(db){db.collection('members').orderBy('rank').get().then(s=>{if(!s.empty){members=s.docs.map(d=>d.data());updatePosBadges()}else loadMemLS()}).catch(()=>loadMemLS())}else loadMemLS()}
function loadMemLS(){try{const s=localStorage.getItem('suntower_members');if(s){members=JSON.parse(s);updatePosBadges()}}catch(e){}}
function buildElectionTable(){const t=document.getElementById('electionTable');if(!t)return;
  const POS_ORDER=['President','Vice President','Gen Secretary','Vice Gen Secretary','Treasurer','Vice Treasurer','Joint Treasurer','Joint Secretary','Sport Secretary','Culture Secretary','Spokesperson','Chairman','Co-Chairman','PRO','Advisor','Member','Executive Member'];
  // Merge EM + members and sort by position hierarchy
  const merged=EM.map((m,i)=>{const mem=members[i];return{name:m.name,flat:m.flat,v:m.v,pos:mem&&mem.position?mem.position:'To be elected'}});
  merged.sort((a,b)=>{const ai=POS_ORDER.indexOf(a.pos);const bi=POS_ORDER.indexOf(b.pos);const pa=ai>=0?ai:(a.pos==='To be elected'?999:POS_ORDER.length);const pb=bi>=0?bi:(b.pos==='To be elected'?999:POS_ORDER.length);if(pa!==pb)return pa-pb;return b.v-a.v});
  const pc={'President':'badge-president','Vice President':'badge-vp','Gen Secretary':'badge-gs','Vice Gen Secretary':'badge-vgs','Treasurer':'badge-treasurer','Vice Treasurer':'badge-vt','Joint Treasurer':'badge-vt','Joint Secretary':'badge-vgs','Sport Secretary':'badge-info','Culture Secretary':'badge-info','Spokesperson':'badge-warning','Chairman':'badge-president','Co-Chairman':'badge-vp','PRO':'badge-info','Advisor':'badge-vt','Member':'badge-member','Executive Member':'badge-member'};
  let h='<tr><th>#</th><th>Name</th><th>Flat</th><th>Votes</th><th>Position</th></tr>';
  merged.forEach((m,i)=>{const cls=pc[m.pos]||'badge-success';h+=`<tr style="background:#e8f5e9"><td>${i+1}</td><td><strong>${m.name}</strong></td><td>${m.flat}</td><td><strong>${m.v}</strong></td><td><span class="badge ${cls}">${m.pos}</span></td></tr>`});
  t.innerHTML=h}
function updatePosBadges(){buildElectionTable()}
function initMemForm(){const f=document.getElementById('memberForm');if(!f)return;const ro=!isAdmin;f.innerHTML='';for(let i=0;i<10;i++){const m=members[i]||{};const em=EM[i]||{};const d=ro?'disabled':'';const isCustomPos=m.position&&!POS.includes(m.position)&&m.position!=='Custom...';const selVal=isCustomPos?'Custom...':m.position||'';f.innerHTML+=`<div class="member-card"><div style="text-align:center;font-weight:700;color:var(--primary);margin-bottom:10px">Member ${i+1} | Votes: ${em.v||''}</div><label>Name</label><input type="text" id="n_${i}" value="${m.name||em.name||''}" ${d}><label>Flat</label><input type="text" id="f_${i}" value="${m.flat||em.flat||''}" ${d}><label>Profession</label><select id="pr_${i}" ${d}><option value="">--</option>${PROF.map(p=>`<option value="${p}" ${m.profession===p?'selected':''}>${p}</option>`).join('')}</select><label>Position</label><select id="po_${i}" ${d} onchange="handlePosChange(${i})"><option value="">-- To be elected --</option>${POS.map(p=>`<option value="${p}" ${selVal===p?'selected':''}>${p}</option>`).join('')}</select><div id="customPos_${i}" style="display:${isCustomPos?'block':'none'};margin-top:4px"><input type="text" id="cp_${i}" value="${isCustomPos?m.position:''}" placeholder="Enter custom designation" ${d} style="border:2px solid var(--secondary)"></div><label>Phone</label><input type="text" id="ph_${i}" value="${m.phone||''}" ${d}><label>Email</label><input type="email" id="em_${i}" value="${m.email||''}" ${d}></div>`}document.getElementById('memberAdminLock').style.display=ro?'block':'none';document.getElementById('memberActions').style.display=ro?'none':'flex'}
function handlePosChange(i){const sel=document.getElementById('po_'+i).value;const box=document.getElementById('customPos_'+i);if(sel==='Custom...'){box.style.display='block';document.getElementById('cp_'+i).focus()}else{box.style.display='none';document.getElementById('cp_'+i).value=''}}
function saveMembers(){if(!isAdmin){alert('Only Admin can save.');return}members=[];for(let i=0;i<10;i++){let pos=document.getElementById('po_'+i).value;if(pos==='Custom...'){const cp=document.getElementById('cp_'+i).value.trim();if(cp)pos=cp;else pos='Member'}members.push({rank:i+1,name:document.getElementById('n_'+i).value.trim(),flat:document.getElementById('f_'+i).value.trim(),profession:document.getElementById('pr_'+i).value,position:pos,phone:document.getElementById('ph_'+i).value.trim(),email:document.getElementById('em_'+i).value.trim(),votes:EM[i]?.v||0})}if(db){const b=db.batch();members.forEach((m,i)=>b.set(db.collection('members').doc('m_'+i),m));b.commit().then(()=>{alert('Saved to database!');updatePosBadges()}).catch(e=>{localStorage.setItem('suntower_members',JSON.stringify(members));supaSync('suntower_members');alert('Saved locally (DB unavailable)');updatePosBadges()})}else{localStorage.setItem('suntower_members',JSON.stringify(members));supaSync('suntower_members');alert('Saved locally!');updatePosBadges()}}
function loadElected(){members=EM.map((m,i)=>({rank:i+1,name:m.name,flat:m.flat,profession:'',position:'',phone:'',email:'',votes:m.v}));initMemForm()}

// ===== CHALLENGES =====
function buildChallenges(){const a=document.getElementById('challengesArea');if(!a||a.innerHTML)return;const cc={A:'#b71c1c',B:'#4a148c',C:'#1a237e',D:'#01579b',E:'#004d40',F:'#e65100',G:'#37474f'};const cn={A:'Security/PANZEER',B:'Housekeeping/SHINEBURG',C:'Fire/SKENTERPRISE',D:'Facilities',E:'Revenue',F:'Infrastructure',G:'Legal'};let h='';let lc='';TASKS.forEach(t=>{if(t.c!==lc){lc=t.c;h+=`<div class="card" style="border-left-color:${cc[t.c]}"><h3>${t.c} - ${cn[t.c]}</h3><table><tr><th>#</th><th>Task</th><th>Freq</th></tr>`}h+=`<tr><td>${t.id}</td><td>${t.t}</td><td><span class="freq-badge freq-${t.f}">${t.f}</span></td></tr>`;const nx=TASKS[TASKS.indexOf(t)+1];if(!nx||nx.c!==t.c)h+='</table></div>'});a.innerHTML=h}

// ===== COMMITTEES =====
function loadCommitteeMembers(){try{const s=localStorage.getItem('st_committee_members');return s?JSON.parse(s):{}}catch(e){return {}}}
function saveCommitteeMembers(data){localStorage.setItem('st_committee_members',JSON.stringify(data));supaSync('st_committee_members')}
function saveCommitteesUI(){const cm={};['A','B','C','D','E','F','G'].forEach(c=>{cm[c]={convenor:document.getElementById('cm_'+c+'_conv').value,bomMember:document.getElementById('cm_'+c+'_bom').value,residents:[document.getElementById('cm_'+c+'_res0').value.trim(),document.getElementById('cm_'+c+'_res1').value.trim(),document.getElementById('cm_'+c+'_res2').value.trim()]}});saveCommitteeMembers(cm);alert('Committee assignments saved!')}
function buildCommittees(){const a=document.getElementById('committeesArea');if(!a)return;a.innerHTML='';const saved=loadCommitteeMembers();const comms=[{c:'A',n:'Security',icon:'&#128737;',bg:'#b71c1c',sop:'CCTV, patrolling, Park Plus, welfare checks'},{c:'B',n:'Housekeeping',icon:'&#128700;',bg:'#4a148c',sop:'Cleaning, lifts, plants, shaft maintenance'},{c:'C',n:'Fire Safety',icon:'&#128293;',bg:'#1a237e',sop:'FAD panels, sprinklers, smoke detectors, AMC'},{c:'D',n:'Facilities',icon:'&#127968;',bg:'#01579b',sop:'Library, medical, play areas, club house'},{c:'E',n:'Revenue',icon:'&#128176;',bg:'#004d40',sop:'Dues, parking, advertising, ERP, rentals'},{c:'F',n:'Infrastructure',icon:'&#128679;',bg:'#e65100',sop:'All 18 projects, tenders, renovations'},{c:'G',n:'Legal',icon:'&#9878;',bg:'#37474f',sop:'RWA compliance, UP Apartment Act, legal notices, dispute resolution, contracts'}];const dis=isAdmin?'':'disabled';const vm=members.filter(m=>m&&m.name);let h='<div class="grid-2">';comms.forEach(cm=>{const sv=saved[cm.c]||{convenor:'',bomMember:'',residents:['','','']};const res=sv.residents||['','',''];h+=`<div class="committee-card" style="border-top-color:${cm.bg}"><h3><div class="committee-icon" style="background:${cm.bg}">${cm.icon}</div>Committee ${cm.c} - ${cm.n}</h3><div class="comm-member-slot"><span class="slot-type slot-bom">BOM Convenor</span><select class="form-control" id="cm_${cm.c}_conv" style="flex:1;padding:5px" ${dis}><option value="">-- Select --</option>${vm.map(m=>`<option value="${m.name}" ${sv.convenor===m.name?'selected':''}>${m.name}</option>`).join('')}</select></div><div class="comm-member-slot"><span class="slot-type slot-bom">BOM Member</span><select class="form-control" id="cm_${cm.c}_bom" style="flex:1;padding:5px" ${dis}><option value="">-- Select --</option>${vm.map(m=>`<option value="${m.name}" ${sv.bomMember===m.name?'selected':''}>${m.name}</option>`).join('')}</select></div>`;for(let ri=0;ri<3;ri++){h+=`<div class="comm-member-slot"><span class="slot-type slot-resident">Resident ${ri+1}</span><div class="autocomplete-wrapper"><input class="form-control ac-resident" id="cm_${cm.c}_res${ri}" style="padding:5px" placeholder="Type name or flat to search..." value="${res[ri]||''}" ${dis} autocomplete="off" oninput="residentAutocomplete(this)" onfocus="residentAutocomplete(this)" onblur="setTimeout(()=>closeAutocomplete(this),200)"><div class="autocomplete-list" id="acl_${cm.c}_res${ri}"></div></div></div>`}h+=`<div class="sop-box"><strong>SOP:</strong> ${cm.sop}</div></div>`});h+='</div>';a.innerHTML=h;const ca=document.getElementById('commActions');if(ca)ca.style.display=isAdmin?'flex':'none'}

// ===== RESIDENT DIRECTORY & AUTOCOMPLETE =====
let _residentData=[];let _residentDataLoaded=false;
function loadResidentData(){if(_residentDataLoaded)return Promise.resolve(_residentData);return fetch('data/residents.json').then(r=>r.json()).then(d=>{_residentData=d;_residentDataLoaded=true;console.log('Resident data loaded:',d.length,'records');return d}).catch(e=>{console.warn('Failed to load resident data:',e);return[]})}

// Autocomplete for resident inputs in committees
// Data format: {n:name, f:flat, t:tower, fn:flat_no, tp:type, oc:occupancy, st:status, mb:mobile}
function residentAutocomplete(input){if(!_residentDataLoaded){loadResidentData().then(()=>residentAutocomplete(input));return}
const q=input.value.toLowerCase().trim();const listId=input.nextElementSibling?.id;if(!listId)return;const list=document.getElementById(listId);if(!list)return;
if(q.length<2){list.classList.remove('show');list.innerHTML='';return}
const matches=_residentData.filter(r=>{return r.n.toLowerCase().includes(q)||r.f.toLowerCase().includes(q)||r.t.toLowerCase().includes(q)}).slice(0,15);
if(!matches.length){list.classList.remove('show');list.innerHTML='';return}
list.innerHTML=matches.map(r=>{const typeCls=r.tp==='Owner'?'dir-badge-owner':r.tp.includes('Tenant')?'dir-badge-tenant':'dir-badge-family';return`<div class="autocomplete-item" onmousedown="selectResident(this,'${input.id}')"><div><span class="ac-name">${r.n}</span> <span class="ac-type dir-badge ${typeCls}">${r.tp}</span></div><span class="ac-flat">${r.f}</span></div>`}).join('');
list.classList.add('show')}
function selectResident(item,inputId){const name=item.querySelector('.ac-name').textContent;const flat=item.querySelector('.ac-flat').textContent;const inp=document.getElementById(inputId);if(inp)inp.value=name+' ('+flat+')';closeAutocomplete(inp)}
function closeAutocomplete(input){if(!input)return;const list=input.nextElementSibling;if(list)list.classList.remove('show')}

// Resident Directory Search
function initDirectory(){loadResidentData().then(()=>{searchDirectory()})}
function searchDirectory(){if(!_residentDataLoaded){loadResidentData().then(()=>searchDirectory());return}
const q=(document.getElementById('dirSearchInput')?.value||'').toLowerCase().trim();
const tower=document.getElementById('dirTowerFilter')?.value||'';
const type=document.getElementById('dirTypeFilter')?.value||'';
const status=document.getElementById('dirStatusFilter')?.value||'';
let results=_residentData.filter(r=>{if(r.f.startsWith('COMMON'))return false;
if(tower&&r.t!==tower)return false;
if(type&&r.tp!==type)return false;
if(status&&r.st!==status)return false;
if(q&&!r.n.toLowerCase().includes(q)&&!r.f.toLowerCase().includes(q)&&!r.t.toLowerCase().includes(q)&&!r.fn.includes(q))return false;
return true});
// Stats
const statsEl=document.getElementById('dirStats');
const totalOwners=results.filter(r=>r.tp==='Owner').length;
const totalTenants=results.filter(r=>r.tp.includes('Tenant')).length;
const totalActive=results.filter(r=>r.st==='Active').length;
const uniqueFlats=new Set(results.map(r=>r.f)).size;
statsEl.innerHTML=`<div class="dir-stat-card"><div class="stat-num">${results.length}</div><div class="stat-label">Total</div></div><div class="dir-stat-card"><div class="stat-num">${uniqueFlats}</div><div class="stat-label">Flats</div></div><div class="dir-stat-card"><div class="stat-num" style="color:#1565c0">${totalOwners}</div><div class="stat-label">Owners</div></div><div class="dir-stat-card"><div class="stat-num" style="color:#e65100">${totalTenants}</div><div class="stat-label">Tenants</div></div><div class="dir-stat-card"><div class="stat-num" style="color:#2e7d32">${totalActive}</div><div class="stat-label">Active</div></div>`;
// Table
const resEl=document.getElementById('dirResults');
if(!results.length){resEl.innerHTML='<div class="card" style="text-align:center;padding:30px;color:#999">No residents found matching your search.</div>';return}
const showing=results.slice(0,100);
let h='<div class="dir-table-wrap"><table class="dir-table"><thead><tr><th>Flat</th><th>Name</th><th>Type</th><th>Occupancy</th><th>Status</th><th>Mobile</th></tr></thead><tbody>';
showing.forEach(r=>{const typeCls=r.tp==='Owner'?'dir-badge-owner':r.tp.includes('Tenant')?'dir-badge-tenant':'dir-badge-family';const statusCls=r.st==='Active'?'dir-badge-active':'dir-badge-inactive';
h+=`<tr><td><span class="dir-tower-tag">${r.t}</span>${r.fn}</td><td><strong>${r.n}</strong></td><td><span class="dir-badge ${typeCls}">${r.tp}</span></td><td style="font-size:0.78rem;color:#666">${r.oc}</td><td><span class="dir-badge ${statusCls}">${r.st}</span></td><td style="font-size:0.8rem;color:#555">${r.mb}</td></tr>`});
h+='</tbody></table></div>';
if(results.length>100)h+=`<p style="text-align:center;color:#999;font-size:0.8rem;margin-top:8px">Showing 100 of ${results.length} results. Refine your search to see more.</p>`;
resEl.innerHTML=h}

// ===== ALLOCATION =====
function initAlloc(){const a=document.getElementById('allocArea');const vm=members.filter(m=>m&&m.name);if(!vm.length){a.innerHTML='<div class="card"><p>Register members first.</p></div>';return}let h='',lc='';const cc={A:'#b71c1c',B:'#4a148c',C:'#1a237e',D:'#01579b',E:'#004d40',F:'#e65100'};TASKS.forEach(t=>{if(t.c!==lc){lc=t.c;h+=`<div class="task-category" style="border-left:4px solid ${cc[t.c]}">Cat ${t.c} - ${t.cn}</div>`}h+=`<div class="task-row"><strong style="min-width:35px;color:${cc[t.c]}">${t.id}</strong><span style="flex:1">${t.t}</span><select id="a_${t.id}" onchange="assignments['${t.id}']=this.value;saveAssignments()"><option value="">--</option>${vm.map(m=>`<option value="${m.name}" ${assignments[t.id]===m.name?'selected':''}>${m.name}</option>`).join('')}</select></div>`});a.innerHTML=h}
function saveAssignments(){localStorage.setItem('st_assignments',JSON.stringify(assignments));supaSync('st_assignments');if(db){db.collection('settings').doc('assignments').set(assignments).catch(()=>{})}}
function autoAssign(){const vm=members.filter(m=>m&&m.name);if(!vm.length)return;const pm={};vm.forEach(m=>{const p=m.position||'Member';if(!pm[p])pm[p]=[];pm[p].push(m.name)});let mi=0;TASKS.forEach(t=>{if(t.dp==='Member'){const ml=pm['Member']||vm.map(m=>m.name);assignments[t.id]=ml[mi++%ml.length]}else{assignments[t.id]=(pm[t.dp]&&pm[t.dp][0])||vm[0].name}});saveAssignments();initAlloc()}
function clearAssign(){assignments={};saveAssignments();initAlloc()}
function genDash(){const a=document.getElementById('dashArea'),ch=document.getElementById('chartArea');const vm=members.filter(m=>m&&m.name);if(!vm.length){a.innerHTML='<div class="card"><p>No members.</p></div>';return}const mt={};vm.forEach(m=>{mt[m.name]=[]});TASKS.forEach(t=>{if(assignments[t.id]&&mt[assignments[t.id]])mt[assignments[t.id]].push(t)});const tot=Object.values(mt).reduce((s,a)=>s+a.length,0);const pc={'President':'#b71c1c','Vice President':'#4a148c','Gen Secretary':'#1a237e','Vice Gen Secretary':'#01579b','Treasurer':'#004d40','Vice Treasurer':'#1b5e20','Member':'#e65100'};let h=`<p><strong>Total:</strong> ${TASKS.length} | <strong>Assigned:</strong> ${tot} | <strong>Unassigned:</strong> ${TASKS.length-tot}</p><div class="summary-grid">`;vm.forEach(m=>{const ts=mt[m.name]||[];const c=pc[m.position]||'#666';h+=`<div class="summary-card" style="border-top:4px solid ${c}"><div class="name">${m.name}</div><div class="position"><span class="badge" style="background:${c}">${m.position||'Member'}</span></div><div class="task-count">${ts.length}</div><div style="font-size:0.8rem;color:#666">tasks</div></div>`});h+='</div>';a.innerHTML=h;const mx=Math.max(...vm.map(m=>(mt[m.name]||[]).length),1);let c2='<div class="card"><h3>Workload</h3>';vm.forEach(m=>{const cnt=(mt[m.name]||[]).length;const p=(cnt/mx)*100;const cl=pc[m.position]||'#666';c2+=`<div style="display:flex;align-items:center;gap:10px;margin:6px 0"><span style="min-width:120px;font-size:0.85rem;font-weight:600">${m.name}</span><div style="flex:1;background:#e0e0e0;border-radius:8px;height:24px;position:relative"><div style="width:${p}%;background:${cl};border-radius:8px;height:100%"></div><span style="position:absolute;right:8px;top:3px;font-size:0.8rem;font-weight:600">${cnt}</span></div></div>`});c2+='</div>';ch.innerHTML=c2}
function exportCSV(){const vm=members.filter(m=>m&&m.name);let csv='ID,Category,Task,Freq,Assigned,Position\n';TASKS.forEach(t=>{const a=assignments[t.id]||'';const m=vm.find(x=>x.name===a);csv+=`"${t.id}","${t.cn}","${t.t}","${t.f}","${a}","${m?m.position:''}"\n`});const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);const el=document.createElement('a');el.href=u;el.download='SunTower_Allocation.csv';el.click()}

// ===== ADMIN =====
function popAccDrop(){const s=document.getElementById('accName');if(!s)return;s.innerHTML='<option value="">--</option>';EM.forEach(m=>{s.innerHTML+=`<option>${m.name} (${m.flat})</option>`})}
async function createAccount(){const e=document.getElementById('accEmail').value.trim(),p=document.getElementById('accPass').value,n=document.getElementById('accName').value,err=document.getElementById('accErr'),scArea=document.getElementById('accSuccessCard');err.style.display='none';scArea.innerHTML='';if(!e||!p||p.length<6){err.textContent='Valid email & password (6+ chars) required';err.style.display='block';return}
// Create BOM account via Supabase Admin API
try{
  const dispName=n||e;
  const flat=(n.match(/\(([^)]+)\)/)||[])[1]||'';
  err.textContent='Creating account...';err.style.display='block';err.style.color='#1565c0';
  const result=await createSupabaseUser(e,p,'bom',{display_name:dispName,flat_no:flat});
  err.style.display='none';err.style.color='';
  if(!result.ok){
    err.textContent='Account creation failed: '+(result.error||'Unknown error');err.style.display='block';err.style.color='';return;
  }
  // Also store in localStorage for admin panel display
  const u=JSON.parse(localStorage.getItem('st_users')||'{}');u[e]=p;
  localStorage.setItem('st_users',JSON.stringify(u));supaSync('st_users');
  saveBOMAcctMeta(n,e,p);showAcctSuccessCard(n,e,p);
  SunAudit.log('create_account','account',null,{email:e,name:n,role:'bom',supabase:true});
}catch(x){err.textContent=x.message||'Account creation failed';err.style.display='block';err.style.color=''}}
function saveBOMAcctMeta(name,email,pass){const accts=JSON.parse(localStorage.getItem('st_bom_accounts')||'[]');const dup=accts.find(a=>a.email.toLowerCase()===email.toLowerCase());if(dup){dup.name=name||dup.name;dup.password=pass;dup.updatedAt=new Date().toISOString();dup.lastReset=new Date().toISOString()}else{const flat=(name.match(/\(([^)]+)\)/)||[])[1]||'';accts.push({id:'BOM_'+Date.now(),name:name,email:email.toLowerCase(),password:pass,flat:flat,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),lastLogin:null,status:'never'})}localStorage.setItem('st_bom_accounts',JSON.stringify(accts));supaSync('st_bom_accounts');buildAccountList()}
function showAcctSuccessCard(name,email,pass){const area=document.getElementById('accSuccessCard');const dispName=name||email;const credText=`BOM Portal Login\nName: ${dispName}\nEmail: ${email}\nPassword: ${pass}\nURL: https://suntower.in`;const wpText=encodeURIComponent(`🏢 Sun Tower BOM Portal\n\nDear ${dispName},\n\nYour BOM account has been created:\n📧 Email: ${email}\n🔑 Password: ${pass}\n🔗 URL: https://suntower.in\n\nPlease login and change your password.\n\n— Sun Tower RWA Admin`);area.innerHTML=`<div class="acct-success-card"><h4>&#9989; Account Created Successfully</h4><dl class="acct-success-detail"><dt>Member</dt><dd><strong>${dispName}</strong></dd><dt>Email</dt><dd>${email}</dd><dt>Password</dt><dd><code style="background:#fff;padding:2px 8px;border-radius:4px;font-weight:700;color:#1a237e">${pass}</code></dd></dl><div class="acct-copy-bar"><button class="acct-copy-btn acct-copy-btn-cred" onclick="copyAcctCred('${credText.replace(/'/g,"\\'")}')">&#128203; Copy Credentials</button><button class="acct-copy-btn acct-copy-btn-wp" onclick="window.open('https://wa.me/?text=${wpText}','_blank')">&#128172; Share via WhatsApp</button><button class="acct-copy-btn acct-copy-btn-dismiss" onclick="this.closest('.acct-success-card').remove()">&#10005; Dismiss</button></div></div>`;document.getElementById('accEmail').value='';document.getElementById('accPass').value='';document.getElementById('accName').selectedIndex=0}
function copyAcctCred(text){navigator.clipboard.writeText(text.replace(/\\n/g,'\n')).then(()=>{const btns=document.querySelectorAll('.acct-copy-btn-cred');btns.forEach(b=>{b.textContent='✓ Copied!';setTimeout(()=>{b.innerHTML='&#128203; Copy Credentials'},2000)})}).catch(()=>{prompt('Copy credentials:',text.replace(/\\n/g,'\n'))})}
function buildAccountList(){const area=document.getElementById('acctDashArea');if(!area)return;const accts=JSON.parse(localStorage.getItem('st_bom_accounts')||'[]');const users=JSON.parse(localStorage.getItem('st_users')||'{}');const totalAccts=accts.length;const activeAccts=accts.filter(a=>a.lastLogin).length;const neverLogged=totalAccts-activeAccts;let h=`<div class="acct-summary-bar"><div class="acct-summary-item"><div class="acct-sum-val">${totalAccts}</div><div class="acct-sum-lbl">Total Accounts</div></div><div class="acct-summary-item" style="border-top-color:#2e7d32"><div class="acct-sum-val" style="color:#2e7d32">${activeAccts}</div><div class="acct-sum-lbl">Active (Logged In)</div></div><div class="acct-summary-item" style="border-top-color:#e65100"><div class="acct-sum-val" style="color:#e65100">${neverLogged}</div><div class="acct-sum-lbl">Never Logged In</div></div></div>`;if(!accts.length){h+=`<div class="acct-empty"><div class="acct-empty-icon">&#128100;</div><p>No BOM accounts created yet.<br>Use the form above to create accounts for BOM members.</p></div>`;area.innerHTML=h;return}h+=`<table class="acct-table"><tr><th>#</th><th>Member</th><th>Email</th><th>Password</th><th>Created</th><th>Status</th><th>Actions</th></tr>`;accts.forEach((a,i)=>{const dt=a.createdAt?new Date(a.createdAt).toLocaleDateString():'—';const statusCls=a.lastLogin?'acct-status-active':'acct-status-never';const statusTxt=a.lastLogin?'Active':'Never Logged In';const pw=a.password||users[a.email]||'—';const credText=`BOM Portal Login\\nName: ${(a.name||'').replace(/'/g,"\\'")}\\nEmail: ${a.email}\\nPassword: ${pw}\\nURL: https://suntower.in`;const wpText=encodeURIComponent(`🏢 Sun Tower BOM Portal\n\nDear ${a.name||a.email},\n\nYour BOM account:\n📧 Email: ${a.email}\n🔑 Password: ${pw}\n🔗 URL: https://suntower.in\n\nPlease login and change your password.\n\n— Sun Tower RWA Admin`);h+=`<tr><td>${i+1}</td><td><strong>${a.name||'—'}</strong>${a.flat?'<br><span style="font-size:0.72rem;color:#999">'+a.flat+'</span>':''}</td><td style="font-size:0.8rem">${a.email}</td><td><span class="acct-pw-reveal" title="Click to copy" onclick="navigator.clipboard.writeText('${pw}');this.textContent='Copied!';setTimeout(()=>{this.textContent='${pw}'},1500)">${pw}</span></td><td style="font-size:0.8rem">${dt}</td><td><span class="acct-status ${statusCls}"><span class="acct-status-dot"></span> ${statusTxt}</span></td><td><div class="acct-action-group"><button class="btn btn-sm" style="background:var(--primary);color:#fff" onclick="copyAcctCred('${credText}')" title="Copy">&#128203;</button><button class="btn btn-sm" style="background:#25d366;color:#fff" onclick="window.open('https://wa.me/?text=${wpText}','_blank')" title="WhatsApp">&#128172;</button><button class="btn btn-sm" style="background:#e65100;color:#fff" onclick="editBOMAccount('${a.id}')" title="Edit">&#9998;</button><button class="btn btn-sm btn-danger" onclick="deleteBOMAccount('${a.id}')" title="Delete">&#128465;</button></div></td></tr>`});h+=`</table>`;area.innerHTML=h}
function editBOMAccount(id){const accts=JSON.parse(localStorage.getItem('st_bom_accounts')||'[]');const a=accts.find(x=>x.id===id);if(!a)return;document.getElementById('mTitle').textContent='Edit BOM Account';const lastLogin=a.lastLogin?new Date(a.lastLogin).toLocaleString():'Never';const created=a.createdAt?new Date(a.createdAt).toLocaleString():'—';const updated=a.updatedAt?new Date(a.updatedAt).toLocaleString():'—';document.getElementById('mBody').innerHTML=`<div class="acct-edit-form"><div class="acct-edit-row"><div class="form-group"><label>Member Name</label><input type="text" class="form-control" id="editAcctName" value="${a.name||''}"></div><div class="form-group"><label>Flat Number</label><input type="text" class="form-control" id="editAcctFlat" value="${a.flat||''}" style="text-transform:uppercase"></div></div><div class="form-group"><label>Email</label><input type="email" class="form-control" id="editAcctEmail" value="${a.email||''}"></div><div class="acct-edit-row"><div class="form-group"><label>Password</label><input type="text" class="form-control" id="editAcctPass" value="${a.password||''}"></div><div class="form-group"><label>Status</label><select class="form-control" id="editAcctStatus"><option value="never" ${a.status!=='active'?'selected':''}>Never Logged In</option><option value="active" ${a.status==='active'?'selected':''}>Active</option></select></div></div><div class="acct-edit-meta"><strong>Account ID:</strong> ${a.id}<br><strong>Created:</strong> ${created}<br><strong>Last Updated:</strong> ${updated}<br><strong>Last Login:</strong> ${lastLogin}</div><div class="acct-edit-actions"><button class="btn btn-primary" onclick="saveBOMAccountEdit('${a.id}')">&#128190; Save Changes</button><button class="btn btn-outline" onclick="closeModal()">Cancel</button></div></div>`;document.getElementById('noticeModal').classList.remove('hidden')}
async function saveBOMAccountEdit(id){const accts=JSON.parse(localStorage.getItem('st_bom_accounts')||'[]');const idx=accts.findIndex(x=>x.id===id);if(idx===-1){alert('Account not found');return}const name=document.getElementById('editAcctName').value.trim();const flat=document.getElementById('editAcctFlat').value.trim().toUpperCase();const email=document.getElementById('editAcctEmail').value.trim().toLowerCase();const pass=document.getElementById('editAcctPass').value;const status=document.getElementById('editAcctStatus').value;if(!email){alert('Email is required');return}if(pass&&pass.length<6){alert('Password must be at least 6 characters');return}
  // Sync password to Supabase Auth if changed
  if(pass){
    try{
      const listResp=await fetch(SUPABASE_URL+'/auth/v1/admin/users?page=1&per_page=200',{
        headers:{'Authorization':'Bearer '+SUPABASE_SERVICE_KEY,'apikey':SUPABASE_SERVICE_KEY}
      });
      if(listResp.ok){
        const listData=await listResp.json();
        const authUser=(listData.users||[]).find(u=>u.email&&u.email.toLowerCase()===accts[idx].email.toLowerCase());
        if(authUser){
          const pwResult=await updateAuthPassword(authUser.id,pass);
          if(!pwResult.ok){alert('Warning: Password not updated in auth system: '+(pwResult.error||''));return}
        }
      }
    }catch(e){console.warn('saveBOMAccountEdit: auth sync error',e)}
  }
  const oldEmail=accts[idx].email;accts[idx].name=name;accts[idx].flat=flat;accts[idx].email=email;if(pass)accts[idx].password=pass;accts[idx].status=status;accts[idx].updatedAt=new Date().toISOString();localStorage.setItem('st_bom_accounts',JSON.stringify(accts));supaSync('st_bom_accounts');const users=JSON.parse(localStorage.getItem('st_users')||'{}');if(oldEmail!==email){delete users[oldEmail]}if(pass)users[email]=pass;localStorage.setItem('st_users',JSON.stringify(users));supaSync('st_users');closeModal();buildAccountList()}
function deleteBOMAccount(id){const accts=JSON.parse(localStorage.getItem('st_bom_accounts')||'[]');const a=accts.find(x=>x.id===id);if(!a)return;if(!confirm(`Delete account for ${a.name||a.email}?\n\nThis will remove the account from the dashboard.\nThe login credentials in the system will also be removed.`))return;const idx=accts.findIndex(x=>x.id===id);accts.splice(idx,1);localStorage.setItem('st_bom_accounts',JSON.stringify(accts));supaSync('st_bom_accounts');const users=JSON.parse(localStorage.getItem('st_users')||'{}');delete users[a.email];localStorage.setItem('st_users',JSON.stringify(users));supaSync('st_users');buildAccountList()}
async function syncAllAccountsToAuth(){
  const statusDiv=document.getElementById('syncStatus');
  statusDiv.style.display='block';statusDiv.style.background='#e3f2fd';statusDiv.style.color='#1565c0';
  statusDiv.innerHTML='&#9203; Syncing accounts to Supabase Auth...';
  let created=0,existed=0,failed=0,errors=[];
  // 1. Sync BOM accounts
  const bomAccts=JSON.parse(localStorage.getItem('st_bom_accounts')||'[]');
  const bomUsers=JSON.parse(localStorage.getItem('st_users')||'{}');
  for(const a of bomAccts){
    const pw=a.password||bomUsers[a.email]||'Sun'+((a.flat||'BOM').replace('-',''))+'!';
    statusDiv.innerHTML=`&#9203; Syncing BOM: ${a.email}...`;
    const r=await createSupabaseUser(a.email,pw,'bom',{display_name:a.name||'',flat_no:a.flat||''});
    if(r.ok){if(r.existed){existed++}else{created++}}else{failed++;errors.push(a.email+': '+r.error)}
  }
  // 2. Sync Resident accounts
  const resAccts=JSON.parse(localStorage.getItem('st_residents')||'[]').filter(r=>r.status==='approved');
  const resUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');
  for(const r of resAccts){
    const pw=resUsers[r.email?.toLowerCase()]||r.tempPass||'Sun'+((r.flatNo||'User').replace('-',''))+'!';
    if(!r.email)continue;
    statusDiv.innerHTML=`&#9203; Syncing Resident: ${r.email}...`;
    const res=await createSupabaseUser(r.email,pw,'resident',{display_name:r.ownerName||'',flat_no:r.flatNo||'',mobile:r.mobile||''});
    if(res.ok){if(res.existed){existed++}else{created++}}else{failed++;errors.push(r.email+': '+res.error)}
  }
  // Show results
  let msg=`&#9989; Sync complete: ${created} created, ${existed} already existed, ${failed} failed`;
  if(errors.length)msg+=`<br><small style="color:#b71c1c">Errors: ${errors.join(', ')}</small>`;
  statusDiv.style.background=failed?'#fff3e0':'#e8f5e9';
  statusDiv.style.color=failed?'#e65100':'#2e7d32';
  statusDiv.innerHTML=msg;
  buildAccountList();loadApprovedResidents();
}
function trackBOMLogin(){if(!currentUser||!currentUser.email)return;const accts=JSON.parse(localStorage.getItem('st_bom_accounts')||'[]');const idx=accts.findIndex(a=>a.email.toLowerCase()===currentUser.email.toLowerCase());if(idx!==-1){accts[idx].lastLogin=new Date().toISOString();accts[idx].status='active';localStorage.setItem('st_bom_accounts',JSON.stringify(accts));supaSync('st_bom_accounts')}}
function loadAdminMsgs(){const c=document.getElementById('adminMsgs');if(db){db.collection('messages').orderBy('timestamp','desc').limit(20).get().then(s=>{if(s.empty){c.innerHTML='<p>No messages.</p>';return}let h='<table><tr><th>Date</th><th>From</th><th>Message</th></tr>';s.forEach(d=>{const x=d.data();h+=`<tr><td>${x.date||''}</td><td>${x.name||'Anon'}</td><td>${x.message}</td></tr>`});h+='</table>';c.innerHTML=h}).catch(()=>{loadLocalMsgs(c)})}else loadLocalMsgs(c)}
function loadLocalMsgs(c){const m=JSON.parse(localStorage.getItem('st_messages')||'[]');if(!m.length){c.innerHTML='<p>No messages.</p>';return}let h='<table><tr><th>Date</th><th>Message</th></tr>';m.forEach(x=>{h+=`<tr><td>${x.date||''}</td><td>${x.message}</td></tr>`});h+='</table>';c.innerHTML=h}
function uploadNotice(){const t=document.getElementById('nTitle').value.trim(),s=document.getElementById('nSummary').value.trim(),c=document.getElementById('nCat').value,d=document.getElementById('nDate').value,fl=document.getElementById('nFile').files[0],suc=document.getElementById('nSuc');if(!t){alert('Enter title');return}const n={title:t,summary:s,category:c,date:d||new Date().toISOString().split('T')[0],fileUrl:'',fileType:''};if(fl&&storage){const r=storage.ref('notices/'+Date.now()+'_'+fl.name);r.put(fl).then(x=>x.ref.getDownloadURL()).then(u=>{n.fileUrl=u;n.fileType=fl.type.includes('pdf')?'pdf':'image';return db.collection('notices').add(n)}).then(()=>{suc.textContent='Uploaded!';suc.style.display='block';document.getElementById('nTitle').value=''}).catch(e=>alert('Error: '+e.message))}else{if(fl){const r=new FileReader();r.onload=e=>{n.fileUrl=e.target.result;n.fileType=fl.type.includes('pdf')?'pdf':'image';const ex=JSON.parse(localStorage.getItem('st_notices')||'[]');ex.unshift(n);localStorage.setItem('st_notices',JSON.stringify(ex));supaSync('st_notices');suc.textContent='Saved!';suc.style.display='block';document.getElementById('nTitle').value=''};r.readAsDataURL(fl)}else{const ex=JSON.parse(localStorage.getItem('st_notices')||'[]');ex.unshift(n);localStorage.setItem('st_notices',JSON.stringify(ex));supaSync('st_notices');suc.textContent='Saved!';suc.style.display='block';document.getElementById('nTitle').value=''}}}

// ===== NOTICES =====
function loadNotices(){if(db){db.collection('notices').orderBy('date','desc').get().then(s=>{notices=s.docs.map(d=>({id:d.id,...d.data()}));renderN(notices)}).catch(()=>renderLocalN())}else renderLocalN()}
function renderLocalN(){notices=JSON.parse(localStorage.getItem('st_notices')||'[]');renderN(notices)}
function isBOMLoggedIn(){return !!currentUser}
function renderN(l){const g=document.getElementById('noticeGrid');const isBOM=isBOMLoggedIn();const filtered=isBOM?l:l.filter(n=>n.category!=='Escalation');const escBtn=document.getElementById('escFilterBtn');if(escBtn)escBtn.style.display=isBOM?'':'none';const badge=document.getElementById('escalationBadge');if(badge)badge.style.display=isBOM&&badge.textContent!=='0'?'inline':'none';if(!filtered.length){g.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-light)"><div style="font-size:3rem;margin-bottom:10px">&#128196;</div><p>No notices yet.</p></div>';return}const cc={General:'#1a237e',Financial:'#004d40',Maintenance:'#e65100',Event:'#4a148c',Emergency:'#b71c1c',Meeting:'#01579b',Escalation:'#b71c1c'};g.innerHTML=filtered.map((n,i)=>{const oi=l.indexOf(n);return `<div class="notice-card" onclick="openN(${oi})" style="border-top-color:${cc[n.category]||'#1a237e'}"><div class="notice-body"><div class="notice-date">${n.date||''}</div><div class="notice-title">${n.title||'Notice'}</div><div class="notice-summary">${n.summary||''}</div><div class="notice-cat"><span class="badge" style="background:${cc[n.category]||'#1a237e'};font-size:0.7rem">${n.category||'General'}</span></div></div></div>`}).join('')}
function filterN(c,el){document.querySelectorAll('.notice-filter-btn').forEach(b=>b.classList.remove('active'));el.classList.add('active');if(c==='All')renderN(notices);else renderN(notices.filter(n=>n.category===c))}
function openN(i){const n=notices[i];if(!n)return;document.getElementById('mTitle').textContent=n.title||'Notice';const b=document.getElementById('mBody');if(n.fileUrl){if(n.fileType==='pdf'||n.fileUrl.includes('.pdf'))b.innerHTML=`<iframe src="${n.fileUrl}" style="width:100%;min-height:600px;border:none"></iframe>`;else b.innerHTML=`<img src="${n.fileUrl}" style="max-width:100%">`}else b.innerHTML=`<div style="padding:20px"><p><strong>Date:</strong> ${n.date||''}</p><p><strong>Category:</strong> ${n.category||''}</p><p style="margin-top:15px">${n.summary||''}</p></div>`;document.getElementById('noticeModal').classList.remove('hidden')}
function closeModal(){document.getElementById('noticeModal').classList.add('hidden')}

// ===== CHATBOT =====
function toggleChat(){document.getElementById('chatPanel').classList.toggle('open')}
function sendChat(){const i=document.getElementById('chatIn'),m=i.value.trim();if(!m)return;const c=document.getElementById('chatMsgs');c.innerHTML+=`<div class="chat-msg"><div class="chat-msg-user">${m}</div></div>`;i.value='';const d={message:m,name:'Resident',date:new Date().toLocaleDateString(),timestamp:new Date()};if(db)db.collection('messages').add(d);else{const ms=JSON.parse(localStorage.getItem('st_messages')||'[]');ms.push(d);localStorage.setItem('st_messages',JSON.stringify(ms));supaSync('st_messages')}setTimeout(()=>{c.innerHTML+=`<div class="chat-msg"><div class="chat-msg-bot">Thank you! BOM has been notified. For urgent matters call 0120-4311286.</div></div>`;c.scrollTop=c.scrollHeight},1000);c.scrollTop=c.scrollHeight}
function toggleRsec(s){document.querySelectorAll('[id^="rs_"]').forEach(el=>el.style.display='none');const el=document.getElementById('rs_'+s);if(el)el.style.display='block';if(s==='bominfo')buildResElectionTable();if(s==='projects')buildResProjectList()}
function buildResElectionTable(){const t=document.getElementById('resElectionTable');if(!t)return;const pc={'President':'badge-president','Vice President':'badge-vp','Gen Secretary':'badge-gs','Vice Gen Secretary':'badge-vgs','Treasurer':'badge-treasurer','Vice Treasurer':'badge-vt','Joint Secretary':'badge-vgs','Sport Secretary':'badge-info','Culture Secretary':'badge-info','Spokesperson':'badge-warning','Chairman':'badge-president','Co-Chairman':'badge-vp','PRO':'badge-info','Advisor':'badge-vt','Member':'badge-member'};let h='<tr><th>#</th><th>Name</th><th>Flat</th><th>Votes</th><th>Position</th></tr>';EM.forEach((m,i)=>{const mem=members[i];const pos=mem&&mem.position?mem.position:'To be elected';const cls=pc[pos]||'badge-success';h+=`<tr style="background:#e8f5e9"><td>${i+1}</td><td><strong>${m.name}</strong></td><td>${m.flat}</td><td><strong>${m.v}</strong></td><td><span class="badge ${cls}">${pos}</span></td></tr>`});t.innerHTML=h}
function submitComp(){const d=document.getElementById('cDesc').value.trim();if(!d){alert('Enter description');return}const data={name:document.getElementById('cName').value,flat:document.getElementById('cFlat').value,category:document.getElementById('cCat').value,description:d,status:'Pending',date:new Date().toISOString()};if(db)db.collection('complaints').add(data).then(()=>{document.getElementById('cSuc').textContent='Submitted!';document.getElementById('cSuc').style.display='block'});else{document.getElementById('cSuc').textContent='Submitted! (saved locally)';document.getElementById('cSuc').style.display='block'}}

// ===== RESIDENT AUTH =====
let pendingOTP={};
function showResidentAuth(mode){document.getElementById('residentAuthOverlay').classList.remove('hidden');if(mode==='register'){document.getElementById('resLoginForm').style.display='none';document.getElementById('resRegForm').style.display='block';document.getElementById('resForgotForm').style.display='none'}else if(mode==='forgot'){document.getElementById('resLoginForm').style.display='none';document.getElementById('resRegForm').style.display='none';document.getElementById('resForgotForm').style.display='block'}else{document.getElementById('resLoginForm').style.display='block';document.getElementById('resRegForm').style.display='none';document.getElementById('resForgotForm').style.display='none'}}
function hideResidentAuth(){document.getElementById('residentAuthOverlay').classList.add('hidden')}
function showResLoginForm(){showResidentAuth('login')}
function showResRegForm(){showResidentAuth('register')}
function showResForgotPw(){showResidentAuth('forgot')}

async function doResidentLogin(){const e=document.getElementById('resLoginEmail').value.trim(),p=document.getElementById('resLoginPassword').value,flat=document.getElementById('resLoginFlat').value.trim().toUpperCase(),err=document.getElementById('resLoginError'),suc=document.getElementById('resLoginSuccess');err.style.display='none';suc.style.display='none';if(!e||!p){err.textContent='Enter email and password';err.style.display='block';return}
// Supabase Auth login (same auth system for all roles)
const result=await SunAuth.login(e,p);
if(result.error){err.textContent=result.error.message||'Invalid email or password. Contact admin if you need access.';err.style.display='block';return}
const profile=result.data.profile;
if(!profile||profile.role==='admin'||profile.role==='bom'){
  // This is a BOM/admin account, redirect to BOM portal
  currentUser={email:result.data.user.email,id:result.data.user.id};
  isAdmin=result.data.role==='admin';
  suc.textContent='Redirecting to BOM Portal...';suc.style.display='block';
  setTimeout(()=>{hideResidentAuth();switchTab('bom')},600);return}
// Resident login
residentUser={ownerName:profile.display_name||e.split('@')[0],flatNo:profile.flat_no||flat||'',email:e.toLowerCase(),status:'approved',permissions:profile.committees?{read:true,write:true}:{read:true,write:false}};
currentUser={email:result.data.user.email,id:result.data.user.id};
var pt=document.getElementById('tabPolicy');if(pt)pt.style.display='';
var nt=document.getElementById('tabNotices');if(nt)nt.style.display='';
suc.textContent='Welcome, '+(profile.display_name||'Resident')+'!';suc.style.display='block';
setTimeout(()=>{hideResidentAuth();switchTab('resident')},600)}

function unlockResident(){document.getElementById('residentLocked').style.display='none';document.getElementById('residentContent').style.display='block';if(residentUser){document.getElementById('residentNameDisplay').textContent=residentUser.ownerName||'';document.getElementById('residentFlatDisplay').textContent=residentUser.flatNo?' | Flat: '+residentUser.flatNo:''}document.getElementById('chatWidget').style.display='block'}

function doResidentLogout(){residentUser=null;localStorage.removeItem('st_resident_user');document.getElementById('residentLocked').style.display='block';document.getElementById('residentContent').style.display='none';document.getElementById('chatWidget').style.display='none';var pt=document.getElementById('tabPolicy');if(pt)pt.style.display='none';var nt=document.getElementById('tabNotices');if(nt)nt.style.display='none'}

async function submitResidentReg(){const name=document.getElementById('regOwnerName').value.trim(),flat=document.getElementById('regFlatNo').value.trim(),mob=document.getElementById('regMobile').value.trim(),email=document.getElementById('regEmail').value.trim(),err=document.getElementById('resRegError'),suc=document.getElementById('resRegSuccess');err.style.display='none';suc.style.display='none';if(!name||!flat||!mob||!email){err.textContent='All fields are required';err.style.display='block';return}if(!/\S+@\S+\.\S+/.test(email)){err.textContent='Enter a valid email address';err.style.display='block';return}if(mob.length<10){err.textContent='Enter a valid 10-digit mobile number';err.style.display='block';return}
// Submit to Supabase registration_requests table
const result=await SunData.submitRegistration({ownerName:name,flatNo:flat.toUpperCase(),mobile:mob,email:email});
if(result.error){
  if(result.error.message&&result.error.message.includes('duplicate')){
    err.textContent='This flat/email is already registered.';err.style.display='block';
  }else{
    // Fallback to legacy localStorage
    const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');
    const req={id:'REG_'+Date.now(),ownerName:name,flatNo:flat.toUpperCase(),mobile:mob,email:email.toLowerCase(),status:'pending',permissions:{read:true,write:false},requestDate:new Date().toISOString()};
    residents.push(req);localStorage.setItem('st_residents',JSON.stringify(residents));supaSync('st_residents');
    suc.textContent='Registration submitted! Admin will verify and approve your account.';suc.style.display='block';
  }
}else{
  suc.textContent='Registration request submitted! Admin will verify and approve your account. You will receive login credentials after approval.';suc.style.display='block';
}
document.getElementById('regOwnerName').value='';document.getElementById('regFlatNo').value='';document.getElementById('regMobile').value='';document.getElementById('regEmail').value=''}

async function sendResidentOTP(){const email=document.getElementById('resForgotEmail').value.trim(),err=document.getElementById('resForgotError'),suc=document.getElementById('resForgotSuccess');err.style.display='none';suc.style.display='none';if(!email){err.textContent='Enter your registered email';err.style.display='block';return}
// Use Supabase Auth password reset (sends email link)
const result=await SunAuth.resetPassword(email);
if(result.error){err.textContent=result.error.message||'Email not found.';err.style.display='block';return}
suc.innerHTML='A password reset link has been sent to <strong>'+email+'</strong>.<br><span style="font-size:0.85rem;color:#666">Check your email and click the link to set a new password. Check spam folder if not found.</span>';suc.style.display='block'}

function verifyOTPResetPass(){const otp=document.getElementById('resOtpInput').value.trim(),np=document.getElementById('resNewPass').value,cf=document.getElementById('resConfirmPass').value,err=document.getElementById('resForgotError'),suc=document.getElementById('resForgotSuccess');err.style.display='none';suc.style.display='none';if(!otp||!np||!cf){err.textContent='All fields required';err.style.display='block';return}if(np.length<6){err.textContent='Password must be at least 6 characters';err.style.display='block';return}if(np!==cf){err.textContent='Passwords do not match';err.style.display='block';return}if(!pendingOTP.otp||otp!==pendingOTP.otp){err.textContent='Invalid OTP. Please try again.';err.style.display='block';return}if(Date.now()>pendingOTP.expires){err.textContent='OTP expired. Please request a new one.';err.style.display='block';return}const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');rUsers[pendingOTP.email]=np;localStorage.setItem('st_res_users',JSON.stringify(rUsers));supaSync('st_res_users');pendingOTP={};suc.textContent='Password reset successfully! You can now login with your new password.';suc.style.display='block';document.getElementById('resForgotStep2').style.display='none';document.getElementById('resForgotStep1').style.display='block';document.getElementById('resOtpInput').value='';document.getElementById('resNewPass').value='';document.getElementById('resConfirmPass').value='';setTimeout(()=>showResLoginForm(),2000)}

// ===== ADMIN: RESIDENT MANAGEMENT =====
async function loadRegRequests(){const area=document.getElementById('regRequestsArea');
  // Merge Supabase registration_requests + localStorage st_residents
  let pending=[];
  try{
    const sbReqs=await SunData.getRegistrationRequests('pending');
    sbReqs.forEach(r=>{pending.push({id:r.id,ownerName:r.owner_name,flatNo:r.flat_no,mobile:r.mobile,email:r.email,requestDate:r.request_date,source:'supabase'});});
  }catch(e){console.warn('loadRegRequests: Supabase fetch failed',e);}
  // Also check localStorage for legacy entries
  const lsResidents=JSON.parse(localStorage.getItem('st_residents')||'[]');
  const lsPending=lsResidents.filter(r=>r.status==='pending');
  lsPending.forEach(r=>{
    if(!pending.find(p=>p.email.toLowerCase()===r.email.toLowerCase())){
      pending.push({id:r.id,ownerName:r.ownerName,flatNo:r.flatNo,mobile:r.mobile,email:r.email,requestDate:r.requestDate,source:'local'});
    }
  });
  if(!pending.length){area.innerHTML='<p style="color:var(--text-light);text-align:center;padding:15px">No pending registration requests.</p>';return}
  let h='<table><tr><th>Date</th><th>Owner Name</th><th>Flat</th><th>Mobile</th><th>Email</th><th>Read</th><th>Write</th><th>Action</th></tr>';
  pending.forEach(r=>{const dt=r.requestDate?new Date(r.requestDate).toLocaleDateString():'';h+=`<tr><td>${dt}</td><td><strong>${r.ownerName}</strong></td><td>${r.flatNo}</td><td>${r.mobile}</td><td style="font-size:0.8rem">${r.email}</td><td><input type="checkbox" id="perm_r_${r.id}" checked></td><td><input type="checkbox" id="perm_w_${r.id}"></td><td><button class="btn btn-sm" style="background:#00695c;color:#fff;margin:2px" onclick="approveResident('${r.id}')">Approve</button><button class="btn btn-sm btn-danger" style="margin:2px" onclick="rejectResident('${r.id}')">Reject</button></td></tr>`});
  h+='</table>';area.innerHTML=h}

async function approveResident(id){
  const readPerm=document.getElementById('perm_r_'+id)?.checked??true;
  const writePerm=document.getElementById('perm_w_'+id)?.checked??false;
  try{
    // Find the registration request data
    let reqData=null;
    // Check Supabase registration_requests
    try{
      const sbReqs=await SunData.getRegistrationRequests('pending');
      reqData=sbReqs.find(r=>r.id===id);
      if(reqData){reqData={email:reqData.email,ownerName:reqData.owner_name,flatNo:reqData.flat_no,mobile:reqData.mobile,source:'supabase'};}
    }catch(e){}
    // Check localStorage
    if(!reqData){
      const lsResidents=JSON.parse(localStorage.getItem('st_residents')||'[]');
      const lsReq=lsResidents.find(r=>r.id===id);
      if(lsReq){reqData={email:lsReq.email,ownerName:lsReq.ownerName,flatNo:lsReq.flatNo,mobile:lsReq.mobile,source:'local'};}
    }
    if(!reqData||!reqData.email){alert('Registration request not found');return}
    // Generate temp password: Sun + FlatNo (no dash) + !
    const tempPass='Sun'+(reqData.flatNo||'User').replace(/-/g,'')+'!';
    // Create Supabase Auth user directly via Admin API
    const result=await createSupabaseUser(reqData.email,tempPass,'resident',{
      display_name:reqData.ownerName||'',flat_no:reqData.flatNo||'',mobile:reqData.mobile||''
    });
    if(!result.ok){
      alert('APPROVAL FAILED\n\nCould not create auth user: '+(result.error||'Unknown error'));
      loadRegRequests();return;
    }
    // Update registration request status in Supabase
    if(reqData.source==='supabase'){
      try{await SunData.updateRegistrationRequest(id,{status:'approved'});}catch(e){console.warn('Could not update request status:',e);}
    }
    // Also update localStorage for admin panel display
    const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');
    const idx=residents.findIndex(r=>r.id===id);
    if(idx!==-1){residents[idx].status='approved';residents[idx].permissions={read:readPerm,write:writePerm};residents[idx].approvedDate=new Date().toISOString();residents[idx].tempPass=tempPass;localStorage.setItem('st_residents',JSON.stringify(residents));supaSync('st_residents');}
    // Also store in st_res_users for display
    const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');
    rUsers[reqData.email.toLowerCase()]=tempPass;
    localStorage.setItem('st_res_users',JSON.stringify(rUsers));supaSync('st_res_users');
    alert('APPROVED!\n\nResident: '+(reqData.ownerName||reqData.email)+'\nFlat: '+(reqData.flatNo||'')+'\nEmail: '+reqData.email+'\n\nLogin Password: '+tempPass+'\n\nShare this password with the resident.');
    loadRegRequests();loadApprovedResidents();
  }catch(x){alert('Error: '+x.message)}}

function rejectResident(id){if(!confirm('Reject this registration request?'))return;const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const idx=residents.findIndex(r=>r.id===id);if(idx===-1)return;residents.splice(idx,1);localStorage.setItem('st_residents',JSON.stringify(residents));supaSync('st_residents');if(db)db.collection('residents').doc(id).delete().catch(()=>{});loadRegRequests()}

let _approvedResidents=[];
async function loadApprovedResidents(){const area=document.getElementById('approvedResidentsArea');
  _approvedResidents=[];
  const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');
  // Fetch from Supabase profiles (resident role)
  try{
    const sbProfiles=await SunData.getProfiles('resident');
    sbProfiles.forEach(p=>{_approvedResidents.push({id:p.id,ownerName:p.display_name||p.email,flatNo:p.flat_no||'',mobile:p.mobile||'',email:p.email,createdAt:p.created_at||'',updatedAt:p.updated_at||'',status:p.status||'active',source:'supabase'});});
  }catch(e){console.warn('loadApprovedResidents: Supabase fetch failed',e);}
  // Also check localStorage for legacy entries
  const lsResidents=JSON.parse(localStorage.getItem('st_residents')||'[]');
  const lsApproved=lsResidents.filter(r=>r.status==='approved');
  lsApproved.forEach(r=>{
    if(!_approvedResidents.find(a=>a.email.toLowerCase()===r.email.toLowerCase())){
      _approvedResidents.push({id:r.id,ownerName:r.ownerName,flatNo:r.flatNo,mobile:r.mobile,email:r.email,createdAt:r.approvedDate||r.requestDate||'',updatedAt:'',status:'active',tempPass:r.tempPass,source:'local'});
    }
  });
  // Summary cards (BOM-style)
  const total=_approvedResidents.length;
  const authCount=_approvedResidents.filter(r=>r.source==='supabase').length;
  const legacyCount=total-authCount;
  let h=`<div class="acct-summary-bar"><div class="acct-summary-item"><div class="acct-sum-val">${total}</div><div class="acct-sum-lbl">Total Residents</div></div><div class="acct-summary-item" style="border-top-color:#2e7d32"><div class="acct-sum-val" style="color:#2e7d32">${authCount}</div><div class="acct-sum-lbl">With Login (Auth)</div></div><div class="acct-summary-item" style="border-top-color:#e65100"><div class="acct-sum-val" style="color:#e65100">${legacyCount}</div><div class="acct-sum-lbl">Legacy (No Auth)</div></div></div>`;
  if(!total){h+=`<div class="acct-empty"><div class="acct-empty-icon">&#128101;</div><p>No approved residents yet.<br>Approve registration requests above to add residents.</p></div>`;area.innerHTML=h;return}
  h+=`<table class="acct-table"><tr><th>#</th><th>Name</th><th>Flat</th><th>Mobile</th><th>Email</th><th>Password</th><th>Source</th><th>Actions</th></tr>`;
  _approvedResidents.forEach((r,i)=>{
    const pw=rUsers[r.email.toLowerCase()]||r.tempPass||'—';
    const srcBadge=r.source==='supabase'?'<span class="acct-status acct-status-active"><span class="acct-status-dot"></span> Auth</span>':'<span class="acct-status acct-status-never"><span class="acct-status-dot"></span> Legacy</span>';
    const credText=`Resident Portal Login\\nName: ${(r.ownerName||'').replace(/'/g,"\\'")}\\nFlat: ${r.flatNo}\\nEmail: ${r.email}\\nPassword: ${pw}\\nURL: https://suntower.in`;
    const wpText=encodeURIComponent(`🏢 Sun Tower Resident Portal\n\nDear ${r.ownerName||r.email},\n\nYour resident account:\n📧 Email: ${r.email}\n🔑 Password: ${pw}\n🏠 Flat: ${r.flatNo}\n🔗 URL: https://suntower.in\n\nPlease login and change your password.\n\n— Sun Tower RWA Admin`);
    const safeId=r.id.replace(/'/g,"\\'");
    h+=`<tr>
      <td>${i+1}</td>
      <td><strong>${r.ownerName||'—'}</strong></td>
      <td>${r.flatNo}</td>
      <td style="font-size:0.8rem">${r.mobile||'—'}</td>
      <td style="font-size:0.8rem">${r.email}</td>
      <td><span class="acct-pw-reveal" title="Click to copy" onclick="navigator.clipboard.writeText('${pw}');this.textContent='Copied!';setTimeout(()=>{this.textContent='${pw}'},1500)">${pw}</span></td>
      <td>${srcBadge}</td>
      <td><div class="acct-action-group">
        <button class="btn btn-sm" style="background:var(--primary);color:#fff" onclick="copyAcctCred('${credText}')" title="Copy Credentials">&#128203;</button>
        <button class="btn btn-sm" style="background:#25d366;color:#fff" onclick="window.open('https://wa.me/?text=${wpText}','_blank')" title="WhatsApp">&#128172;</button>
        <button class="btn btn-sm" style="background:#e65100;color:#fff" onclick="editResidentAccount('${safeId}')" title="Edit">&#9998;</button>
        <button class="btn btn-sm btn-danger" onclick="deleteResidentAccount('${safeId}')" title="Delete">&#128465;</button>
        <button class="btn btn-sm" style="background:#00695c;color:#fff;font-size:0.65rem" onclick="resetResPass('${safeId}')" title="Reset Password">&#128273; PW</button>
      </div></td>
    </tr>`;
  });
  h+=`</table>`;area.innerHTML=h}

function editResidentAccount(id){
  const r=_approvedResidents.find(x=>x.id===id);if(!r)return;
  const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');
  const pw=rUsers[r.email.toLowerCase()]||r.tempPass||'';
  const created=r.createdAt?new Date(r.createdAt).toLocaleString():'—';
  const updated=r.updatedAt?new Date(r.updatedAt).toLocaleString():'—';
  document.getElementById('mTitle').textContent='Edit Resident Account';
  document.getElementById('mBody').innerHTML=`<div class="acct-edit-form">
    <div class="acct-edit-row">
      <div class="form-group"><label>Name</label><input type="text" class="form-control" id="editResAcctName" value="${r.ownerName||''}"></div>
      <div class="form-group"><label>Flat Number</label><input type="text" class="form-control" id="editResAcctFlat" value="${r.flatNo||''}" style="text-transform:uppercase"></div>
    </div>
    <div class="acct-edit-row">
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="editResAcctEmail" value="${r.email||''}" ${r.source==='supabase'?'readonly style="background:#f5f5f5"':''}></div>
      <div class="form-group"><label>Mobile</label><input type="tel" class="form-control" id="editResAcctMobile" value="${r.mobile||''}"></div>
    </div>
    <div class="acct-edit-row">
      <div class="form-group"><label>Password</label><input type="text" class="form-control" id="editResAcctPass" value="${pw}"></div>
      <div class="form-group"><label>Status</label><select class="form-control" id="editResAcctStatus">
        <option value="active" ${r.status==='active'?'selected':''}>Active</option>
        <option value="suspended" ${r.status==='suspended'?'selected':''}>Suspended</option>
        <option value="inactive" ${r.status==='inactive'?'selected':''}>Inactive</option>
      </select></div>
    </div>
    <div class="acct-edit-meta">
      <strong>Account ID:</strong> ${r.id}<br>
      <strong>Source:</strong> ${r.source==='supabase'?'Supabase Auth':'Legacy (localStorage)'}<br>
      <strong>Created:</strong> ${created}<br>
      <strong>Last Updated:</strong> ${updated}
    </div>
    <div class="acct-edit-actions">
      <button class="btn btn-primary" onclick="saveResidentAccountEdit('${r.id.replace(/'/g,"\\'")}','${r.source}')">&#128190; Save Changes</button>
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
    </div>
  </div>`;
  document.getElementById('noticeModal').classList.remove('hidden');
}

// Create a Supabase Auth user directly via Admin API (replaces Edge Function)
async function createSupabaseUser(email, password, role, metadata){
  try{
    // 1. Create auth user
    const resp=await fetch(SUPABASE_URL+'/auth/v1/admin/users',{
      method:'POST',
      headers:{'Authorization':'Bearer '+SUPABASE_SERVICE_KEY,'apikey':SUPABASE_SERVICE_KEY,'Content-Type':'application/json'},
      body:JSON.stringify({
        email:email.trim().toLowerCase(),
        password:password,
        email_confirm:true,
        user_metadata:{role:role,display_name:metadata.display_name||'',flat_no:metadata.flat_no||''}
      })
    });
    if(resp.status===422){
      // User already exists — try to update password instead
      const listResp=await fetch(SUPABASE_URL+'/auth/v1/admin/users?page=1&per_page=200',{
        headers:{'Authorization':'Bearer '+SUPABASE_SERVICE_KEY,'apikey':SUPABASE_SERVICE_KEY}
      });
      if(listResp.ok){
        const listData=await listResp.json();
        const existing=(listData.users||[]).find(u=>u.email&&u.email.toLowerCase()===email.trim().toLowerCase());
        if(existing){
          await updateAuthPassword(existing.id,password);
          // Update profile
          await fetch(SUPABASE_URL+'/rest/v1/profiles?id=eq.'+existing.id,{
            method:'PATCH',
            headers:{'Authorization':'Bearer '+SUPABASE_SERVICE_KEY,'apikey':SUPABASE_SERVICE_KEY,'Content-Type':'application/json','Prefer':'return=representation'},
            body:JSON.stringify({display_name:metadata.display_name||'',flat_no:metadata.flat_no||'',mobile:metadata.mobile||'',role:role,status:'active'})
          });
          return {ok:true,userId:existing.id,existed:true};
        }
      }
      return {ok:false,error:'User already exists but could not be found'};
    }
    if(!resp.ok){
      const err=await resp.json().catch(()=>({}));
      return {ok:false,error:err.msg||'HTTP '+resp.status};
    }
    const userData=await resp.json();
    const userId=userData.id;
    // 2. Wait for profile trigger then update profile
    await new Promise(r=>setTimeout(r,1500));
    await fetch(SUPABASE_URL+'/rest/v1/profiles?id=eq.'+userId,{
      method:'PATCH',
      headers:{'Authorization':'Bearer '+SUPABASE_SERVICE_KEY,'apikey':SUPABASE_SERVICE_KEY,'Content-Type':'application/json','Prefer':'return=representation'},
      body:JSON.stringify({display_name:metadata.display_name||'',flat_no:metadata.flat_no||'',mobile:metadata.mobile||'',role:role,status:'active'})
    });
    return {ok:true,userId:userId,existed:false};
  }catch(e){
    console.error('createSupabaseUser error:',e);
    return {ok:false,error:e.message};
  }
}

// Update Supabase Auth password for a user (admin operation)
async function updateAuthPassword(userId, newPassword){
  try{
    const resp=await fetch(SUPABASE_URL+'/auth/v1/admin/users/'+userId,{
      method:'PUT',
      headers:{'Authorization':'Bearer '+SUPABASE_SERVICE_KEY,'apikey':SUPABASE_SERVICE_KEY,'Content-Type':'application/json'},
      body:JSON.stringify({password:newPassword})
    });
    if(!resp.ok){
      const err=await resp.json().catch(()=>({}));
      console.error('updateAuthPassword failed:',resp.status,err);
      return {ok:false,error:err.msg||'Failed to update password'};
    }
    return {ok:true};
  }catch(e){
    console.error('updateAuthPassword error:',e);
    return {ok:false,error:e.message};
  }
}

async function saveResidentAccountEdit(id,source){
  const name=document.getElementById('editResAcctName').value.trim();
  const flat=document.getElementById('editResAcctFlat').value.trim().toUpperCase();
  const email=document.getElementById('editResAcctEmail').value.trim().toLowerCase();
  const mobile=document.getElementById('editResAcctMobile').value.trim();
  const pass=document.getElementById('editResAcctPass').value;
  const status=document.getElementById('editResAcctStatus').value;
  if(!name){alert('Name is required');return}
  if(source==='supabase'){
    // Update Supabase profile
    try{
      const result=await SunData.updateProfileAdmin(id,{display_name:name,flat_no:flat,mobile:mobile,status:status});
      if(result.error){alert('Error: '+result.error.message);return}
    }catch(e){alert('Error: '+e.message);return}
  }else{
    // Update localStorage
    const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');
    const idx=residents.findIndex(r=>r.id===id);
    if(idx!==-1){
      residents[idx].ownerName=name;residents[idx].flatNo=flat;residents[idx].mobile=mobile;
      residents[idx].email=email;
      localStorage.setItem('st_residents',JSON.stringify(residents));supaSync('st_residents');
    }
  }
  // Update password — sync to Supabase Auth AND localStorage
  if(pass){
    if(source==='supabase'){
      const authResult=await updateAuthPassword(id,pass);
      if(!authResult.ok){alert('Warning: Could not update login password: '+(authResult.error||'Unknown error')+'\nProfile was saved but password unchanged.');return}
    }
    const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');
    const r=_approvedResidents.find(x=>x.id===id);
    if(r){
      const oldEmail=r.email.toLowerCase();
      if(oldEmail!==email)delete rUsers[oldEmail];
      rUsers[email]=pass;
      localStorage.setItem('st_res_users',JSON.stringify(rUsers));supaSync('st_res_users');
    }
  }
  closeModal();loadApprovedResidents();
}

function deleteResidentAccount(id){
  const r=_approvedResidents.find(x=>x.id===id);if(!r)return;
  if(!confirm(`Delete resident account for ${r.ownerName||r.email}?\n\nThis will remove the resident from the approved list.\nThe login credentials will also be removed.`))return;
  if(r.source==='supabase'){
    // Mark as inactive in Supabase (can't delete auth.users from frontend)
    SunData.updateProfileAdmin(id,{status:'suspended',role:'suspended'}).then(()=>{
      loadApprovedResidents();
    }).catch(e=>alert('Error: '+e.message));
  }else{
    // Remove from localStorage
    const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');
    const idx=residents.findIndex(x=>x.id===id);
    if(idx!==-1){residents.splice(idx,1);localStorage.setItem('st_residents',JSON.stringify(residents));supaSync('st_residents');}
  }
  // Remove password
  const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');
  delete rUsers[r.email.toLowerCase()];
  localStorage.setItem('st_res_users',JSON.stringify(rUsers));supaSync('st_res_users');
  loadApprovedResidents();
}

async function resetResPass(id){
  try{
    // Find resident from approved list (works for both Supabase and legacy)
    const r=_approvedResidents.find(x=>x.id===id);
    if(!r){alert('Resident not found');return}
    const newPass='Sun'+(r.flatNo||'User').replace('-','')+'!';
    // For Supabase auth users, update the actual auth password
    if(r.source==='supabase'||r.source==='auth'){
      const authResult=await updateAuthPassword(id,newPass);
      if(!authResult.ok){alert('Error resetting password: '+(authResult.error||'Unknown error'));return}
    }
    // Also update localStorage for display
    const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');
    rUsers[r.email.toLowerCase()]=newPass;
    localStorage.setItem('st_res_users',JSON.stringify(rUsers));supaSync('st_res_users');
    alert('Password reset for '+(r.ownerName||r.email)+':\n\nNew password: '+newPass+'\n\nShare with the resident.');
    loadApprovedResidents();
  }catch(x){alert('Error: '+x.message)}}

function revokeResident(id){if(!confirm('Revoke access for this resident? They will no longer be able to login.'))return;const residents=JSON.parse(localStorage.getItem('st_residents')||'[]');const idx=residents.findIndex(r=>r.id===id);if(idx===-1)return;const email=residents[idx].email.toLowerCase();residents.splice(idx,1);localStorage.setItem('st_residents',JSON.stringify(residents));supaSync('st_residents');const rUsers=JSON.parse(localStorage.getItem('st_res_users')||'{}');delete rUsers[email];localStorage.setItem('st_res_users',JSON.stringify(rUsers));supaSync('st_res_users');if(db)db.collection('residents').doc(id).delete().catch(()=>{});loadApprovedResidents()}

// ===== MANAGE RESIDENT DATA =====
let _allManagedResidents=[];

async function loadManageResidents(){
  const area=document.getElementById('mgrResidentsArea');
  const stats=document.getElementById('mgrResidentsStats');
  area.innerHTML='<p style="color:var(--text-light)">Loading residents...</p>';
  _allManagedResidents=[];

  // 1. Load from Supabase profiles (resident role) — these have auth accounts
  try{
    const sbProfiles=await SunData.getProfiles('resident');
    sbProfiles.forEach(p=>{
      _allManagedResidents.push({id:p.id,name:p.display_name||'',flat:p.flat_no||'',tower:p.flat_no?(p.flat_no.match(/^(ST[A-D][12])/i)||[])[1]||'':'',email:p.email||'',mobile:p.mobile||'',type:'',status:p.status||'active',source:'auth'});
    });
  }catch(e){console.warn('loadManageResidents: Supabase error',e);}

  // 2. Load from residents.json directory — these are the full MyGate dataset
  try{
    if(!window._residentData||!window._residentData.length){
      const resp=await fetch('data/residents.json');
      if(resp.ok) window._residentData=await resp.json();
    }
    if(window._residentData){
      window._residentData.forEach((r,i)=>{
        // Skip if already in auth list by matching email or name+flat
        const exists=_allManagedResidents.find(a=>
          (a.email&&r.mb&&a.email===r.mb)||(a.name.toLowerCase()===r.n.toLowerCase()&&a.flat===r.f)
        );
        if(!exists){
          _allManagedResidents.push({id:'dir_'+i,name:r.n||'',flat:r.f||'',tower:r.t||'',flatNo:r.fn||'',email:'',mobile:r.mb||'',type:r.tp||'',occupancy:r.oc||'',status:r.st||'Active',source:'directory'});
        }
      });
    }
  }catch(e){console.warn('loadManageResidents: directory error',e);}

  // Stats
  const authCount=_allManagedResidents.filter(r=>r.source==='auth').length;
  const dirCount=_allManagedResidents.filter(r=>r.source==='directory').length;
  const activeCount=_allManagedResidents.filter(r=>r.status==='active'||r.status==='Active').length;
  stats.innerHTML=`<div style="display:flex;gap:10px;flex-wrap:wrap">
    <div class="dir-stat-card"><div class="stat-num">${_allManagedResidents.length}</div><div class="stat-label">Total</div></div>
    <div class="dir-stat-card"><div class="stat-num" style="color:#2e7d32">${authCount}</div><div class="stat-label">With Login</div></div>
    <div class="dir-stat-card"><div class="stat-num" style="color:#1565c0">${dirCount}</div><div class="stat-label">Directory Only</div></div>
    <div class="dir-stat-card"><div class="stat-num" style="color:#00695c">${activeCount}</div><div class="stat-label">Active</div></div>
  </div>`;

  filterManagedResidents();
}

function filterManagedResidents(){
  const area=document.getElementById('mgrResidentsArea');
  const q=(document.getElementById('mgrSearchInput')?.value||'').toLowerCase();
  const tw=document.getElementById('mgrTowerFilter')?.value||'';

  let filtered=_allManagedResidents;
  if(q){filtered=filtered.filter(r=>(r.name+' '+r.flat+' '+r.email+' '+r.tower+' '+r.mobile).toLowerCase().includes(q));}
  if(tw){filtered=filtered.filter(r=>r.tower===tw);}

  if(!filtered.length){area.innerHTML='<p style="color:var(--text-light);text-align:center;padding:15px">No residents match your search.</p>';return;}

  // Show first 50 results (paginated)
  const showing=filtered.slice(0,50);
  let h=`<p style="font-size:0.82rem;color:#666;margin-bottom:8px">Showing <strong>${showing.length}</strong> of <strong>${filtered.length}</strong> residents</p>`;
  h+='<div class="dir-table-wrap"><table class="dir-table"><thead><tr><th>Name</th><th>Flat</th><th>Tower</th><th>Mobile</th><th>Type</th><th>Status</th><th>Source</th><th>Action</th></tr></thead><tbody>';
  showing.forEach(r=>{
    const srcBadge=r.source==='auth'?'<span class="dir-badge dir-badge-active">Auth</span>':'<span class="dir-badge" style="background:#e3f2fd;color:#1565c0">Directory</span>';
    const statusBadge=(r.status==='active'||r.status==='Active')?'<span class="dir-badge dir-badge-active">Active</span>':'<span class="dir-badge dir-badge-inactive">Inactive</span>';
    const typeBadge=r.type?`<span class="dir-badge ${r.type.includes('Owner')?'dir-badge-owner':r.type.includes('Tenant')?'dir-badge-tenant':'dir-badge-family'}">${r.type}</span>`:'—';
    h+=`<tr>
      <td><strong>${r.name}</strong></td>
      <td>${r.flat}</td>
      <td>${r.tower?'<span class="dir-tower-tag">'+r.tower+'</span>':''}</td>
      <td style="font-size:0.8rem">${r.mobile||'—'}</td>
      <td>${typeBadge}</td>
      <td>${statusBadge}</td>
      <td>${srcBadge}</td>
      <td><button class="btn btn-sm" style="background:#1565c0;color:#fff;font-size:0.72rem" onclick="editManagedResident('${r.id}')">Edit</button></td>
    </tr>`;
  });
  h+='</tbody></table></div>';
  if(filtered.length>50) h+=`<p style="text-align:center;margin-top:10px;color:#666;font-size:0.82rem">Refine your search to see more results (${filtered.length-50} hidden)</p>`;
  area.innerHTML=h;
}

function showAddResidentForm(){
  const area=document.getElementById('addResidentFormArea');
  if(area.style.display!=='none'){area.style.display='none';return;}
  area.style.display='block';
  area.innerHTML=`<div class="mgr-form-card">
    <h4 style="color:#1565c0;margin-bottom:12px">&#10133; Add New Resident</h4>
    <div class="grid-2">
      <div class="form-group"><label>Full Name *</label><input type="text" class="form-control" id="addResName" placeholder="e.g. Sh. Rajesh Kumar"></div>
      <div class="form-group"><label>Flat Number *</label><input type="text" class="form-control" id="addResFlat" placeholder="e.g. STC-504, STD-701"></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label>Tower *</label><select class="form-control" id="addResTower">
        <option value="">Select Tower</option>
        <option>STA1</option><option>STA2</option><option>STB1</option><option>STB2</option>
        <option>STC1</option><option>STC2</option><option>STD1</option><option>STD2</option>
      </select></div>
      <div class="form-group"><label>Mobile</label><input type="tel" class="form-control" id="addResMobile" placeholder="e.g. 9876543210"></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="addResEmail" placeholder="resident@email.com"></div>
      <div class="form-group"><label>Resident Type</label><select class="form-control" id="addResType">
        <option value="Owner">Owner</option><option value="Tenant">Tenant</option>
        <option value="Owner Family">Owner Family</option><option value="Tenant Family">Tenant Family</option>
      </select></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label>Occupancy</label><select class="form-control" id="addResOccupancy">
        <option value="Residing">Residing</option>
        <option value="Let out to one tenant">Let out to one tenant</option>
        <option value="Let out to multiple tenants">Let out to multiple tenants</option>
        <option value="Vacant">Vacant</option>
      </select></div>
      <div class="form-group"><label>Status</label><select class="form-control" id="addResStatus">
        <option value="Active">Active</option><option value="Inactive">Inactive</option>
      </select></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn btn-success" onclick="saveNewResident()">Save Resident</button>
      <button class="btn btn-secondary" onclick="document.getElementById('addResidentFormArea').style.display='none'">Cancel</button>
    </div>
    <div class="auth-error" id="addResErr" style="margin-top:10px"></div>
    <div class="auth-success" id="addResSuc" style="margin-top:10px"></div>
  </div>`;
}

async function saveNewResident(){
  const name=document.getElementById('addResName').value.trim();
  const flat=document.getElementById('addResFlat').value.trim().toUpperCase();
  const tower=document.getElementById('addResTower').value;
  const mobile=document.getElementById('addResMobile').value.trim();
  const email=document.getElementById('addResEmail').value.trim().toLowerCase();
  const type=document.getElementById('addResType').value;
  const occupancy=document.getElementById('addResOccupancy').value;
  const status=document.getElementById('addResStatus').value;
  const err=document.getElementById('addResErr');
  const suc=document.getElementById('addResSuc');
  err.style.display='none';suc.style.display='none';

  if(!name||!flat){err.textContent='Name and Flat Number are required.';err.style.display='block';return;}
  if(!tower){err.textContent='Please select a tower.';err.style.display='block';return;}

  // Add to residents.json data (in-memory) and also to localStorage backup
  const newEntry={n:name,f:tower+' '+flat.replace(tower+'-','').replace(tower,''),t:tower,fn:flat.replace(tower+'-','').replace(tower,'').trim(),tp:type,oc:occupancy,st:status,mb:mobile};

  // Update in-memory directory
  if(!window._residentData) window._residentData=[];
  window._residentData.push(newEntry);

  // Save to localStorage as backup
  const dirBackup=JSON.parse(localStorage.getItem('st_resident_directory')||'[]');
  dirBackup.push(newEntry);
  localStorage.setItem('st_resident_directory',JSON.stringify(dirBackup));

  // If email provided, also add to Supabase profiles
  if(email){
    try{
      const session=await supa.auth.getSession();
      const token=session.data.session?.access_token;
      // Try Edge Function to create auth user
      const resp=await fetch(SUPABASE_URL+'/functions/v1/approve-resident',{
        method:'POST',headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
        body:JSON.stringify({request_id:'MANUAL_'+Date.now(),permissions:{read:true,write:false},manual_create:{email:email,owner_name:name,flat_no:flat,mobile:mobile}})
      }).catch(()=>null);
      if(resp&&resp.ok){
        const result=await resp.json();
        suc.innerHTML='Resident <strong>'+name+'</strong> added with auth account!<br>Login: '+email+' / '+result.temp_password;
      }else{
        suc.innerHTML='Resident <strong>'+name+'</strong> added to directory.<br><span style="color:#e65100;font-size:0.82rem">Note: Auth account not created (Edge Function not deployed). Use the Python script to create login access.</span>';
      }
    }catch(e){
      suc.innerHTML='Resident <strong>'+name+'</strong> added to directory.';
    }
  }else{
    suc.innerHTML='Resident <strong>'+name+'</strong> added to directory successfully.';
  }
  suc.style.display='block';

  // Clear form
  document.getElementById('addResName').value='';
  document.getElementById('addResFlat').value='';
  document.getElementById('addResMobile').value='';
  document.getElementById('addResEmail').value='';

  // Refresh list
  loadManageResidents();
}

function editManagedResident(id){
  const r=_allManagedResidents.find(x=>x.id===id);
  if(!r)return;
  const area=document.getElementById('editResidentFormArea');
  area.style.display='block';
  area.scrollIntoView({behavior:'smooth',block:'start'});
  area.innerHTML=`<div class="mgr-form-card" style="border-color:#e65100">
    <h4 style="color:#e65100;margin-bottom:12px">&#9998; Edit Resident: ${r.name}</h4>
    <div class="grid-2">
      <div class="form-group"><label>Full Name *</label><input type="text" class="form-control" id="editResName" value="${r.name||''}"></div>
      <div class="form-group"><label>Flat *</label><input type="text" class="form-control" id="editResFlat" value="${r.flat||r.flatNo||''}"></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label>Tower</label><select class="form-control" id="editResTower">
        <option value="">Select</option>
        ${['STA1','STA2','STB1','STB2','STC1','STC2','STD1','STD2'].map(t=>'<option'+(t===r.tower?' selected':'')+'>'+t+'</option>').join('')}
      </select></div>
      <div class="form-group"><label>Mobile</label><input type="tel" class="form-control" id="editResMobile" value="${r.mobile||''}"></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="editResEmail" value="${r.email||''}" ${r.source==='auth'?'readonly style="background:#f5f5f5"':''}></div>
      <div class="form-group"><label>Type</label><select class="form-control" id="editResType">
        ${['Owner','Tenant','Owner Family','Tenant Family','Co-Owner','Multi Tenant'].map(t=>'<option'+(t===r.type?' selected':'')+'>'+t+'</option>').join('')}
      </select></div>
    </div>
    <div class="grid-2">
      <div class="form-group"><label>Occupancy</label><select class="form-control" id="editResOcc">
        ${['Residing','Let out to one tenant','Let out to multiple tenants','Vacant'].map(o=>'<option'+(o===(r.occupancy||'Residing')?' selected':'')+'>'+o+'</option>').join('')}
      </select></div>
      <div class="form-group"><label>Status</label><select class="form-control" id="editResStatus">
        <option ${(r.status==='active'||r.status==='Active')?'selected':''}>Active</option>
        <option ${(r.status==='inactive'||r.status==='Inactive')?'selected':''}>Inactive</option>
      </select></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn btn-success" onclick="saveManagedResident('${id}','${r.source}')">Save Changes</button>
      <button class="btn btn-secondary" onclick="document.getElementById('editResidentFormArea').style.display='none'">Cancel</button>
    </div>
    <div class="auth-error" id="editResErr" style="margin-top:10px"></div>
    <div class="auth-success" id="editResSuc" style="margin-top:10px"></div>
  </div>`;
}

async function saveManagedResident(id,source){
  const name=document.getElementById('editResName').value.trim();
  const flat=document.getElementById('editResFlat').value.trim();
  const tower=document.getElementById('editResTower').value;
  const mobile=document.getElementById('editResMobile').value.trim();
  const email=document.getElementById('editResEmail').value.trim();
  const type=document.getElementById('editResType').value;
  const occupancy=document.getElementById('editResOcc').value;
  const status=document.getElementById('editResStatus').value;
  const err=document.getElementById('editResErr');
  const suc=document.getElementById('editResSuc');
  err.style.display='none';suc.style.display='none';

  if(!name||!flat){err.textContent='Name and Flat are required.';err.style.display='block';return;}

  if(source==='auth'){
    // Update Supabase profile
    try{
      const result=await SunData.updateProfileAdmin(id,{display_name:name,flat_no:flat,mobile:mobile,status:status.toLowerCase()});
      if(result.error){err.textContent='Error: '+result.error.message;err.style.display='block';return;}
      suc.textContent='Profile updated in Supabase successfully!';suc.style.display='block';
    }catch(e){err.textContent='Error: '+e.message;err.style.display='block';return;}
  }else{
    // Update in-memory directory data
    const dirIdx=parseInt(id.replace('dir_',''));
    if(window._residentData&&window._residentData[dirIdx]){
      window._residentData[dirIdx]={n:name,f:tower+' '+(flat.replace(tower+'-','').replace(tower,'').trim()||flat),t:tower,fn:flat.replace(tower+'-','').replace(tower,'').trim()||flat,tp:type,oc:occupancy,st:status,mb:mobile};
    }
    // Also save edits to localStorage
    const edits=JSON.parse(localStorage.getItem('st_resident_edits')||'{}');
    edits[id]={n:name,f:tower+' '+(flat.replace(tower+'-','').replace(tower,'').trim()||flat),t:tower,fn:flat.replace(tower+'-','').replace(tower,'').trim()||flat,tp:type,oc:occupancy,st:status,mb:mobile};
    localStorage.setItem('st_resident_edits',JSON.stringify(edits));
    suc.textContent='Resident updated in directory!';suc.style.display='block';
  }

  // Refresh list after short delay
  setTimeout(()=>{document.getElementById('editResidentFormArea').style.display='none';loadManageResidents();},1000);
}

// ===== PROJECT TRACKER =====
const COMM_NAMES={A:'Security',B:'Housekeeping',C:'Fire Safety',D:'Facilities',E:'Revenue',F:'Infrastructure',G:'Legal'};
const COMM_COLORS={A:'#b71c1c',B:'#4a148c',C:'#1a237e',D:'#01579b',E:'#004d40',F:'#e65100',G:'#37474f'};
const STATUS_COLORS={'Planned':'#1565c0','In Progress':'#e65100','Tender':'#b71c1c','On Hold':'#616161','Completed':'#2e7d32'};
const COMM_ICONS={A:'&#128737;',B:'&#128700;',C:'&#128293;',D:'&#127968;',E:'&#128176;',F:'&#128679;',G:'&#9878;'};
const COMM_SOP={A:'CCTV, patrolling, Park Plus, welfare checks',B:'Cleaning, lifts, plants, shaft maintenance',C:'FAD panels, sprinklers, smoke detectors, AMC',D:'Library, medical, play areas, club house',E:'Dues, parking, advertising, ERP, rentals',F:'All 18 projects, tenders, renovations',G:'RWA compliance, UP Apartment Act, legal notices, disputes'};
let projCommFilter='All';
// ===== RBAC HELPERS =====
function getCurrentBOMMemberName(){if(!currentUser)return null;const m=members.find(x=>x.email&&x.email.toLowerCase()===currentUser.email.toLowerCase());return m?m.name:null}
function getMemberCommittees(name){const cm=loadCommitteeMembers();const r=[];Object.keys(cm).forEach(c=>{if(cm[c].convenor===name||cm[c].bomMember===name)r.push(c)});return r}
function canEditProject(p){if(SunAuth.isAdmin())return true;if(SunAuth.canEditCommittee(p.committee))return true;const cm=loadCommitteeMembers();if(!Object.keys(cm).length)return true;const name=getCurrentBOMMemberName();if(!name)return false;return getMemberCommittees(name).includes(p.committee)}
function getResidentCommitteesByFlat(flatNo){if(!flatNo)return[];const cm=loadCommitteeMembers();const r=[];const nf=flatNo.toUpperCase();Object.keys(cm).forEach(c=>{if(cm[c].residents&&cm[c].residents.some(x=>x&&x.toUpperCase().includes(nf)))r.push(c)});return r}

function buildResProjectList(){loadProjects();const a=document.getElementById('resProjectList');if(!a)return;let visProjcts=projects;let filterMsg='';if(residentUser&&residentUser.flatNo){const rc=getResidentCommitteesByFlat(residentUser.flatNo);if(rc.length>0){visProjcts=projects.filter(p=>rc.includes(p.committee));filterMsg=`<p style="margin-bottom:10px;font-size:0.85rem;color:#00695c"><strong>Showing projects for your committee(s): ${rc.map(c=>COMM_NAMES[c]).join(', ')}</strong></p>`}}let h=filterMsg+'<table style="width:100%"><tr><th>Project</th><th>Committee</th><th>Status</th><th>Progress</th><th>Timeline</th></tr>';visProjcts.forEach(p=>{const sc=STATUS_COLORS[p.status]||'#666';h+=`<tr style="cursor:pointer" onclick="openProjectDetail('${p.id}')"><td><strong>${p.name}</strong></td><td><span style="color:${COMM_COLORS[p.committee]||'#666'};font-weight:600">${COMM_NAMES[p.committee]||p.committee}</span></td><td><span class="badge" style="background:${sc}">${p.status}</span></td><td><div style="background:#e0e0e0;border-radius:8px;height:20px;width:100px;position:relative"><div style="background:${sc};height:100%;border-radius:8px;width:${p.progress}%"></div><span style="position:absolute;top:1px;width:100%;text-align:center;font-size:0.7rem;font-weight:700;color:${p.progress>50?'#fff':'#333'}">${p.progress}%</span></div></td><td>${p.timeline}</td></tr>`});h+='</table><p style="margin-top:10px;font-size:0.8rem;color:#999">Click any project for details</p>';a.innerHTML=h}

function openProjectDetail(id){loadProjects();const p=projects.find(x=>x.id===id);if(!p)return;ensureProjectFields(p);const sc=STATUS_COLORS[p.status]||'#666';const cc=COMM_COLORS[p.committee]||'#666';let updH='';if(p.updates&&p.updates.length){p.updates.slice().reverse().forEach(u=>{updH+=`<div style="border-left:3px solid ${cc};padding:8px 12px;margin:8px 0;background:#f5f5f5;border-radius:0 8px 8px 0"><div style="font-size:0.75rem;color:#999">${u.date} | ${u.by||'Committee'}</div><div style="margin-top:4px">${u.text}</div></div>`})}else updH='<p style="color:#999">No updates yet.</p>';let mtgH='';if(p.meetings&&p.meetings.length){p.meetings.slice().reverse().forEach(m=>{mtgH+=`<div style="border-left:3px solid #1a237e;padding:8px 12px;margin:8px 0;background:#e8eaf6;border-radius:0 8px 8px 0"><div style="font-size:0.75rem;color:#999">${m.date}</div><div style="font-weight:600">${m.attendees||''}</div><div style="margin-top:4px">${m.summary||''}</div></div>`})}else mtgH='<p style="color:#999">No meetings logged.</p>';let docH='';if(p.documents&&p.documents.length){p.documents.forEach(d=>{docH+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;margin:4px 0;background:#f5f5f5;border-radius:6px">&#128196; <a href="${d.url||'#'}" target="_blank" style="color:${cc};font-weight:600">${d.name}</a><span style="font-size:0.75rem;color:#999">${d.date||''}</span></div>`})}else docH='<p style="color:#999">No documents uploaded.</p>';const expTotal=p.expenses.reduce((s,e)=>s+(parseFloat(e.amount)||0),0);let expH='';if(p.expenses.length){expH+=`<table style="font-size:0.8rem;width:100%;margin:8px 0"><tr><th>Date</th><th>Description</th><th>Amount</th><th>BOM</th><th>GBM</th></tr>`;p.expenses.forEach(e=>{expH+=`<tr><td>${e.date||''}</td><td>${e.description}</td><td>Rs.${(parseFloat(e.amount)||0).toLocaleString('en-IN')}</td><td>${e.bomApproved?'<span style="color:#2e7d32">Yes</span>':'<span style="color:#999">No</span>'}</td><td>${e.gbmApproved?'<span style="color:#2e7d32">Yes</span>':'<span style="color:#999">No</span>'}</td></tr>`});expH+='</table>'}else expH='<p style="color:#999">No expenses recorded.</p>';let clH='';if(p.closureReport){clH=`<div style="padding:10px;background:#e8f5e9;border-radius:8px;border-left:3px solid #2e7d32"><p style="font-size:0.85rem"><strong>Summary:</strong> ${p.closureReport.summary}</p><p style="font-size:0.85rem"><strong>Final Expense:</strong> Rs. ${(parseFloat(p.closureReport.finalExpense)||0).toLocaleString('en-IN')} | <strong>Outcomes:</strong> ${p.closureReport.outcomes||''}</p><p style="font-size:0.75rem;color:#666">Closed: ${p.closureReport.closedDate} by ${p.closureReport.closedBy}</p><div style="margin-top:4px">${p.closureReport.bomApproved?'<span style="color:#2e7d32;font-size:0.75rem;font-weight:600">BOM Approved</span>':'<span style="color:#999;font-size:0.75rem">BOM Pending</span>'} | ${p.closureReport.gbmApproved?'<span style="color:#2e7d32;font-size:0.75rem;font-weight:600">GBM Approved</span>':'<span style="color:#999;font-size:0.75rem">GBM Pending</span>'}</div></div>`}document.getElementById('mTitle').textContent=p.name;document.getElementById('mBody').innerHTML=`<div style="padding:15px"><div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px"><span class="badge" style="background:${sc};font-size:0.85rem">${p.status}</span><span class="badge" style="background:${cc};font-size:0.85rem">Committee ${p.committee} - ${COMM_NAMES[p.committee]}</span><span style="color:#666;font-size:0.85rem">Timeline: ${p.timeline}</span><span style="color:#666;font-size:0.85rem">Budget: ${p.budget||'TBD'}</span></div><div style="margin-bottom:15px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>Progress</strong><span>${p.progress}%</span></div><div style="background:#e0e0e0;border-radius:10px;height:24px"><div style="background:linear-gradient(90deg,${cc},${sc});height:100%;border-radius:10px;width:${p.progress}%;transition:0.3s"></div></div></div><p style="color:#666;margin-bottom:20px">${p.description||''}</p><h4 style="color:${cc};border-bottom:2px solid ${cc};padding-bottom:5px;margin-bottom:10px">&#128221; Updates</h4>${updH}<h4 style="color:#1a237e;border-bottom:2px solid #1a237e;padding-bottom:5px;margin:20px 0 10px">&#128197; Meeting History</h4>${mtgH}<h4 style="color:#004d40;border-bottom:2px solid #004d40;padding-bottom:5px;margin:20px 0 10px">&#128196; Documents</h4>${docH}<h4 style="color:#004d40;border-bottom:2px solid #004d40;padding-bottom:5px;margin:20px 0 10px">&#128176; Expenses (Total: Rs. ${expTotal.toLocaleString('en-IN')})</h4>${expH}${p.closureReport?'<h4 style="color:#2e7d32;border-bottom:2px solid #2e7d32;padding-bottom:5px;margin:20px 0 10px">&#9989; Closure Report</h4>'+clH:''}</div>`;document.getElementById('noticeModal').classList.remove('hidden')}

function buildProjDash(){loadProjects();buildProjStatsBar();buildProjFilterBar();buildProjCreateForm();buildProjCards();runAIMonitor()}

function buildProjStatsBar(){const a=document.getElementById('projStatsBar');if(!a)return;const total=projects.length;const inProg=projects.filter(p=>p.status==='In Progress').length;const completed=projects.filter(p=>p.status==='Completed').length;const totalExp=projects.reduce((s,p)=>{ensureProjectFields(p);return s+p.expenses.reduce((es,e)=>es+(parseFloat(e.amount)||0),0)},0);a.innerHTML=`<div class="proj-stats-bar"><div class="proj-stat-card"><div class="stat-value">${total}</div><div class="stat-label">Total Projects</div></div><div class="proj-stat-card" style="border-top-color:#e65100"><div class="stat-value" style="color:#e65100">${inProg}</div><div class="stat-label">In Progress</div></div><div class="proj-stat-card" style="border-top-color:#2e7d32"><div class="stat-value" style="color:#2e7d32">${completed}</div><div class="stat-label">Completed</div></div><div class="proj-stat-card" style="border-top-color:#004d40"><div class="stat-value" style="color:#004d40">&#8377;${totalExp.toLocaleString('en-IN')}</div><div class="stat-label">Total Expenses</div></div></div>`}

function buildProjFilterBar(){const a=document.getElementById('projFilterBar');if(!a)return;let h='<div class="proj-filter-bar">';const allActive=projCommFilter==='All';h+=`<button class="proj-filter-btn" style="${allActive?'background:var(--primary);color:#fff;border-color:var(--primary)':''}" onclick="filterProjects('All')">All</button>`;Object.keys(COMM_NAMES).forEach(c=>{const active=projCommFilter===c;const col=COMM_COLORS[c]||'#666';h+=`<button class="proj-filter-btn" style="${active?'background:'+col+';color:#fff;border-color:'+col:'border-color:'+col+';color:'+col}" onclick="filterProjects('${c}')">${COMM_ICONS[c]||''} ${COMM_NAMES[c]}</button>`});h+='</div>';a.innerHTML=h}

function filterProjects(comm){projCommFilter=comm;buildProjFilterBar();buildProjCards()}

function buildProjCreateForm(){const a=document.getElementById('projCreateArea');if(!a)return;if(!currentUser){a.innerHTML='';return}a.innerHTML=`<div class="card" style="border-left:4px solid #2e7d32;margin-bottom:20px"><h3 style="color:#2e7d32;cursor:pointer;margin:0" onclick="document.getElementById('newProjForm').style.display=document.getElementById('newProjForm').style.display==='none'?'block':'none'">+ Create New Project <span style="font-size:0.8rem;color:#999">(click to expand)</span></h3><div id="newProjForm" style="display:none;margin-top:12px"><div class="grid-2"><div class="form-group"><label>Project Name *</label><input type="text" class="form-control" id="np_name" placeholder="e.g. Basement Waterproofing"></div><div class="form-group"><label>Committee *</label><select class="form-control" id="np_comm">${Object.keys(COMM_NAMES).map(c=>`<option value="${c}">${c} - ${COMM_NAMES[c]}</option>`).join('')}</select></div></div><div class="grid-2"><div class="form-group"><label>Timeline</label><input type="text" class="form-control" id="np_timeline" placeholder="e.g. Mar-Apr 2026"></div><div class="form-group"><label>Budget (Rs.)</label><input type="text" class="form-control" id="np_budget" placeholder="e.g. 50000"></div></div><div class="form-group"><label>Description</label><textarea class="form-control" id="np_desc" rows="2" placeholder="Brief project description"></textarea></div><button class="btn btn-success" onclick="createNewProject()">Create Project</button></div></div>`}

function buildProjCards(){const a=document.getElementById('projDashArea');if(!a)return;let filtered=projects;if(projCommFilter!=='All')filtered=projects.filter(p=>p.committee===projCommFilter);if(!filtered.length){a.innerHTML=`<div style="text-align:center;padding:40px;color:#999"><p style="font-size:1.2rem">No projects found${projCommFilter!=='All'?' for '+COMM_NAMES[projCommFilter]:''}</p></div>`;return}let h='<div class="grid-2">';filtered.forEach(p=>{ensureProjectFields(p);const sc=STATUS_COLORS[p.status]||'#666';const cc=COMM_COLORS[p.committee]||'#666';const canEdit=canEditProject(p);const lastUpd=p.updates&&p.updates.length?p.updates[p.updates.length-1].date:'Never';const expTotal=p.expenses.reduce((s,e)=>s+(parseFloat(e.amount)||0),0);const progColor=p.progress>=70?'#2e7d32':p.progress>=40?'#e65100':'#b71c1c';h+=`<div class="proj-summary-card" style="border-left-color:${cc}"><div class="proj-card-header"><div><h4 class="proj-card-title" style="color:${cc}">${p.name}</h4><div class="proj-card-committee" style="color:${cc}">${COMM_ICONS[p.committee]||''} Committee ${p.committee} &mdash; ${COMM_NAMES[p.committee]||''}</div></div><span class="badge" style="background:${sc};font-size:0.72rem;white-space:nowrap">${p.status}</span></div><div class="proj-card-progress"><div class="proj-card-progress-bar"><div class="proj-card-progress-fill" style="width:${p.progress}%;background:linear-gradient(90deg,${cc},${progColor})"></div><div class="proj-card-progress-text" style="color:${p.progress>45?'#fff':'#333'}">${p.progress}%</div></div></div><div class="proj-card-meta"><span>&#128197; <strong>${p.timeline||'TBD'}</strong></span><span>&#128176; <strong>${p.budget||'TBD'}</strong></span><span>&#128200; Rs.${expTotal.toLocaleString('en-IN')}</span><span>&#128221; ${lastUpd}</span></div><div class="proj-card-actions"><button class="proj-action-btn proj-action-btn-committee" onclick="openCommitteeModal('${p.committee}')">${COMM_ICONS[p.committee]||''} Committee</button><button class="proj-action-btn proj-action-btn-status" onclick="openStatusModal('${p.id}')">&#128202; Status &amp; Details</button>${canEdit?`<button class="proj-action-btn proj-action-btn-edit" onclick="openEditModal('${p.id}')">&#9998; Edit</button>`:`<span class="proj-action-btn proj-action-btn-view">&#128274; View Only</span>`}</div></div>`});h+='</div>';a.innerHTML=h}

function openCommitteeModal(commCode){const cm=loadCommitteeMembers();const members=cm[commCode]||{};const cc=COMM_COLORS[commCode]||'#666';const cn=COMM_NAMES[commCode]||commCode;const sop=COMM_SOP[commCode]||'';const commProjects=projects.filter(p=>p.committee===commCode);let memH='<div class="comm-detail-members">';const roles=[{key:'convenor',label:'BOM Convenor',bg:'#1a237e',fg:'#fff'},{key:'bomMember',label:'BOM Member',bg:'#004d40',fg:'#fff'}];roles.forEach(r=>{const name=members[r.key]||'Not Assigned';memH+=`<div class="comm-detail-member"><span class="comm-detail-role" style="background:${r.bg};color:${r.fg}">${r.label}</span><strong>${name}</strong></div>`});if(members.residents){members.residents.forEach((res,i)=>{if(res)memH+=`<div class="comm-detail-member"><span class="comm-detail-role" style="background:#e8eaf6;color:#1a237e">Resident ${i+1}</span>${res}</div>`})}memH+='</div>';let projH='';if(commProjects.length){projH='<h4 style="margin:10px 0 8px;color:'+cc+'">Projects ('+commProjects.length+')</h4>';commProjects.forEach(p=>{const sc=STATUS_COLORS[p.status]||'#666';projH+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;margin:4px 0;background:#f5f5f5;border-radius:8px;border-left:3px solid ${sc};cursor:pointer" onclick="openStatusModal('${p.id}');"><div><strong style="font-size:0.85rem">${p.name}</strong><div style="font-size:0.75rem;color:#999">${p.timeline||'TBD'} | Progress: ${p.progress}%</div></div><span class="badge" style="background:${sc};font-size:0.7rem">${p.status}</span></div>`})}else{projH='<p style="color:#999;font-size:0.85rem;margin-top:12px">No projects assigned to this committee.</p>'}document.getElementById('mTitle').innerHTML=`Committee ${commCode} &mdash; ${cn}`;document.getElementById('mBody').innerHTML=`<div style="padding:15px"><div class="comm-detail-header"><div class="comm-detail-icon" style="background:${cc}">${COMM_ICONS[commCode]||commCode}</div><div><h3 style="margin:0;color:${cc}">${cn}</h3><p style="margin:4px 0 0;font-size:0.85rem;color:#666">${sop}</p></div></div><h4 style="margin:0 0 10px;color:#333">&#128101; Members</h4>${memH}${projH}</div>`;document.getElementById('noticeModal').classList.remove('hidden')}

function openStatusModal(projId){openProjectDetail(projId)}

function openEditModal(projId){loadProjects();const p=projects.find(x=>x.id===projId);if(!p)return;ensureProjectFields(p);const sc=STATUS_COLORS[p.status]||'#666';const cc=COMM_COLORS[p.committee]||'#666';const tabs=['Status','Meetings','Documents','Expenses','Closure'];let tabBar='<div class="modal-tabs">';tabs.forEach((t,i)=>{if(t==='Closure'&&p.status==='Completed'&&!p.closureReport)return;tabBar+=`<button class="modal-tab${i===0?' active':''}" onclick="switchEditTab('${t}','${p.id}',this)">${t}</button>`});tabBar+='</div>';let panels='';/* Status tab */panels+=`<div class="modal-tab-panel active" id="etab_Status"><div class="grid-2" style="margin-bottom:15px"><div class="form-group"><label style="font-weight:700">Status</label><select class="form-control" id="ps_${p.id}"><option ${p.status==='Planned'?'selected':''}>Planned</option><option ${p.status==='In Progress'?'selected':''}>In Progress</option><option ${p.status==='Tender'?'selected':''}>Tender</option><option ${p.status==='On Hold'?'selected':''}>On Hold</option><option ${p.status==='Completed'?'selected':''}>Completed</option></select></div><div class="form-group"><label style="font-weight:700">Progress: <span id="pv_${p.id}">${p.progress}</span>%</label><input type="range" min="0" max="100" value="${p.progress}" id="pp_${p.id}" style="width:100%" oninput="document.getElementById('pv_${p.id}').textContent=this.value"></div></div><div class="form-group"><label style="font-weight:700">Add Update</label><textarea class="form-control" id="pu_${p.id}" rows="3" placeholder="Enter project update..."></textarea></div><button class="btn btn-primary" onclick="saveProjUpdate('${p.id}');document.getElementById('noticeModal').classList.add('hidden');buildProjDash()">&#128190; Save Update</button>`;if(p.updates&&p.updates.length){panels+='<h4 style="margin:15px 0 8px;color:'+cc+'">Recent Updates</h4>';p.updates.slice().reverse().slice(0,5).forEach(u=>{panels+=`<div style="border-left:3px solid ${cc};padding:8px 12px;margin:6px 0;background:#f5f5f5;border-radius:0 8px 8px 0"><div style="font-size:0.75rem;color:#999">${u.date} | ${u.by||'Committee'}</div><div style="margin-top:3px;font-size:0.85rem">${u.text}</div></div>`})}panels+='</div>';/* Meetings tab */panels+=`<div class="modal-tab-panel" id="etab_Meetings">${buildMeetingsTabContent(p)}</div>`;/* Documents tab */panels+=`<div class="modal-tab-panel" id="etab_Documents">${buildDocumentsTabContent(p)}</div>`;/* Expenses tab */panels+=`<div class="modal-tab-panel" id="etab_Expenses">${buildExpensesTabContent(p)}</div>`;/* Closure tab */panels+=`<div class="modal-tab-panel" id="etab_Closure">${buildClosureTabContent(p)}</div>`;document.getElementById('mTitle').innerHTML=`&#9998; Edit: ${p.name}`;document.getElementById('mBody').innerHTML=`<div style="padding:15px">${tabBar}${panels}</div>`;document.getElementById('noticeModal').classList.remove('hidden')}

function switchEditTab(tabName,projId,btn){document.querySelectorAll('.modal-tab-panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.modal-tab').forEach(t=>t.classList.remove('active'));const panel=document.getElementById('etab_'+tabName);if(panel)panel.classList.add('active');if(btn)btn.classList.add('active')}

function buildMeetingsTabContent(p){const cc=COMM_COLORS[p.committee]||'#666';let h=`<div class="form-group"><label style="font-weight:700">Meeting Date *</label><input type="date" class="form-control" id="pmd_${p.id}"></div><div class="grid-2"><div class="form-group"><label style="font-weight:700">Attendees</label><input type="text" class="form-control" id="pma_${p.id}" placeholder="e.g. Mr Sharma, Ms Gupta"></div><div class="form-group"><label style="font-weight:700">Summary</label><input type="text" class="form-control" id="pms_${p.id}" placeholder="Meeting summary"></div></div><button class="btn" style="background:#1a237e;color:#fff" onclick="saveProjMeeting('${p.id}');document.getElementById('noticeModal').classList.add('hidden');buildProjDash()">&#128197; Log Meeting</button>`;if(p.meetings&&p.meetings.length){h+='<h4 style="margin:15px 0 8px;color:#1a237e">Meeting History</h4><div style="max-height:250px;overflow-y:auto">';p.meetings.slice().reverse().forEach(m=>{h+=`<div style="border-left:3px solid #1a237e;padding:8px 12px;margin:6px 0;background:#e8eaf6;border-radius:0 8px 8px 0"><div style="font-size:0.75rem;color:#999">${m.date}</div><div style="font-weight:600;font-size:0.85rem">${m.attendees||''}</div><div style="margin-top:3px;font-size:0.85rem">${m.summary||''}</div></div>`});h+='</div>'}else{h+='<p style="color:#999;margin-top:12px">No meetings logged yet.</p>'}return h}

function buildDocumentsTabContent(p){const cc=COMM_COLORS[p.committee]||'#666';let h=`<div class="form-group"><label style="font-weight:700">Document Name</label><input type="text" class="form-control" id="pfn_${p.id}" placeholder="e.g. Tender Document v2"></div><div class="form-group"><label style="font-weight:700">Select File</label><input type="file" class="form-control" id="pf_${p.id}" accept=".pdf,.jpg,.png,.doc,.docx"></div><button class="btn" style="background:#004d40;color:#fff" onclick="saveProjDoc('${p.id}');document.getElementById('noticeModal').classList.add('hidden');buildProjDash()">&#128196; Upload Document</button>`;if(p.documents&&p.documents.length){h+='<h4 style="margin:15px 0 8px;color:#004d40">Uploaded Documents</h4>';p.documents.forEach(d=>{h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;margin:4px 0;background:#f5f5f5;border-radius:8px">&#128196; <a href="${d.url||'#'}" target="_blank" style="color:${cc};font-weight:600">${d.name}</a><span style="font-size:0.75rem;color:#999;margin-left:auto">${d.date||''}</span></div>`})}else{h+='<p style="color:#999;margin-top:12px">No documents uploaded yet.</p>'}return h}

function buildExpensesTabContent(p){const expTotal=p.expenses.reduce((s,e)=>s+(parseFloat(e.amount)||0),0);let h=`<div style="margin-bottom:12px;padding:10px;background:#e8f5e9;border-radius:8px;text-align:center"><strong style="font-size:1.1rem;color:#004d40">Total Expenses: &#8377;${expTotal.toLocaleString('en-IN')}</strong></div>`;if(p.expenses.length){h+=`<div style="max-height:250px;overflow-y:auto"><table style="font-size:0.8rem;width:100%"><tr><th>Date</th><th>Description</th><th>Amount</th><th>BOM</th><th>GBM</th>${isAdmin?'<th>Action</th>':''}</tr>`;p.expenses.forEach(e=>{h+=`<tr><td>${e.date||''}</td><td>${e.description}</td><td style="white-space:nowrap">Rs.${(parseFloat(e.amount)||0).toLocaleString('en-IN')}</td><td>${e.bomApproved?'<span style="color:#2e7d32;font-weight:700">&#10004;</span>':'<span style="color:#999">&#10008;</span>'}</td><td>${e.gbmApproved?'<span style="color:#2e7d32;font-weight:700">&#10004;</span>':'<span style="color:#999">&#10008;</span>'}</td>${isAdmin?`<td style="white-space:nowrap">${!e.bomApproved?`<button class="btn btn-sm" style="background:#1a237e;color:#fff;padding:2px 6px;font-size:0.65rem" onclick="approveExpense('${p.id}','${e.id}','bom');openEditModal('${p.id}');switchEditTab('Expenses','${p.id}',document.querySelectorAll('.modal-tab')[3])">BOM</button>`:''}${!e.gbmApproved?`<button class="btn btn-sm" style="background:#004d40;color:#fff;padding:2px 6px;font-size:0.65rem;margin-left:2px" onclick="approveExpense('${p.id}','${e.id}','gbm');openEditModal('${p.id}');switchEditTab('Expenses','${p.id}',document.querySelectorAll('.modal-tab')[3])">GBM</button>`:''}</td>`:''}</tr>`});h+=`</table></div>`}h+=`<h4 style="margin:15px 0 8px;color:#004d40">Add New Expense</h4><div class="grid-2"><div class="form-group"><label style="font-weight:700">Amount (Rs.) *</label><input type="number" class="form-control" id="ex_amt_${p.id}" placeholder="e.g. 15000"></div><div class="form-group"><label style="font-weight:700">Date</label><input type="date" class="form-control" id="ex_date_${p.id}"></div></div><div class="form-group"><label style="font-weight:700">Description *</label><input type="text" class="form-control" id="ex_desc_${p.id}" placeholder="e.g. Plumbing material cost"></div><button class="btn" style="background:#004d40;color:#fff" onclick="addExpense('${p.id}');document.getElementById('noticeModal').classList.add('hidden');buildProjDash()">&#128176; Add Expense</button>`;return h}

function buildClosureTabContent(p){if(p.closureReport){let h=`<div style="padding:12px;background:#e8f5e9;border-radius:8px;border-left:3px solid #2e7d32"><strong style="color:#2e7d32;font-size:1rem">&#9989; Project Closed</strong><p style="margin:8px 0;font-size:0.85rem"><strong>Summary:</strong> ${p.closureReport.summary}</p><p style="font-size:0.85rem;margin:4px 0"><strong>Final Expense:</strong> Rs. ${(parseFloat(p.closureReport.finalExpense)||0).toLocaleString('en-IN')}</p><p style="font-size:0.85rem;margin:4px 0"><strong>Outcomes:</strong> ${p.closureReport.outcomes||'N/A'}</p><p style="font-size:0.75rem;color:#666;margin-top:8px">Closed: ${p.closureReport.closedDate} by ${p.closureReport.closedBy}</p><div style="display:flex;gap:8px;margin-top:8px">${p.closureReport.bomApproved?'<span class="badge" style="background:#2e7d32">BOM Approved</span>':'<span class="badge" style="background:#999">BOM Pending</span>'} ${p.closureReport.gbmApproved?'<span class="badge" style="background:#2e7d32">GBM Approved</span>':'<span class="badge" style="background:#999">GBM Pending</span>'}</div>`;if(isAdmin&&(!p.closureReport.bomApproved||!p.closureReport.gbmApproved)){h+=`<div style="margin-top:10px">${!p.closureReport.bomApproved?`<button class="btn btn-sm" style="background:#1a237e;color:#fff" onclick="approveClosure('${p.id}','bom');openEditModal('${p.id}');switchEditTab('Closure','${p.id}',document.querySelectorAll('.modal-tab')[4])">Approve (BOM)</button>`:''} ${!p.closureReport.gbmApproved?`<button class="btn btn-sm" style="background:#004d40;color:#fff;margin-left:4px" onclick="approveClosure('${p.id}','gbm');openEditModal('${p.id}');switchEditTab('Closure','${p.id}',document.querySelectorAll('.modal-tab')[4])">Approve (GBM)</button>`:''}</div>`}h+='</div>';return h}if(p.status==='Completed')return '<p style="color:#999">Project completed. No closure report filed.</p>';return `<div style="padding:15px;background:#fff3e0;border-radius:8px;border-left:3px solid #e65100;margin-bottom:12px"><p style="margin:0;color:#e65100;font-weight:600">&#9888; Closing a project is permanent. Please review all details before submitting.</p></div><div class="form-group"><label style="font-weight:700">Closure Summary *</label><textarea class="form-control" id="cl_sum_${p.id}" rows="3" placeholder="Describe what was accomplished, key outcomes..."></textarea></div><div class="grid-2"><div class="form-group"><label style="font-weight:700">Final Expense (Rs.)</label><input type="number" class="form-control" id="cl_exp_${p.id}" placeholder="Total final expense"></div><div class="form-group"><label style="font-weight:700">Key Outcomes</label><input type="text" class="form-control" id="cl_out_${p.id}" placeholder="e.g. Waterproofing completed, 5-year warranty"></div></div><button class="btn btn-danger" onclick="closeProject('${p.id}');document.getElementById('noticeModal').classList.add('hidden');buildProjDash()">&#9888; Submit Closure Report</button>`}
/* New Project Creation */
function createNewProject(){const name=document.getElementById('np_name').value.trim();const comm=document.getElementById('np_comm').value;if(!name){alert('Enter project name');return}const p={id:'P'+(projects.length+1)+'_'+Date.now(),name:name,committee:comm,status:'Planned',timeline:document.getElementById('np_timeline').value.trim()||'TBD',budget:document.getElementById('np_budget').value.trim()||'TBD',progress:0,description:document.getElementById('np_desc').value.trim(),updates:[],documents:[],meetings:[],expenses:[],closureReport:null};projects.push(p);saveProjects();buildProjDash();alert('Project "'+name+'" created under Committee '+comm+'!')}
/* Expense Tracking */
function addExpense(id){const p=projects.find(x=>x.id===id);if(!p)return;const amt=document.getElementById('ex_amt_'+id).value;const desc=document.getElementById('ex_desc_'+id).value.trim();const dt=document.getElementById('ex_date_'+id).value;if(!amt||!desc){alert('Enter amount and description');return}ensureProjectFields(p);p.expenses.push({id:'EXP_'+Date.now(),amount:parseFloat(amt),description:desc,date:dt||new Date().toISOString().split('T')[0],addedBy:currentUser?currentUser.email:'BOM',bomApproved:false,gbmApproved:false});saveProjects();buildProjDash();alert('Expense added!')}
function approveExpense(projId,expId,type){const p=projects.find(x=>x.id===projId);if(!p||!isAdmin)return;const e=p.expenses.find(x=>x.id===expId);if(!e)return;if(type==='bom')e.bomApproved=true;if(type==='gbm')e.gbmApproved=true;saveProjects();buildProjDash()}
/* Closure Reports */
function closeProject(id){const p=projects.find(x=>x.id===id);if(!p)return;const sum=document.getElementById('cl_sum_'+id).value.trim();if(!sum){alert('Enter closure summary');return}p.closureReport={summary:sum,finalExpense:document.getElementById('cl_exp_'+id).value||0,outcomes:document.getElementById('cl_out_'+id).value.trim(),closedDate:new Date().toISOString().split('T')[0],closedBy:currentUser?currentUser.email:'BOM',bomApproved:false,gbmApproved:false};p.status='Completed';p.progress=100;saveProjects();buildProjDash();alert('Project closed! Awaiting BOM/GBM approval.')}
function approveClosure(projId,type){const p=projects.find(x=>x.id===projId);if(!p||!isAdmin||!p.closureReport)return;if(type==='bom')p.closureReport.bomApproved=true;if(type==='gbm')p.closureReport.gbmApproved=true;saveProjects();buildProjDash()}

function saveProjUpdate(id){const p=projects.find(x=>x.id===id);if(!p)return;const status=document.getElementById('ps_'+id).value;const progress=parseInt(document.getElementById('pp_'+id).value);const text=document.getElementById('pu_'+id).value.trim();p.status=status;p.progress=progress;if(text){if(!p.updates)p.updates=[];p.updates.push({text:text,date:new Date().toLocaleDateString(),by:currentUser?currentUser.email:'BOM'});document.getElementById('pu_'+id).value=''}saveProjects();buildProjDash();alert('Project updated!')}

function saveProjMeeting(id){const p=projects.find(x=>x.id===id);if(!p)return;const dt=document.getElementById('pmd_'+id).value;const att=document.getElementById('pma_'+id).value.trim();const sum=document.getElementById('pms_'+id).value.trim();if(!dt){alert('Select meeting date');return}if(!p.meetings)p.meetings=[];p.meetings.push({date:dt,attendees:att,summary:sum});document.getElementById('pmd_'+id).value='';document.getElementById('pma_'+id).value='';document.getElementById('pms_'+id).value='';saveProjects();buildProjDash();alert('Meeting logged!')}

function saveProjDoc(id){const p=projects.find(x=>x.id===id);if(!p)return;const fl=document.getElementById('pf_'+id).files[0];const nm=document.getElementById('pfn_'+id).value.trim()||'Document';if(!fl){alert('Select a file');return}if(!p.documents)p.documents=[];const r=new FileReader();r.onload=e=>{p.documents.push({name:nm,url:e.target.result,date:new Date().toLocaleDateString(),type:fl.type});document.getElementById('pf_'+id).value='';document.getElementById('pfn_'+id).value='';saveProjects();buildProjDash();alert('Document uploaded!')};r.readAsDataURL(fl)}

// ===== AI MONITOR =====
function runAIMonitor(){loadProjects();const insights=[];const escalations=[];const now=Date.now();const DAY=86400000;projects.forEach(p=>{const lastUpd=p.updates&&p.updates.length?new Date(p.updates[p.updates.length-1].date).getTime():0;const lastMtg=p.meetings&&p.meetings.length?new Date(p.meetings[p.meetings.length-1].date).getTime():0;const daysSinceUpd=lastUpd?Math.floor((now-lastUpd)/DAY):999;const daysSinceMtg=lastMtg?Math.floor((now-lastMtg)/DAY):999;const cn=COMM_NAMES[p.committee]||p.committee;if(p.status==='Completed')return;if(daysSinceUpd>=14){escalations.push({project:p.name,committee:cn,commId:p.committee,type:'No Updates',msg:`No updates for ${daysSinceUpd} days`,severity:'red'});insights.push(`🔴 <strong>${p.name}</strong> (${cn}): No update for ${daysSinceUpd} days — ESCALATED`)}else if(daysSinceUpd>=7){insights.push(`🟡 <strong>${p.name}</strong> (${cn}): Last update ${daysSinceUpd} days ago — needs attention`)}else if(lastUpd){insights.push(`🟢 <strong>${p.name}</strong> (${cn}): Updated ${daysSinceUpd} day(s) ago — on track`)}else{escalations.push({project:p.name,committee:cn,commId:p.committee,type:'Never Updated',msg:'Project has never been updated',severity:'red'});insights.push(`🔴 <strong>${p.name}</strong> (${cn}): Never updated — ESCALATED`)}if(daysSinceMtg>=21){escalations.push({project:p.name,committee:cn,commId:p.committee,type:'No Meetings',msg:`No meeting for ${daysSinceMtg} days`,severity:'red'});insights.push(`🔴 <strong>${p.name}</strong>: No meeting for ${daysSinceMtg}+ days — ESCALATED`)}else if(daysSinceMtg>=14){insights.push(`🟡 <strong>${p.name}</strong>: Last meeting ${daysSinceMtg} days ago`)}});const area=document.getElementById('aiInsightsArea');if(!area)return;const totalP=projects.filter(x=>x.status!=='Completed').length;const greenC=insights.filter(x=>x.startsWith('🟢')).length;const yellowC=insights.filter(x=>x.startsWith('🟡')).length;const redC=insights.filter(x=>x.startsWith('🔴')).length;const score=totalP?Math.round((greenC/totalP)*100):0;const scoreColor=score>=70?'#2e7d32':score>=40?'#e65100':'#b71c1c';let h=`<div class="card" style="border-left:4px solid #1a237e;margin-top:20px"><h3 style="color:#1a237e">🤖 AI Project Monitor</h3><div class="grid-3" style="margin:15px 0"><div style="text-align:center;padding:15px;background:#e8f5e9;border-radius:10px"><div style="font-size:2rem;font-weight:700;color:${scoreColor}">${score}%</div><div style="font-size:0.8rem;color:#666">Health Score</div></div><div style="text-align:center;padding:15px;background:#fff3e0;border-radius:10px"><div style="font-size:2rem;font-weight:700;color:#e65100">${escalations.length}</div><div style="font-size:0.8rem;color:#666">Escalations</div></div><div style="text-align:center;padding:15px;background:#e3f2fd;border-radius:10px"><div style="font-size:2rem;font-weight:700;color:#1565c0">${totalP}</div><div style="font-size:0.8rem;color:#666">Active Projects</div></div></div>`;const commHealth={};['A','B','C','D','E','F','G'].forEach(c=>{commHealth[c]={green:0,yellow:0,red:0,total:0}});insights.forEach(ins=>{const m=ins.match(/\(([^)]+)\)/);if(!m)return;const cn=m[1];const ck=Object.keys(COMM_NAMES).find(k=>COMM_NAMES[k]===cn);if(!ck)return;if(ins.startsWith('🟢'))commHealth[ck].green++;else if(ins.startsWith('🟡'))commHealth[ck].yellow++;else commHealth[ck].red++;commHealth[ck].total++});h+='<h4 style="margin:15px 0 10px">Committee Health</h4><div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px">';['A','B','C','D','E','F','G'].forEach(c=>{const ch=commHealth[c];if(!ch.total)return;const col=ch.red>0?'#b71c1c':ch.yellow>0?'#e65100':'#2e7d32';const emoji=ch.red>0?'🔴':ch.yellow>0?'🟡':'🟢';h+=`<div style="padding:10px 15px;background:#f5f5f5;border-radius:8px;border-left:4px solid ${COMM_COLORS[c]}"><strong>${emoji} ${COMM_NAMES[c]}</strong><div style="font-size:0.75rem;color:${col}">G:${ch.green} Y:${ch.yellow} R:${ch.red}</div></div>`});h+='</div><h4 style="margin:15px 0 10px">AI Insights</h4><div style="max-height:300px;overflow-y:auto">';insights.forEach(ins=>{h+=`<div style="padding:6px 10px;margin:4px 0;background:#fafafa;border-radius:6px;font-size:0.85rem">${ins}</div>`});h+='</div></div>';area.innerHTML=h;if(escalations.length>0)createEscalationNotices(escalations)}

function createEscalationNotices(escalations){const existing=JSON.parse(localStorage.getItem('st_notices')||'[]');const today=new Date().toISOString().split('T')[0];const todayEsc=existing.filter(n=>n.category==='Escalation'&&n.date===today);if(todayEsc.length>=escalations.length)return;escalations.forEach(e=>{const dup=existing.find(n=>n.category==='Escalation'&&n.date===today&&n.title.includes(e.project));if(dup)return;existing.unshift({title:'⚠ AI Alert: Committee '+e.commId+' ('+e.committee+') - '+e.type,summary:e.project+': '+e.msg+'. Immediate attention required by BOM.',category:'Escalation',date:today,fileUrl:'',fileType:'',auto:true})});localStorage.setItem('st_notices',JSON.stringify(existing));supaSync('st_notices');updateEscBadge()}

function updateEscBadge(){const notices=JSON.parse(localStorage.getItem('st_notices')||'[]');const esc=notices.filter(n=>n.category==='Escalation');const badge=document.getElementById('escalationBadge');if(badge){if(esc.length>0&&isBOMLoggedIn()){badge.textContent=esc.length;badge.style.display='inline'}else{badge.style.display='none'}}}

// ===== ADMIN SETTINGS =====
async function changeAdminPass(){const cur=document.getElementById('curPass').value,np=document.getElementById('newPass').value,cf=document.getElementById('cfmPass').value,err=document.getElementById('passErr'),suc=document.getElementById('passSuc');err.style.display='none';suc.style.display='none';if(!cur||!np||!cf){err.textContent='All fields are required';err.style.display='block';return}if(np.length<6){err.textContent='New password must be at least 6 characters';err.style.display='block';return}if(np!==cf){err.textContent='New password and confirmation do not match';err.style.display='block';return}
// Supabase Auth password change
const result=await SunAuth.changePassword(np);
if(result.error){err.textContent=result.error.message;err.style.display='block'}
else{suc.textContent='Password changed successfully!';suc.style.display='block';document.getElementById('curPass').value='';document.getElementById('newPass').value='';document.getElementById('cfmPass').value=''}}
function loadAdminProfile(){const p=JSON.parse(localStorage.getItem('st_admin_profile')||'{}');if(db){db.collection('settings').doc('admin_profile').get().then(d=>{if(d.exists){const data=d.data();document.getElementById('adminEmailField').value=data.email||'';document.getElementById('adminMobile').value=data.mobile||'';document.getElementById('adminDispName').value=data.displayName||''}else fillFromLS()}).catch(()=>fillFromLS())}else fillFromLS();function fillFromLS(){document.getElementById('adminEmailField').value=p.email||ADMIN_EMAIL;document.getElementById('adminMobile').value=p.mobile||'';document.getElementById('adminDispName').value=p.displayName||''}}
function saveAdminProfile(){const email=document.getElementById('adminEmailField').value.trim(),mobile=document.getElementById('adminMobile').value.trim(),name=document.getElementById('adminDispName').value.trim(),err=document.getElementById('profErr'),suc=document.getElementById('profSuc');err.style.display='none';suc.style.display='none';if(!email){err.textContent='Email is required';err.style.display='block';return}const data={email:email,mobile:mobile,displayName:name,updatedAt:new Date().toISOString()};if(db){db.collection('settings').doc('admin_profile').set(data,{merge:true}).then(()=>{localStorage.setItem('st_admin_profile',JSON.stringify(data));supaSync('st_admin_profile');suc.textContent='Profile saved!';suc.style.display='block'}).catch(e=>{localStorage.setItem('st_admin_profile',JSON.stringify(data));supaSync('st_admin_profile');suc.textContent='Saved locally (DB unavailable)';suc.style.display='block'})}else{localStorage.setItem('st_admin_profile',JSON.stringify(data));supaSync('st_admin_profile');suc.textContent='Profile saved!';suc.style.display='block'}}

// ===== INIT =====
loadMemLS();
try{document.getElementById('nDate').value=new Date().toISOString().split('T')[0]}catch(e){}
loadProjects();updateEscBadge();
// Supabase: hydrate localStorage from cloud (legacy data), then refresh UI
supaHydrate().then(function(){loadMemLS();updateEscBadge();loadProjects()}).catch(function(){});
// Session restore handled by SunAuth.init() → onAuthStateChange
// No more localStorage password checks or hardcoded admin123
// Supabase Auth persists sessions via JWT + refresh tokens automatically
console.log('Sun Tower RWA initialized (Supabase Auth + RLS mode)');

// Default landing: Resident Portal (suntower.in is for residents)
// BOM members access via Login button or BOM Internal tab
setTimeout(function(){
  // Only auto-enter if still on splash screen (not already navigated)
  var splash=document.getElementById('splashScreen');
  if(splash&&splash.style.display!=='none'&&!splash.classList.contains('hidden')){
    hideSplash();
    switchTab('resident');
    // Don't show login overlay by default — let residents browse the portal
    // They'll click Login when ready
  }
},300);
</script>
</body>
</html>
